// <!--GAMFC--> version base on commit 00a515179f843bac5ed036b11de50796e1ca6c7b, time is 2025-10-17 20:36:59 UTC<!--We are all REvil-->
// @ts-ignore

import{connect}from'cloudflare:sockets';const RATE_LIMIT_CONFIG={'WINDOW_SECONDS':0x258,'MAX_REQUESTS':0x5},CONST={'WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2};function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=new Date(a+'T'+b+'Z');return c<=new Date();}async function getUserData(a,b){if(!isValidUUID(b))return null;const c='user:'+b;try{const f=await a['USER_KV']['get'](c,'json');if(f&&f['uuid'])return f;}catch(g){console['error']('Failed\x20to\x20parse\x20cached\x20user\x20data\x20for\x20'+b,g);}const d=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!d)return null;return await a['USER_KV']['put'](c,JSON['stringify'](d),{'expirationTtl':0xe10}),d;}async function getIPInfo(a){if(!a)return null;try{const b=await fetch('https://ipapi.co/'+a+'/json/');if(!b['ok'])throw new Error('ipapi.co\x20failed\x20with\x20status\x20'+b['status']);const c=await b['json']();if(c['error'])return null;return{'ip':c['ip'],'country':c['country_name']||'Unknown','city':c['city']||'Unknown','isp':c['org']||'Unknown'};}catch(d){return console['error']('Error\x20fetching\x20IP\x20info\x20for\x20'+a+':',d),null;}}async function getProxyIPInfo(a){const b='proxy_ip_info';let c=await a['USER_KV']['get'](b,'json');if(c)return c;try{const d=await fetch('https://api.ipify.org?format=json'),{ip:f}=await d['json'](),g=await getIPInfo(f);if(g)return await a['USER_KV']['put'](b,JSON['stringify'](g),{'expirationTtl':0xe10}),g;}catch(h){console['error']('Failed\x20to\x20determine\x20proxy\x20IP\x20info:',h);}return null;}function getAdminLoginHTML(a){return'<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22><title>Admin\x20Login</title><style>body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background-color:#111827;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,Helvetica,Arial,sans-serif}.login-container{background-color:#1F2937;padding:40px;border-radius:12px;box-shadow:0\x204px\x2020px\x20rgba(0,0,0,.5);text-align:center;width:320px;border:1px\x20solid\x20#374151}h1{color:#F9FAFB;margin-bottom:24px;font-weight:500}form{display:flex;flex-direction:column}input[type=password]{background-color:#374151;border:1px\x20solid\x20#4B5563;color:#F9FAFB;padding:12px;border-radius:8px;margin-bottom:20px;font-size:16px;transition:border-color\x20.2s,box-shadow\x20.2s}input[type=password]:focus{outline:none;border-color:#3B82F6;box-shadow:0\x200\x200\x203px\x20rgba(59,130,246,.3)}button{background-color:#3B82F6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color\x20.2s}button:hover{background-color:#2563EB}.error{color:#EF4444;margin-top:15px;font-size:14px}</style></head><body><div\x20class=\x22login-container\x22><h1>Admin\x20Login</h1><form\x20method=\x22POST\x22\x20action=\x22/'+a+'\x22><input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22••••••••••••••\x22\x20required><button\x20type=\x22submit\x22>Login</button></form></div></body></html>';}function getAdminPanelHTML(a){return'<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22><title>Admin\x20Dashboard</title><style>:root{--bg-main:#0c0a09;--bg-card:#1c1917;--bg-input:#292524;--border:#44403c;--text-primary:#f5f5f4;--text-secondary:#a8a29e;--accent:#fb923c;--accent-hover:#f97316;--danger:#ef4444;--danger-hover:#dc2626;--success:#4ade80;--expired:#facc15;--btn-secondary-bg:#57534e;--btn-secondary-hover:#78716c}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,sans-serif;background-color:var(--bg-main);color:var(--text-primary);font-size:14px}.container{max-width:1280px;margin:30px\x20auto;padding:0\x2020px}.card{background-color:var(--bg-card);border-radius:12px;padding:24px;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x2012px\x20rgba(0,0,0,.3)}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}.stat-card{background-color:var(--bg-card);border-radius:12px;padding:20px;border:1px\x20solid\x20var(--border);transition:transform\x20.2s,box-shadow\x20.2s}.stat-card:hover{transform:translateY(-5px);box-shadow:0\x208px\x2016px\x20rgba(0,0,0,.4)}.stat-title{font-size:14px;color:var(--text-secondary);margin:0\x200\x2010px}.stat-value{font-size:28px;font-weight:600;margin:0}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;align-items:flex-end}.form-group{display:flex;flex-direction:column}label{margin-bottom:8px;font-weight:500;color:var(--text-secondary)}.input-group{display:flex}input,select{width:100%;box-sizing:border-box;background-color:var(--bg-input);border:1px\x20solid\x20var(--border);color:var(--text-primary);padding:10px;border-radius:6px;font-size:14px;transition:border-color\x20.2s,box-shadow\x20.2s}input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0\x200\x200\x203px\x20rgba(251,146,60,.3)}.btn{padding:10px\x2016px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all\x20.2s;display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn:active{transform:scale(.97)}.btn-primary{background-color:var(--accent);color:var(--bg-main)}.btn-primary:hover{background-color:var(--accent-hover)}.btn-danger{background-color:var(--danger);color:#fff}.btn-danger:hover{background-color:var(--danger-hover)}.btn-secondary{background-color:var(--btn-secondary-bg);color:#fff}.btn-secondary:hover{background-color:var(--btn-secondary-hover)}.input-group\x20button{border-top-left-radius:0;border-bottom-left-radius:0}.input-group\x20input,.input-group\x20select{border-radius:0;border-right:none}.input-group\x20input:first-child{border-top-left-radius:6px;border-bottom-left-radius:6px}.input-group\x20button:last-child{border-top-right-radius:6px;border-bottom-right-radius:6px;border-right:1px\x20solid\x20var(--border)}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:12px\x2016px;text-align:left;border-bottom:1px\x20solid\x20var(--border);white-space:nowrap}th{color:var(--text-secondary);font-weight:600;font-size:12px;text-transform:uppercase}.status-badge{padding:4px\x2010px;border-radius:12px;font-size:12px;font-weight:600;display:inline-block}.status-active{background-color:rgba(74,222,128,.2);color:var(--success)}.status-expired{background-color:rgba(250,204,21,.2);color:var(--expired)}.actions-cell{display:flex;gap:8px;justify-content:flex-start}#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background-color:var(--bg-card);color:#fff;padding:15px\x2025px;border-radius:8px;z-index:1001;display:none;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x2012px\x20rgba(0,0,0,.3);opacity:0;transition:all\x20.3s}#toast.show{display:block;opacity:1;transform:translate(-50%,-10px)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:1000;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity\x20.3s,visibility\x20.3s}.modal-overlay.show{opacity:1;visibility:visible}.modal-content{background-color:var(--bg-card);padding:30px;border-radius:12px;width:90%;max-width:550px;transform:scale(.9);transition:transform\x20.3s;border:1px\x20solid\x20var(--border)}.modal-overlay.show\x20.modal-content{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:15px;margin-bottom:20px;border-bottom:1px\x20solid\x20var(--border)}.modal-header\x20h2{margin:0;font-size:20px}.modal-close-btn{background:0\x200;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer}.modal-footer{display:flex;justify-content:flex-end;gap:12px;margin-top:25px}.traffic-bar{width:100%;background-color:var(--bg-input);border-radius:4px;height:6px;overflow:hidden;margin-top:4px}.traffic-bar-inner{height:100%;background-color:var(--accent);border-radius:4px;transition:width\x20.5s}.form-check{display:flex;align-items:center;margin-top:10px}.form-check\x20input{width:auto;margin-right:8px}.pagination{display:flex;justify-content:center;align-items:center;margin-top:20px;gap:6px}.pagination\x20button{background-color:var(--bg-input);color:var(--text-primary);border:1px\x20solid\x20var(--border);border-radius:6px;padding:8px\x2014px;cursor:pointer;transition:background-color\x20.2s}.pagination\x20button:hover:not(:disabled){background-color:var(--btn-secondary-bg)}.pagination\x20button:disabled{opacity:.5;cursor:not-allowed}.pagination\x20span{padding:0\x208px;font-weight:600}@media\x20(max-width:768px){.container{padding:0\x2010px;margin-top:15px}.stats-grid{grid-template-columns:1fr\x201fr}.user-list-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}table{min-width:800px}}</style></head><body><div\x20class=\x22container\x22><div\x20id=\x22stats\x22\x20class=\x22stats-grid\x22></div><div\x20class=\x22card\x22><h2>Create\x20User</h2><form\x20id=\x22createUserForm\x22\x20class=\x22form-grid\x22><input\x20type=\x22hidden\x22\x20id=\x22csrf_token\x22\x20name=\x22csrf_token\x22><div\x20class=\x22form-group\x22\x20style=\x22grid-column:1/-1\x22><label\x20for=\x22uuid\x22>UUID</label><div\x20class=\x22input-group\x22><input\x20type=\x22text\x22\x20id=\x22uuid\x22\x20required><button\x20type=\x22button\x22\x20id=\x22generateUUID\x22\x20class=\x22btn\x20btn-secondary\x22>Generate</button></div></div><div\x20class=\x22form-group\x22><label\x20for=\x22expiryDate\x22>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22expiryDate\x22\x20required></div><div\x20class=\x22form-group\x22><label\x20for=\x22expiryTime\x22>Expiry\x20Time\x20(Your\x20Local\x20Time)</label><input\x20type=\x22time\x22\x20id=\x22expiryTime\x22\x20step=\x221\x22\x20required></div><div\x20class=\x22form-group\x22><label\x20for=\x22dataLimit\x22>Data\x20Limit</label><div\x20class=\x22input-group\x22><input\x20type=\x22number\x22\x20id=\x22dataLimitValue\x22\x20placeholder=\x22e.g.,\x2010\x22><select\x20id=\x22dataLimitUnit\x22><option\x20value=\x22GB\x22>GB</option><option\x20value=\x22MB\x22>MB</option></select><button\x20type=\x22button\x22\x20id=\x22unlimitedBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Unlimited</button></div></div><div\x20class=\x22form-group\x22><label\x20for=\x22notes\x22>Notes</label><input\x20type=\x22text\x22\x20id=\x22notes\x22\x20placeholder=\x22(Optional)\x22></div><div\x20class=\x22form-group\x22\x20style=\x22grid-column:1/-1;align-items:flex-start;margin-top:10px\x22><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Create\x20User</button></div></form></div><div\x20class=\x22card\x22\x20style=\x22margin-top:30px\x22><h2>User\x20List</h2><div\x20class=\x22user-list-wrapper\x22><table><thead><tr><th>UUID</th><th>Created</th><th>Expiry</th><th>Status</th><th>Traffic</th><th>Notes</th><th>Actions</th></tr></thead><tbody\x20id=\x22userList\x22></tbody></table></div><div\x20id=\x22pagination-controls\x22\x20class=\x22pagination\x22></div></div></div><div\x20id=\x22toast\x22></div><div\x20id=\x22editModal\x22\x20class=\x22modal-overlay\x22><div\x20class=\x22modal-content\x22><div\x20class=\x22modal-header\x22><h2>Edit\x20User</h2><button\x20id=\x22modalCloseBtn\x22\x20class=\x22modal-close-btn\x22>&times;</button></div><form\x20id=\x22editUserForm\x22\x20class=\x22form-grid\x22><input\x20type=\x22hidden\x22\x20id=\x22editUuid\x22\x20name=\x22uuid\x22><div\x20class=\x22form-group\x22><label\x20for=\x22editExpiryDate\x22>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22editExpiryDate\x22\x20name=\x22exp_date\x22\x20required></div><div\x20class=\x22form-group\x22><label\x20for=\x22editExpiryTime\x22>Expiry\x20Time\x20(Your\x20Local\x20Time)</label><input\x20type=\x22time\x22\x20id=\x22editExpiryTime\x22\x20name=\x22exp_time\x22\x20step=\x221\x22\x20required></div><div\x20class=\x22form-group\x22><label\x20for=\x22editDataLimit\x22>Data\x20Limit</label><div\x20class=\x22input-group\x22><input\x20type=\x22number\x22\x20id=\x22editDataLimitValue\x22\x20placeholder=\x22e.g.,\x2010\x22><select\x20id=\x22editDataLimitUnit\x22><option\x20value=\x22GB\x22>GB</option><option\x20value=\x22MB\x22>MB</option></select><button\x20type=\x22button\x22\x20id=\x22editUnlimitedBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Unlimited</button></div></div><div\x20class=\x22form-group\x22><label\x20for=\x22editNotes\x22>Notes</label><input\x20type=\x22text\x22\x20id=\x22editNotes\x22\x20name=\x22notes\x22\x20placeholder=\x22(Optional)\x22></div><div\x20class=\x22form-group\x20form-check\x22\x20style=\x22grid-column:1/-1\x22><input\x20type=\x22checkbox\x22\x20id=\x22resetTraffic\x22><label\x20for=\x22resetTraffic\x22>Reset\x20Traffic\x20Usage</label></div><div\x20class=\x22modal-footer\x22\x20style=\x22grid-column:1/-1\x22><button\x20type=\x22button\x22\x20id=\x22modalCancelBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Cancel</button><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Save\x20Changes</button></div></form></div></div><script>document.addEventListener(\x22DOMContentLoaded\x22,()=>{const\x20adminPath=\x27'+a+'\x27;const\x20e=`/${adminPath}/api`,t=document.getElementById(\x22csrf_token\x22).value,n={get:t=>fetch(`${e}${t}`).then(o),post:(n,s)=>fetch(`${e}${n}`,{method:\x22POST\x22,headers:{...a},body:JSON.stringify(s)}).then(o),put:(n,s)=>fetch(`${e}${n}`,{method:\x22PUT\x22,headers:{...a},body:JSON.stringify(s)}).then(o),delete:t=>fetch(`${e}${t}`,{method:\x22DELETE\x22,headers:{...a}}).then(o)},a={\x22Content-Type\x22:\x22application/json\x22,\x22X-CSRF-Token\x22:t};let\x20s;async\x20function\x20o(e){if(403===e.status)throw\x20i(\x22Session\x20expired\x20or\x20invalid.\x20Please\x20refresh\x20the\x20page.\x22,!0),new\x20Error(\x22Forbidden:\x20Invalid\x20session\x20or\x20CSRF\x20token.\x22);if(!e.ok){const\x20t=await\x20e.json().catch(()=>({error:\x22An\x20unknown\x20error\x20occurred.\x22}));throw\x20new\x20Error(t.error||`Request\x20failed\x20with\x20status\x20${e.status}`)}return\x20204===e.status?null:e.json()}function\x20i(e,t=!1){const\x20n=document.getElementById(\x22toast\x22);n.textContent=e,n.style.backgroundColor=t?\x22var(--danger)\x22:\x22var(--success)\x22,n.classList.add(\x22show\x22),setTimeout(()=>{n.classList.remove(\x22show\x22)},3e3)}const\x20r=e=>e.toString().padStart(2,\x220\x22),d=(e,t)=>{if(!e||!t)return{utcDate:\x22\x22,utcTime:\x22\x22};const\x20n=new\x20Date(`${e}T${t}`);return{utcDate:`${n.getUTCFullYear()}-${r(n.getUTCMonth()+1)}-${r(n.getUTCDate())}`,utcTime:`${r(n.getUTCHours())}:${r(n.getUTCMinutes())}:${r(n.getUTCSeconds())}`}},l=(e,t)=>{if(!e||!t)return{localDate:\x22\x22,localTime:\x22\x22};const\x20n=new\x20Date(`${e}T${t}Z`);return{localDate:`${n.getFullYear()}-${r(n.getMonth()+1)}-${r(n.getDate())}`,localTime:`${r(n.getHours())}:${r(n.getMinutes())}:${r(n.getSeconds())}`}};function\x20c(e){if(0===e)return\x220\x20Bytes\x22;const\x20t=Math.floor(Math.log(e)/Math.log(1024));return`${parseFloat((e/Math.pow(1024,t)).toFixed(2))}\x20${[\x22Bytes\x22,\x22KB\x22,\x22MB\x22,\x22GB\x22,\x22TB\x22][t]}`}function\x20u(e){document.getElementById(\x22stats\x22).innerHTML=`<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Total\x20Users</h3><p\x20class=\x22stat-value\x22>${e.totalUsers}</p></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Active\x20Users</h3><p\x20class=\x22stat-value\x22>${e.activeUsers}</p></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Expired\x20Users</h3><p\x20class=\x22stat-value\x22>${e.expiredUsers}</p></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Total\x20Traffic\x20Used</h3><p\x20class=\x22stat-value\x22>${c(e.totalTraffic)}</p></div>`}async\x20function\x20p(e=1){try{const{users:t,totalPages:a,currentPage:o}=await\x20n.get(`/users?page=${e}&limit=20`);s=t,g(t),function(e,t){const\x20s=document.getElementById(\x22pagination-controls\x22);if(e<=1)return\x20void(s.innerHTML=\x22\x22);let\x20a=`<button\x20id=\x22prevPage\x22\x20${1===t?\x22disabled\x22:\x22\x22}\x20data-page=\x22${t-1}\x22>&#171;\x20Prev</button>\x20<span>Page\x20${t}\x20of\x20${e}</span>\x20<button\x20id=\x22nextPage\x22\x20${t>=e?\x22disabled\x22:\x22\x22}\x20data-page=\x22${t+1}\x22>Next\x20&#187;</button>`;s.innerHTML=a}(a,o)}catch(e){i(e.message,!0)}}function\x20g(e){document.getElementById(\x22userList\x22).innerHTML=0===e.length?\x27<tr><td\x20colspan=\x227\x22\x20style=\x22text-align:center;\x22>No\x20users\x20found.</td></tr>\x27:e.map(e=>{const\x20t=new\x20Date(`${e.expiration_date}T${e.expiration_time}Z`),n=t<new\x20Date,a=e.data_limit>0?`${c(e.data_usage)}\x20/\x20${c(e.data_limit)}`:`${c(e.data_usage)}\x20/\x20&infin;`,s=e.data_limit>0?Math.min(100,e.data_usage/e.data_limit*100):0;return`\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<tr\x20data-uuid=\x22${e.uuid}\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20title=\x22${e.uuid}\x22>${e.uuid.substring(0,8)}...</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>${new\x20Date(e.created_at).toLocaleString()}</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>${t.toLocaleString()}</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td><span\x20class=\x22status-badge\x20${n?\x22status-expired\x22:\x22status-active\x22}\x22>${n?\x22Expired\x22:\x22Active\x22}</span></td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20${a}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22traffic-bar\x22><div\x20class=\x22traffic-bar-inner\x22\x20style=\x22width:\x20${s}%;\x22></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td>${e.notes||\x22-\x22}</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<td\x20class=\x22actions-cell\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20btn-secondary\x20btn-edit\x22>Edit</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22btn\x20btn-danger\x20btn-delete\x22>Delete</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</td>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</tr>`}).join(\x22\x22)}async\x20function\x20h(){try{const\x20e=await\x20n.get(\x22/stats\x22);u(e)}catch(e){i(e.message,!0)}}async\x20function\x20m(){await\x20Promise.all([h(),p()])}const\x20y=(e,t)=>{const\x20n=parseFloat(document.getElementById(e).value),a=document.getElementById(t).value;if(isNaN(n)||n<=0)return\x200;const\x20s=\x22GB\x22===a?1073741824:1048576;return\x20Math.round(n*s)},f=(e,t,n)=>{const\x20a=document.getElementById(t),s=document.getElementById(n);if(e<=0)return\x20a.value=\x22\x22,void(s.value=\x22GB\x22);const\x20o=e>=1073741824,i=o?\x22GB\x22:\x22MB\x22,r=o?1073741824:1048576;a.value=parseFloat((e/r).toFixed(2)),s.value=i};document.getElementById(\x22createUserForm\x22).addEventListener(\x22submit\x22,async\x20e=>{e.preventDefault();const\x20t=d(document.getElementById(\x22expiryDate\x22).value,document.getElementById(\x22expiryTime\x22).value),a={uuid:document.getElementById(\x22uuid\x22).value,exp_date:t.utcDate,exp_time:t.utcTime,data_limit:y(\x22dataLimitValue\x22,\x22dataLimitUnit\x22),notes:document.getElementById(\x22notes\x22).value};try{await\x20n.post(\x22/users\x22,a),i(\x22User\x20created\x20successfully!\x22),e.target.reset(),document.getElementById(\x22uuid\x22).value=crypto.randomUUID(),b(),m()}catch(e){i(e.message,!0)}});const\x20v=document.getElementById(\x22editModal\x22);document.getElementById(\x22userList\x22).addEventListener(\x22click\x22,e=>{const\x20t=e.target.closest(\x22button\x22);if(!t)return;const\x20a=e.target.closest(\x22tr\x22).dataset.uuid;if(t.classList.contains(\x22btn-edit\x22)){const\x20e=s.find(e=>e.uuid===a);if(!e)return;const{localDate:t,localTime:n}=l(e.expiration_date,e.expiration_time);document.getElementById(\x22editUuid\x22).value=e.uuid,document.getElementById(\x22editExpiryDate\x22).value=t,document.getElementById(\x22editExpiryTime\x22).value=n,f(e.data_limit,\x22editDataLimitValue\x22,\x22editDataLimitUnit\x22),document.getElementById(\x22editNotes\x22).value=e.notes||\x22\x22,document.getElementById(\x22resetTraffic\x22).checked=!1,v.classList.add(\x22show\x22)}else\x20t.classList.contains(\x22btn-delete\x22)&&confirm(`Are\x20you\x20sure\x20you\x20want\x20to\x20delete\x20user\x20${a.substring(0,8)}...?`)&&n.delete(`/users/${a}`).then(()=>{i(\x22User\x20deleted\x20successfully!\x22),m()}).catch(e=>i(e.message,!0))}),document.getElementById(\x22editUserForm\x22).addEventListener(\x22submit\x22,async\x20e=>{e.preventDefault();const\x20t=document.getElementById(\x22editUuid\x22).value,a=d(document.getElementById(\x22editExpiryDate\x22).value,document.getElementById(\x22editExpiryTime\x22).value),s={exp_date:a.utcDate,exp_time:a.utcTime,data_limit:y(\x22editDataLimitValue\x22,\x22editDataLimitUnit\x22),notes:document.getElementById(\x22editNotes\x22).value,reset_traffic:document.getElementById(\x22resetTraffic\x22).checked};try{await\x20n.put(`/users/${t}`,s),i(\x22User\x20updated\x20successfully!\x22),v.classList.remove(\x22show\x22),m()}catch(e){i(e.message,!0)}});document.getElementById(\x22pagination-controls\x22).addEventListener(\x22click\x22,e=>{const\x20t=e.target.closest(\x22button\x22);t&&!t.disabled&&p(parseInt(t.dataset.page))});const\x20w=()=>v.classList.remove(\x22show\x22);document.getElementById(\x22modalCloseBtn\x22).addEventListener(\x22click\x22,w),document.getElementById(\x22modalCancelBtn\x22).addEventListener(\x22click\x22,w),v.addEventListener(\x22click\x22,e=>{e.target===v&&w()}),document.addEventListener(\x22keydown\x22,e=>{\x22Escape\x22===e.key&&w()}),document.getElementById(\x22generateUUID\x22).addEventListener(\x22click\x22,()=>document.getElementById(\x22uuid\x22).value=crypto.randomUUID()),document.getElementById(\x22unlimitedBtn\x22).addEventListener(\x22click\x22,()=>{document.getElementById(\x22dataLimitValue\x22).value=\x22\x22}),document.getElementById(\x22editUnlimitedBtn\x22).addEventListener(\x22click\x22,()=>{document.getElementById(\x22editDataLimitValue\x22).value=\x22\x22});const\x20b=()=>{const\x20e=new\x20Date;e.setMonth(e.getMonth()+1),document.getElementById(\x22expiryDate\x22).value=`${e.getFullYear()}-${r(e.getMonth()+1)}-${r(e.getDate())}`,document.getElementById(\x22expiryTime\x22).value=`${r(e.getHours())}:${r(e.getMinutes())}:${r(e.getSeconds())}`};document.getElementById(\x22uuid\x22).value=crypto.randomUUID(),b(),m()});</script></body></html>';}async function handleRateLimiting(a,b){const c=a['headers']['get']('CF-Connecting-IP'),d='rate_limit:'+c,e=await b['USER_KV']['get'](d,'json')||{'count':0x0,'expiry':0x0};e['expiry']>Date['now']()?e['count']++:e['count']=0x1;e['expiry']=Date['now']()+RATE_LIMIT_CONFIG['WINDOW_SECONDS']*0x3e8;if(e['count']>RATE_LIMIT_CONFIG['MAX_REQUESTS'])return new Response(JSON['stringify']({'error':'Too\x20many\x20requests.\x20Please\x20try\x20again\x20later.'}),{'status':0x1ad,'headers':{'Content-Type':'application/json'}});return await b['USER_KV']['put'](d,JSON['stringify'](e),{'expirationTtl':RATE_LIMIT_CONFIG['WINDOW_SECONDS']}),null;}async function checkAdminAuth(a,b,c){const d=a['headers']['get']('Authorization');if(d&&d['startsWith']('Bearer\x20')){const i=d['substring'](0x7);if(b['API_TOKEN']&&i===b['API_TOKEN'])return{'isAdmin':!![],'errorResponse':null,'csrfToken':'api_token'};}const e=a['headers']['get']('Cookie'),f=e?.['match'](/auth_token=([^;]+)/)?.[0x1];if(!f)return{'isAdmin':![],'errorResponse':null,'csrfToken':null};const g=await b['USER_KV']['get']('admin_session:'+f,'json');if(!g){const j=new Headers({'Set-Cookie':'auth_token=;\x20Path=/'+c+';\x20Expires=Thu,\x2001\x20Jan\x201970\x2000:00:00\x20GMT'});return{'isAdmin':![],'errorResponse':new Response(null,{'status':0x193,'headers':j}),'csrfToken':null};}const {csrfToken:h}=g;if(['POST','PUT','DELETE']['includes'](a['method'])){const k=a['headers']['get']('X-CSRF-Token');if(!k||k!==h){const l=new Response(JSON['stringify']({'error':'Invalid\x20CSRF\x20token\x20or\x20session\x20expired.'}),{'status':0x193,'headers':{'Content-Type':'application/json'}});return{'isAdmin':![],'errorResponse':l,'csrfToken':null};}}return{'isAdmin':!![],'errorResponse':null,'csrfToken':h};}async function handleAdminRequest(a,b,c){const d=new URL(a['url']),{pathname:f}=d,g={'Content-Type':'application/json'},h='/'+c;if(!b['ADMIN_KEY'])return new Response('Admin\x20panel\x20is\x20not\x20configured.\x20Please\x20set\x20ADMIN_KEY\x20secret.',{'status':0x1f7});if(f['startsWith'](h+'/api/')){const i=await checkAdminAuth(a,b,c);if(i['errorResponse'])return i['errorResponse'];if(!i['isAdmin'])return new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':g});const j=f['substring']((h+'/api')['length']);if(j==='/stats'&&a['method']==='GET'){const [l,m,n]=await b['DB']['batch']([b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users'),b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27\x20>\x20?')['bind'](new Date()['toISOString']()),b['DB']['prepare']('SELECT\x20SUM(data_usage)\x20as\x20total\x20FROM\x20users')]),o=l[0x0]['results'][0x0]['count'],p=m[0x0]['results'][0x0]['count'],q=n[0x0]['results'][0x0]['total']||0x0,r={'totalUsers':o,'activeUsers':p,'expiredUsers':o-p,'totalTraffic':q};return new Response(JSON['stringify'](r),{'status':0xc8,'headers':g});}if(j==='/users'&&a['method']==='GET'){const s=parseInt(d['searchParams']['get']('page')||'1',0xa),t=parseInt(d['searchParams']['get']('limit')||'20',0xa),u=(s-0x1)*t,[v,w]=await b['DB']['batch']([b['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC\x20LIMIT\x20?\x20OFFSET\x20?')['bind'](t,u),b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20total\x20FROM\x20users')]),x=w[0x0]['results'][0x0]['total'],y=Math['ceil'](x/t);return new Response(JSON['stringify']({'users':v[0x0]['results']??[],'totalPages':y,'currentPage':s}),{'status':0xc8,'headers':g});}if(j==='/users'&&a['method']==='POST')try{const {uuid:z,exp_date:A,exp_time:B,notes:C,data_limit:D}=await a['json']();if(!z||!A||!B||!isValidUUID(z))throw new Error('Invalid\x20or\x20missing\x20fields.');return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20data_limit)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?)')['bind'](z,A,B,C||null,D>=0x0?D:0x0)['run'](),new Response(JSON['stringify']({'success':!![],'uuid':z}),{'status':0xc9,'headers':g});}catch(E){const F=E['message']['includes']('UNIQUE\x20constraint\x20failed')?'UUID\x20already\x20exists.':E['message'];return new Response(JSON['stringify']({'error':F}),{'status':0x190,'headers':g});}const k=j['match'](/^\/users\/([a-f0-9-]+)$/);if(k){const G=k[0x1];if(a['method']==='PUT')try{const {exp_date:H,exp_time:I,notes:J,data_limit:K,reset_traffic:L}=await a['json']();if(!H||!I)throw new Error('Invalid\x20date/time\x20fields.');const M='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20data_limit\x20=\x20?\x20'+(L?',\x20data_usage\x20=\x200':'')+'\x20WHERE\x20uuid\x20=\x20?';return await b['DB']['prepare'](M)['bind'](H,I,J||null,K>=0x0?K:0x0,G)['run'](),await b['USER_KV']['delete']('user:'+G),new Response(JSON['stringify']({'success':!![],'uuid':G}),{'status':0xc8,'headers':g});}catch(N){return new Response(JSON['stringify']({'error':N['message']}),{'status':0x190,'headers':g});}if(a['method']==='DELETE')return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](G)['run'](),await b['USER_KV']['delete']('user:'+G),new Response(null,{'status':0xcc});}return new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':g});}if(f===h){if(a['method']==='POST'){const O=await handleRateLimiting(a,b);if(O)return O;const P=await a['formData']();if(P['get']('password')===b['ADMIN_KEY']){const Q=crypto['randomUUID'](),R=crypto['randomUUID']();await b['USER_KV']['put']('admin_session:'+Q,JSON['stringify']({'csrfToken':R}),{'expirationTtl':0x15180});const S=new Headers({'Location':h,'Set-Cookie':'auth_token='+Q+';\x20HttpOnly;\x20Secure;\x20Path='+h+';\x20Max-Age=86400;\x20SameSite=Strict'});return new Response(null,{'status':0x12e,'headers':S});}else return new Response(getAdminLoginHTML(c)['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20password.</p>'),{'status':0x191,'headers':{'Content-Type':'text/html;charset=utf-8'}});}if(a['method']==='GET'){const {isAdmin:T,csrfToken:U,errorResponse:V}=await checkAdminAuth(a,b,c);if(V)return V;if(T){const W=getAdminPanelHTML(c),X=W['replace']('<input\x20type=\x22hidden\x22\x20id=\x22csrf_token\x22\x20name=\x22csrf_token\x22>','<input\x20type=\x22hidden\x22\x20id=\x22csrf_token\x22\x20name=\x22csrf_token\x22\x20value=\x22'+U+'\x22>');return new Response(X,{'headers':{'Content-Type':'text/html;charset=utf-8'}});}else return new Response(getAdminLoginHTML(c),{'headers':{'Content-Type':'text/html;charset=utf-8'}});}return new Response('Method\x20Not\x20Allowed',{'status':0x195});}return new Response('Not\x20found',{'status':0x194});}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++){d+=c['charAt'](Math['floor'](Math['random']()*c['length']));}return'/'+d+(b?'?'+b:'');}const CORE_PRESETS={'xray':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'tls','fp':'chrome','alpn':'http/1.1'},'sb':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'}}};function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'type':'ws','host':d,'path':e});if(f)l['set']('security',f);if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra))l['set'](m,n);return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,userID:b,hostName:c,address:d,port:e,tag:f}){const g=CORE_PRESETS[a];return createVlessLink({'userID':b,'address':d,'port':e,'host':c,'path':g['path'](),'security':g['security'],'sni':c,'fp':g['fp'],'alpn':g['alpn'],'extra':g['extra'],'name':f+'-TLS'});}async function handleIpSubscription(a,b,c,d){const e=[0x1bb,0x20fb,0x805,0x823,0x827,0x830];let f=[],g=await d['USER_KV']['get']('CLEAN_IPS','json');return(!g||!Array['isArray'](g)||g['length']===0x0)&&(g=['www.speedtest.net','cloudflare.com','discord.com',c]),g['forEach']((h,j)=>{const k=h['includes'](':')?'['+h+']':h;f['push'](buildLink({'core':a,'userID':b,'hostName':c,'address':k,'port':e[Math['floor'](Math['random']()*e['length'])],'tag':'IP'+(j+0x1)}));}),new Response(btoa(f['join']('\x0a')),{'headers':{'Content-Type':'text/plain;charset=utf-8'}});}export default{async 'fetch'(a,b,c){const d=new URL(a['url']),e=b['ADMIN_PATH']||'admin';if(d['pathname']['startsWith']('/'+e))return handleAdminRequest(a,b,e);const f=a['headers']['get']('Upgrade');if(f?.['toLowerCase']()==='websocket')return ProtocolOverWSHandler(a,b,c);if(d['pathname']['startsWith']('/api/network-info')){const i=a['headers']['get']('CF-Connecting-IP'),[j,k]=await Promise['all']([getIPInfo(i),getProxyIPInfo(b)]);return new Response(JSON['stringify']({'user':j,'proxy':k}),{'headers':{'Content-Type':'application/json','Access-Control-Allow-Origin':'*'}});}const g=async l=>{const m=d['pathname']['slice'](('/'+l+'/')['length']),n=await getUserData(b,m);if(!n||isExpired(n['expiration_date'],n['expiration_time'])||n['data_limit']>0x0&&n['data_usage']>=n['data_limit'])return new Response('Invalid,\x20expired,\x20or\x20data\x20limit\x20reached',{'status':0x193});return handleIpSubscription(l,m,d['hostname'],b);};if(d['pathname']['startsWith']('/xray/'))return g('xray');if(d['pathname']['startsWith']('/sb/'))return g('sb');const h=d['pathname']['slice'](0x1);if(isValidUUID(h)){const l=await getUserData(b,h);if(!l)return new Response('User\x20not\x20found',{'status':0x193});const m=a['headers']['get']('CF-Connecting-IP'),[n,o]=await Promise['all']([getIPInfo(m),getProxyIPInfo(b)]);return handleConfigPage(h,d['hostname'],l,n,o);}return new Response('Not\x20Found',{'status':0x194});}};async function ProtocolOverWSHandler(a,b,c){const d=new WebSocketPair(),[e,f]=Object['values'](d);f['accept']();let g=0x0,h='';const i=async()=>{if(g>0x0&&h)try{await b['DB']['prepare']('UPDATE\x20users\x20SET\x20data_usage\x20=\x20data_usage\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](Math['round'](g),h)['run'](),await b['USER_KV']['delete']('user:'+h);}catch(m){console['error']('Failed\x20to\x20update\x20usage\x20for\x20'+h+':',m);}},j=new TransformStream({'transform'(m,n){g+=m['byteLength'],n['enqueue'](m);}}),k=MakeReadableWebSocketStream(f);let l={'value':null};return k['pipeThrough'](j)['pipeTo'](new WritableStream({async 'write'(m,n){if(l['value']){const A=l['value']['writable']['getWriter']();await A['write'](m),A['releaseLock']();return;}const {user:o,hasError:p,message:q,addressRemote:r,portRemote:s,rawDataIndex:t,ProtocolVersion:u}=await ProcessProtocolHeader(m,b);if(p){n['error'](new Error(q));return;}h=o['uuid'];if(isExpired(o['expiration_date'],o['expiration_time'])){n['error'](new Error('User\x20expired.'));return;}if(o['data_limit']>0x0&&o['data_usage']+g>=o['data_limit']){n['error'](new Error('Data\x20limit\x20reached.'));return;}const v=parseInt(b['MAX_IPS_PER_USER'],0xa);if(v>0x0){const B=a['headers']['get']('CF-Connecting-IP'),C='user-ips:'+h,D=new Set(await b['USER_KV']['get'](C,'json')||[]);if(!D['has'](B)&&D['size']>=v){n['error'](new Error('Simultaneous\x20connection\x20limit\x20reached.'));return;}D['add'](B),c['waitUntil'](b['USER_KV']['put'](C,JSON['stringify']([...D]),{'expirationTtl':0x12c}));}const w=new Uint8Array([u[0x0],0x0]),x=m['slice'](t),y=await connect({'hostname':r,'port':s});l['value']=y;const z=y['writable']['getWriter']();await z['write'](x),z['releaseLock'](),RemoteSocketToWS(y,f,w,j);},'close'(){c['waitUntil'](i());},'abort'(m){console['error']('WebSocket\x20aborted:',m),c['waitUntil'](i());}}))['catch'](m=>{console['error']('WebSocket\x20pipeline\x20failed:',m['stack']||m),safeCloseWebSocket(f),c['waitUntil'](i());}),new Response(null,{'status':0x65,'webSocket':e});}async function ProcessProtocolHeader(a,b){if(a['byteLength']<0x18)return{'hasError':!![],'message':'invalid\x20data'};const c=new DataView(a['buffer']),d=c['getUint8'](0x0),e=unsafeStringify(new Uint8Array(a['slice'](0x1,0x11))),f=await getUserData(b,e);if(!f)return{'hasError':!![],'message':'invalid\x20user'};const g=c['getUint8'](0x11),h=c['getUint8'](0x12+g);if(h!==0x1)return{'hasError':!![],'message':'command\x20'+h+'\x20is\x20not\x20supported'};const i=0x12+g+0x1,j=c['getUint16'](i),k=c['getUint8'](i+0x2);let l,m,n;switch(k){case 0x1:m=0x4,n=i+0x3,l=new Uint8Array(a['slice'](n,n+m))['join']('.');break;case 0x2:m=c['getUint8'](i+0x3),n=i+0x4,l=new TextDecoder()['decode'](a['slice'](n,n+m));break;case 0x3:m=0x10,n=i+0x3,l=Array['from']({'length':0x8},(o,p)=>c['getUint16'](n+p*0x2)['toString'](0x10))['join'](':');break;default:return{'hasError':!![],'message':'invalid\x20addressType:\x20'+k};}return{'user':f,'hasError':![],'addressRemote':l,'portRemote':j,'rawDataIndex':n+m,'ProtocolVersion':new Uint8Array([d])};}function MakeReadableWebSocketStream(a){let b=![];return new ReadableStream({'start'(c){a['addEventListener']('message',f=>c['enqueue'](f['data'])),a['addEventListener']('close',()=>{safeCloseWebSocket(a),c['close']();}),a['addEventListener']('error',e=>{console['error']('WebSocket\x20error:',e),c['error'](e);});const d=base64ToArrayBuffer(a['protocol']);if(d)c['enqueue'](d);},'cancel'(){safeCloseWebSocket(a);}});}async function RemoteSocketToWS(a,b,c,d){try{await a['readable']['pipeThrough'](d)['pipeTo'](new WritableStream({'start'(){c&&b['send'](c);},async 'write'(e){b['readyState']===CONST['WS_READY_STATE_OPEN']&&b['send'](e);},'close'(){},'abort'(e){console['error']('remoteSocket\x20aborted',e);}}));}catch(e){console['error']('RemoteSocketToWS\x20error:',e['stack']||e),safeCloseWebSocket(b);}}function base64ToArrayBuffer(a){if(!a)return null;try{const b=atob(a['replace'](/-/g,'+')['replace'](/_/g,'/')),c=new ArrayBuffer(b['length']),d=new Uint8Array(c);for(let e=0x0;e<b['length'];e++){d[e]=b['charCodeAt'](e);}return c;}catch(f){return console['error']('Failed\x20to\x20decode\x20base64:',f),null;}}function safeCloseWebSocket(a){try{(a['readyState']===CONST['WS_READY_STATE_OPEN']||a['readyState']===CONST['WS_READY_STATE_CLOSING'])&&a['close']();}catch(b){console['error']('safeCloseWebSocket\x20error:',b);}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function handleConfigPage(a,b,c,d,e){const {expiration_date:f,expiration_time:g,data_usage:h,data_limit:i}=c;return new Response(generateConfigPageHTML(a,b,f,g,h,i,d,e),{'headers':{'Content-Type':'text/html;\x20charset=utf-8'}});}function generateConfigPageHTML(a,b,c,d,e,f,g,h){const i='https://'+b+'/xray/'+a,j='https://'+b+'/sb/'+a,k={'universal':'v2rayng://install-config?url='+encodeURIComponent(i),'shadowrocket':'shadowrocket://add/sub?url='+encodeURIComponent(i)+'&name='+encodeURIComponent(b),'stash':'stash://install-config?url='+encodeURIComponent(i),'clashMeta':'clash://install-config?url='+encodeURIComponent(j)},l=c+'T'+d['split']('.')[0x0]+'Z',m=isExpired(c,d),n=f>0x0,o=n&&e>=f;let p=m?'Expired':o?'Data\x20limit\x20reached':'Active',q=m||o?'status-expired-text':'status-active-text';const r=(t,u)=>{const v=u?.['ip']||'...',w=u?u['city']+',\x20'+u['country']:'...',x=u?.['isp']||'...';return'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22network-card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20class=\x22network-title\x22>'+t+'</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22network-info-grid\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div><strong>IP:</strong>\x20<span>'+v+'</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div><strong>Location:</strong>\x20<span>'+w+'</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div><strong>ISP:</strong>\x20<span>'+x+'</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>';},s=n?Math['min'](0x64,e/f*0x64):0x0;return'<!doctype\x20html>\x0a\x20\x20\x20\x20<html><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22><title>VLESS\x20Configuration</title><script\x20src=\x22https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js\x22></script><style>:root{--bg-main:#121212;--bg-card:#1E1E1E;--bg-inner:#2f2f2f;--border-color:#333;--text-primary:#E0E0E0;--text-secondary:#B0B0B0;--accent:#6200EE;--accent-hover:#7F39FB;--status-active:#03DAC6;--status-expired:#CF6679;--network-bg:#212121;--network-border:#444}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,Helvetica,Arial,sans-serif;background-color:var(--bg-main);color:var(--text-primary);padding:20px}.container{max-width:900px;margin:auto}.header{text-align:center;margin-bottom:24px}.header\x20h1{font-size:2em;margin-bottom:8px}.header\x20p{color:var(--text-secondary)}.top-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:20px}.info-card{background:var(--bg-card);border-radius:12px;position:relative;overflow:hidden;border:1px\x20solid\x20var(--border-color)}.info-card.rainbow-border::before{content:\x27\x27;position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from\x20180deg\x20at\x2050%\x2050%,#CF6679,#6200EE,#03DAC6,#CF6679);animation:spin\x204s\x20linear\x20infinite;z-index:1}.info-card-content{background:var(--bg-card);padding:20px;border-radius:10px;position:relative;z-index:2;margin:2px}.info-title{font-size:1.25em;text-align:center;margin:0\x200\x2016px;font-weight:500}.info-relative-time{text-align:center;font-size:1.4em;font-weight:600;margin-bottom:16px}.status-active-text{color:var(--status-active)}.status-expired-text{color:var(--status-expired)}.info-time-grid{display:grid;gap:8px;font-size:.9em;text-align:center;color:var(--text-secondary)}.data-usage-text{font-size:1.4em!important;font-weight:600;text-align:center;color:var(--text-primary);margin-bottom:16px}.traffic-bar-container{height:8px;background-color:var(--bg-inner);border-radius:4px;overflow:hidden}.traffic-bar{height:100%;background:linear-gradient(90deg,var(--accent)\x200%,var(--status-active)\x20100%);border-radius:4px;transition:width\x20.5s\x20ease-out}.config-card{background:var(--bg-card);border-radius:12px;padding:24px;margin-bottom:24px;border:1px\x20solid\x20var(--border-color)}.config-title{display:flex;justify-content:space-between;align-items:center;font-size:1.4rem;margin-bottom:20px;padding-bottom:16px;border-bottom:1px\x20solid\x20var(--border-color)}.button,.client-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px\x2016px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;border:1px\x20solid\x20var(--border-color);background-color:var(--bg-inner);color:var(--text-primary);text-decoration:none;transition:all\x20.2s}.button:hover{background-color:#3f3f3f}.client-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}.client-btn{width:100%;box-sizing:border-box;background-color:var(--accent);color:#fff;border:none}.client-btn:hover{background-color:var(--accent-hover)}.qr-container{display:none;margin-top:20px;background:#fff;padding:16px;border-radius:8px;max-width:288px;margin-left:auto;margin-right:auto}.network-info-wrapper{background:var(--bg-card);border-radius:12px;padding:24px;margin-bottom:24px;border:1px\x20solid\x20var(--border-color)}.network-info-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px\x20solid\x20var(--border-color)}.network-info-header\x20h2{margin:0;font-size:1.4rem}.network-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}.network-card{background:var(--network-bg);border:1px\x20solid\x20var(--network-border);border-radius:8px;padding:16px}.network-title{font-size:1.1em;margin-top:0;margin-bottom:12px;border-bottom:1px\x20solid\x20var(--network-border);padding-bottom:8px;color:var(--status-active)}.network-info-grid{display:grid;gap:8px;font-size:.9em}.network-info-grid\x20strong{color:var(--text-secondary);font-weight:400;display:inline-block;min-width:70px}.network-info-grid\x20span{color:var(--text-primary);font-weight:500}.refresh-btn{background-color:var(--network-bg)}.refresh-btn:hover{background-color:#3f3f3f}@keyframes\x20spin{100%{transform:rotate(360deg)}}@media\x20(max-width:768px){body{padding:10px}.top-grid,.network-grid{grid-template-columns:1fr}.network-info-header{flex-direction:column;align-items:flex-start}.network-info-header\x20button{margin-top:10px;width:100%}}</style></head>\x0a\x20\x20\x20\x20<body><div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22header\x22><h1>VLESS\x20Configuration</h1><p>Status:\x20<span\x20class=\x22'+q+'\x22>'+p+'</span></p></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22top-grid\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-card\x20rainbow-border\x22><div\x20class=\x22info-card-content\x22><h2\x20class=\x22info-title\x22>Expiration\x20Date</h2><div\x20id=\x22expiration-relative\x22\x20class=\x22info-relative-time\x20'+q+'\x22>--</div><div\x20class=\x22info-time-grid\x22\x20id=\x22expiration-display\x22\x20data-utc-time=\x22'+l+'\x22><div><strong>Local:</strong>\x20<span\x20id=\x22local-time\x22>--</span></div><div><strong>Tehran:</strong>\x20<span\x20id=\x22tehran-time\x22>--</span></div><div><strong>UTC:</strong>\x20<span\x20id=\x22utc-time\x22>--</span></div></div></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22info-card\x22><div\x20class=\x22info-card-content\x22><h2\x20class=\x22info-title\x22>Data\x20Usage</h2><div\x20class=\x22data-usage-text\x22\x20id=\x22data-usage-display\x22\x20data-usage=\x22'+e+'\x22\x20data-limit=\x22'+f+'\x22>...</div><div\x20class=\x22traffic-bar-container\x22><div\x20class=\x22traffic-bar\x22\x20style=\x22width:'+s+'%\x22></div></div></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22network-info-wrapper\x22><div\x20class=\x22network-info-header\x22><h2>Network\x20Information</h2><button\x20class=\x22button\x20refresh-btn\x22\x20id=\x22refresh-network\x22>Refresh</button></div><div\x20id=\x22network-info-container\x22\x20class=\x22network-grid\x22>'+r('Proxy\x20Server',h)+r('Your\x20Connection',g)+'</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22config-card\x22><div\x20class=\x22config-title\x22><span>Xray\x20Subscription</span><button\x20class=\x22button\x20copy-btn\x22\x20data-clipboard-text=\x22'+i+'\x22>Copy\x20Link</button></div><div\x20class=\x22client-buttons\x22><a\x20href=\x22'+k['universal']+'\x22\x20class=\x22client-btn\x22>Universal\x20Import\x20(V2rayNG,\x20etc.)</a><a\x20href=\x22'+k['shadowrocket']+'\x22\x20class=\x22client-btn\x22>Import\x20to\x20Shadowrocket</a><a\x20href=\x22'+k['stash']+'\x22\x20class=\x22client-btn\x22>Import\x20to\x20Stash\x20(VLESS)</a><button\x20class=\x22client-btn\x22\x20onclick=\x22toggleQR(\x27xray\x27,\x20\x27'+i+'\x27)\x22>Show\x20QR\x20Code</button></div><div\x20id=\x22qr-xray-container\x22\x20class=\x22qr-container\x22><div\x20id=\x22qr-xray\x22></div></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22config-card\x22><div\x20class=\x22config-title\x22><span>Sing-Box\x20/\x20Clash\x20Subscription</span><button\x20class=\x22button\x20copy-btn\x22\x20data-clipboard-text=\x22'+j+'\x22>Copy\x20Link</button></div><div\x20class=\x22client-buttons\x22><a\x20href=\x22'+k['clashMeta']+'\x22\x20class=\x22client-btn\x22>Import\x20to\x20Clash\x20Meta\x20/\x20Stash</a><button\x20class=\x22client-btn\x22\x20onclick=\x22toggleQR(\x27singbox\x27,\x20\x27'+j+'\x27)\x22>Show\x20QR\x20Code</button></div><div\x20id=\x22qr-singbox-container\x22\x20class=\x22qr-container\x22><div\x20id=\x22qr-singbox\x22></div></div></div>\x0a\x20\x20\x20\x20</div><script>\x0a\x20\x20\x20\x20function\x20copyToClipboard(btn,text){const\x20orig=btn.textContent;navigator.clipboard.writeText(text).then(()=>{btn.textContent=\x27Copied!\x27;setTimeout(()=>{btn.textContent=orig},1500)})}\x0a\x20\x20\x20\x20function\x20toggleQR(id,url){const\x20cont=document.getElementById(\x27qr-\x27+id+\x27-container\x27),qr=document.getElementById(\x27qr-\x27+id);if(cont.style.display===\x27none\x27||cont.style.display===\x27\x27){cont.style.display=\x27block\x27;if(!qr.hasChildNodes()){new\x20QRCode(qr,{text:url,width:256,height:256,colorDark:\x22#000\x22,colorLight:\x22#fff\x22,correctLevel:QRCode.CorrectLevel.H})}}else{cont.style.display=\x27none\x27}}\x0a\x20\x20\x20\x20function\x20displayTimes(){const\x20el=document.getElementById(\x27expiration-display\x27),rel=document.getElementById(\x27expiration-relative\x27);if(!el?.dataset.utcTime)return;const\x20d=new\x20Date(el.dataset.utcTime);if(isNaN(d.getTime()))return;const\x20diff=(d.getTime()-new\x20Date().getTime())/1e3,exp=diff<0;if(!exp){const\x20rtf=new\x20Intl.RelativeTimeFormat(\x27en\x27,{numeric:\x27auto\x27});let\x20t=\x27\x27;if(Math.abs(diff)<3600)t=rtf.format(Math.round(diff/60),\x27minute\x27);else\x20if(Math.abs(diff)<86400)t=rtf.format(Math.round(diff/3600),\x27hour\x27);else\x20t=rtf.format(Math.round(diff/86400),\x27day\x27);rel.textContent=`Expires\x20${t}`}else{rel.textContent=\x22Expired\x22}\x0a\x20\x20\x20\x20document.getElementById(\x27local-time\x27).textContent=d.toLocaleString();document.getElementById(\x27tehran-time\x27).textContent=d.toLocaleString(\x27en-US\x27,{timeZone:\x27Asia/Tehran\x27,hour12:!0,year:\x27numeric\x27,month:\x27short\x27,day:\x27numeric\x27,hour:\x27numeric\x27,minute:\x272-digit\x27});document.getElementById(\x27utc-time\x27).textContent=`${d.toISOString().substring(0,19).replace(\x27T\x27,\x27\x20\x27)}\x20UTC`}\x0a\x20\x20\x20\x20function\x20displayUsage(){const\x20el=document.getElementById(\x27data-usage-display\x27),u=parseInt(el.dataset.usage,10),l=parseInt(el.dataset.limit,10);const\x20b=b=>{if(b<=0)return\x270\x20Bytes\x27;const\x20i=Math.floor(Math.log(b)/Math.log(1024));return`${parseFloat((b/Math.pow(1024,i)).toFixed(2))}\x20${[\x27B\x27,\x27KB\x27,\x27MB\x27,\x27GB\x27,\x27TB\x27][i]}`};const\x20lt=l>0?b(l):\x27&infin;\x27;el.innerHTML=`${b(u)}\x20/\x20${lt}`}\x0a\x20\x20\x20\x20async\x20function\x20refreshNetwork(){const\x20btn=document.getElementById(\x27refresh-network\x27);btn.disabled=!0,btn.textContent=\x27Refreshing...\x27;try{const\x20res=await\x20fetch(\x27/api/network-info\x27);if(!res.ok)throw\x20new\x20Error(\x27Failed\x20to\x20fetch\x27);const\x20data=await\x20res.json();const\x20container=document.getElementById(\x27network-info-container\x27);const\x20render=\x20(t,d)=>{const\x20ip=d?.ip||\x27...\x27,loc=d?`${d.city},\x20${d.country}`:\x27...\x27,isp=d?.isp||\x27...\x27;return\x20`<div\x20class=\x22network-card\x22><h3\x20class=\x22network-title\x22>${t}</h3><div\x20class=\x22network-info-grid\x22><div><strong>IP:</strong>\x20<span>${ip}</span></div><div><strong>Location:</strong>\x20<span>${loc}</span></div><div><strong>ISP:</strong>\x20<span>${isp}</span></div></div></div>`};container.innerHTML=render(\x27Proxy\x20Server\x27,data.proxy)+render(\x27Your\x20Connection\x27,data.user)}catch(e){console.error(\x27Refresh\x20failed\x27,e)}finally{btn.disabled=!1,btn.textContent=\x27Refresh\x27}}\x0a\x20\x20\x20\x20document.addEventListener(\x27DOMContentLoaded\x27,()=>{displayTimes();displayUsage();document.querySelectorAll(\x27.copy-btn\x27).forEach(b=>{b.addEventListener(\x27click\x27,()=>copyToClipboard(b,b.dataset.clipboardText))});document.getElementById(\x27refresh-network\x27).addEventListener(\x27click\x27,refreshNetwork);setInterval(displayTimes,6e4)})\x0a\x20\x20\x20\x20</script></body></html>';}