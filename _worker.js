// <!--GAMFC--> version base on commit 965cc3cb3fad1487ca4ef125f8b5987d78b36a54, time is 2025-10-15 22:05:12 UTC<!--We are all REvil-->
// @ts-ignore

import{connect}from'cloudflare:sockets';function log(a,b='info'){const c=new Date()['toISOString']();console['log']('['+c+']\x20['+b['toUpperCase']()+']\x20'+a);}function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;return b['test'](a);}async function checkExpiration(a,b){if(!a||!b)return![];const c=new Date(a+'T'+b+'Z');return c>new Date()&&!isNaN(c);}async function getUserData(a,b){let c=await a['USER_KV']['get']('user:'+b);if(c)try{return JSON['parse'](c);}catch(f){log('Failed\x20to\x20parse\x20user\x20data\x20from\x20KV\x20for\x20UUID:\x20'+b,'error');}const d=await a['DB']['prepare']('SELECT\x20uuid,\x20expiration_date,\x20expiration_time,\x20data_limit,\x20used_traffic,\x20notes\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!d)return null;return c={'uuid':d['uuid'],'exp_date':d['expiration_date'],'exp_time':d['expiration_time'],'data_limit':d['data_limit'],'used_traffic':d['used_traffic'],'notes':d['notes']},await a['USER_KV']['put']('user:'+b,JSON['stringify'](c),{'expirationTtl':0xe10}),c;}async function updateUsedTraffic(a,b,c){if(c<=0x0)return;await a['DB']['prepare']('UPDATE\x20users\x20SET\x20used_traffic\x20=\x20used_traffic\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](c,b)['run'](),await a['USER_KV']['delete']('user:'+b),log('Updated\x20traffic\x20for\x20'+b+'\x20by\x20'+c+'\x20bytes.\x20Invalidated\x20KV\x20cache.');}async function fetchDashboardStats(a){const b=new Date()['toISOString']()['split']('T')[0x0],c=new Date()['toISOString']()['split']('T')[0x1]['slice'](0x0,0x8),d=await a['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users')['first'](),e=await a['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20count\x20FROM\x20users\x20WHERE\x20(expiration_date\x20<\x20?\x20OR\x20(expiration_date\x20=\x20?\x20AND\x20expiration_time\x20<\x20?))\x20OR\x20(data_limit\x20>\x200\x20AND\x20used_traffic\x20>=\x20data_limit)')['bind'](b,b,c)['first'](),f=await a['DB']['prepare']('SELECT\x20SUM(used_traffic)\x20as\x20total\x20FROM\x20users')['first']();return{'totalUsers':d['count'],'activeUsers':d['count']-e['count'],'expiredUsers':e['count'],'totalTraffic':f['total']||0x0};}const adminLoginHTML='<!DOCTYPE\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22><title>Admin\x20Login</title><style>body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background-color:#121212;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,Helvetica,Arial,sans-serif}.login-container{background-color:#1e1e1e;padding:40px;border-radius:12px;box-shadow:0\x204px\x2020px\x20rgba(0,0,0,.5);text-align:center;width:320px;border:1px\x20solid\x20#333}h1{color:#fff;margin-bottom:24px;font-weight:500}form{display:flex;flex-direction:column}input[type=password]{background-color:#2c2c2c;border:1px\x20solid\x20#444;color:#fff;padding:12px;border-radius:8px;margin-bottom:20px;font-size:16px}input[type=password]:focus{outline:0;border-color:#007aff;box-shadow:0\x200\x200\x202px\x20rgba(0,122,255,.3)}button{background-color:#007aff;color:#fff;border:0;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color\x20.2s}button:hover{background-color:#005ecb}.error{color:#ff3b30;margin-top:15px;font-size:14px}</style></head><body><div\x20class=\x22login-container\x22><h1>Admin\x20Login</h1><form\x20method=\x22POST\x22\x20action=\x22/admin\x22><input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22••••••••••••••\x22\x20required><button\x20type=\x22submit\x22>Login</button></form></div></body></html>';function getAdminPanelScript(){return function(){document['addEventListener']('DOMContentLoaded',()=>{const a='/admin/api';let b=[],c=[];const d=document['getElementById']('userList'),e=document['getElementById']('createUserForm'),f=document['getElementById']('generateUUID'),g=document['getElementById']('uuid'),h=document['getElementById']('toast'),i=document['getElementById']('editModal'),j=document['getElementById']('editUserForm'),k=document['getElementById']('selectAll'),l=document['getElementById']('deleteSelected'),m=document['getElementById']('searchInput'),n=document['getElementById']('dashboardStats'),o=document['getElementById']('pagination'),p=document['getElementById']('sortBy'),q=document['getElementById']('sortOrder');let r=0x1;const s=0xa;let t,u=null,v='CSRF_TOKEN_PLACEHOLDER';function w(Z,a0=![]){h['textContent']=Z,h['className']=a0?'error':'success',h['classList']['add']('show'),setTimeout(()=>{h['classList']['remove']('show');},0xbb8);}const x={'get':Z=>fetch(''+a+Z,{'credentials':'include'})['then'](y),'post':(Z,a0)=>fetch(''+a+Z,{'method':'POST','credentials':'include','headers':{'Content-Type':'application/json','X-CSRF-Token':v},'body':JSON['stringify'](a0)})['then'](y),'put':(Z,a0)=>fetch(''+a+Z,{'method':'PUT','credentials':'include','headers':{'Content-Type':'application/json','X-CSRF-Token':v},'body':JSON['stringify'](a0)})['then'](y),'delete':Z=>fetch(''+a+Z,{'method':'DELETE','credentials':'include','headers':{'X-CSRF-Token':v}})['then'](y)};async function y(Z){if(!Z['ok']){const a0=await Z['json']()['catch'](()=>({'error':'An\x20unknown\x20error\x20occurred.'}));throw new Error(a0['error']||'Request\x20failed\x20with\x20status\x20'+Z['status']);}return Z['status']===0xcc?null:Z['json']();}const z=Z=>Z['toString']()['padStart'](0x2,'0');function A(Z,a0){if(!Z||!a0)return{'utcDate':'','utcTime':''};const a1=new Date(Z+'T'+a0);if(isNaN(a1))return{'utcDate':'','utcTime':''};return{'utcDate':a1['getUTCFullYear']()+'-'+z(a1['getUTCMonth']()+0x1)+'-'+z(a1['getUTCDate']()),'utcTime':z(a1['getUTCHours']())+':'+z(a1['getUTCMinutes']())+':'+z(a1['getUTCSeconds']())};}function B(Z,a0){if(!Z||!a0)return{'localDate':'','localTime':''};const a1=new Date(Z+'T'+a0+'Z');if(isNaN(a1))return{'localDate':'','localTime':''};return{'localDate':a1['getFullYear']()+'-'+z(a1['getMonth']()+0x1)+'-'+z(a1['getDate']()),'localTime':z(a1['getHours']())+':'+z(a1['getMinutes']())+':'+z(a1['getSeconds']())};}function C(Z,a0,a1,a2){const a3=document['getElementById'](Z),a4=document['getElementById'](a0);let a5=new Date(a3['value']+'T'+(a4['value']||'00:00:00'));if(isNaN(a5['getTime']()))a5=new Date();if(a2==='hour')a5['setHours'](a5['getHours']()+a1);else{if(a2==='day')a5['setDate'](a5['getDate']()+a1);else{if(a2==='month')a5['setMonth'](a5['getMonth']()+a1);}}a3['value']=a5['getFullYear']()+'-'+z(a5['getMonth']()+0x1)+'-'+z(a5['getDate']()),a4['value']=z(a5['getHours']())+':'+z(a5['getMinutes']())+':'+z(a5['getSeconds']());}document['body']['addEventListener']('click',Z=>{const a0=Z['target']['closest']('.time-quick-set-group\x20button');if(a0){const a2=a0['closest']('.time-quick-set-group');C(a2['dataset']['targetDate'],a2['dataset']['targetTime'],parseInt(a0['dataset']['amount'],0xa),a0['dataset']['unit']);return;}const a1=Z['target']['closest']('.data-quick-set-group\x20button');if(a1){const a3=parseInt(a1['dataset']['gb'],0xa),a4=a1['closest']('form'),a5=a4['querySelector']('input[type=\x22number\x22][id*=\x22DataLimitValue\x22]'),a6=a4['querySelector']('select[id*=\x22DataLimitUnit\x22]');a5&&a6&&(a5['value']=a3,a6['value']='GB');}});function D(Z,a0){const a1=new Date(Z+'T'+a0+'Z');if(isNaN(a1))return{'local':'Invalid\x20Date','utc':'','relative':'','tehran':'','isExpired':!![]};const a2=new Date(),a3=a1<a2,a4=new Intl['RelativeTimeFormat']('en',{'numeric':'auto'}),a5=(a1['getTime']()-a2['getTime']())/0x3e8;let a6='';if(Math['abs'](a5)<0x3c)a6=a4['format'](Math['round'](a5),'second');else{if(Math['abs'](a5)<0xe10)a6=a4['format'](Math['round'](a5/0x3c),'minute');else{if(Math['abs'](a5)<0x15180)a6=a4['format'](Math['round'](a5/0xe10),'hour');else a6=a4['format'](Math['round'](a5/0x15180),'day');}}return{'local':a1['toLocaleString'](undefined,{'year':'numeric','month':'2-digit','day':'2-digit','hour':'2-digit','minute':'2-digit'}),'tehran':a1['toLocaleString']('en-US',{'timeZone':'Asia/Tehran','year':'numeric','month':'2-digit','day':'2-digit','hour':'2-digit','minute':'2-digit'}),'relative':a6,'isExpired':a3};}function E(Z,a0=0x2){if(!Z||Z===0x0)return'0\x20Bytes';const a1=0x400,a2=a0<0x0?0x0:a0,a3=['Bytes','KB','MB','GB','TB'],a4=Math['floor'](Math['log'](Z)/Math['log'](a1));return parseFloat((Z/Math['pow'](a1,a4))['toFixed'](a2))+'\x20'+a3[a4];}function F(Z,a0){const a1=parseFloat(Z)||0x0;if(a1===0x0)return 0x0;const a2={'KB':0x400,'MB':0x400**0x2,'GB':0x400**0x3,'TB':0x400**0x4};return a1*(a2[a0]||0x0);}function G(Z=![]){const a0=Z?'edit':'';document['getElementById'](a0+'DataLimitValue')['value']=0x0,document['getElementById'](a0+'DataLimitUnit')['value']='GB';}function H(Z=![]){const a0=Z?'edit':'';return F(document['getElementById'](a0+'DataLimitValue')['value'],document['getElementById'](a0+'DataLimitUnit')['value']);}function I(Z,a0=![]){const a1=a0?'edit':'',a2=document['getElementById'](a1+'DataLimitValue'),a3=document['getElementById'](a1+'DataLimitUnit');if(!Z||Z===0x0){a2['value']=0x0,a3['value']='GB';return;}let a4='GB',a5=Z;if(a5>=0x400**0x4)a5/=0x400**0x4,a4='TB';else{if(a5>=0x400**0x3)a5/=0x400**0x3,a4='GB';else{if(a5>=0x400**0x2)a5/=0x400**0x2,a4='MB';else a5>=0x400&&(a5/=0x400,a4='KB');}}a2['value']=Number['isInteger'](a5)?a5:a5['toFixed'](0x2),a3['value']=a4;}function J(Z){n['innerHTML']='<div\x20class=\x22dashboard-stat\x22><h3>'+Z['totalUsers']+'</h3><p>Total\x20Users</p></div><div\x20class=\x22dashboard-stat\x22><h3>'+Z['activeUsers']+'</h3><p>Active\x20Users</p></div><div\x20class=\x22dashboard-stat\x22><h3>'+Z['expiredUsers']+'</h3><p>Expired\x20Users</p></div><div\x20class=\x22dashboard-stat\x22><h3>'+E(Z['totalTraffic'])+'</h3><p>Total\x20Traffic</p></div>';const a0=document['getElementById']('statsChart')['getContext']('2d'),a1=getComputedStyle(document['documentElement']);if(u)u['destroy']();u=new Chart(a0,{'type':'bar','data':{'labels':['Users','Traffic'],'datasets':[{'label':'Active','data':[Z['activeUsers'],0x0],'backgroundColor':a1['getPropertyValue']('--success')['trim'](),'stack':'stack0'},{'label':'Expired','data':[Z['expiredUsers'],0x0],'backgroundColor':a1['getPropertyValue']('--expired')['trim'](),'stack':'stack0'},{'label':'Total\x20Traffic\x20(GB)','data':[0x0,(Z['totalTraffic']/0x400**0x3)['toFixed'](0x2)],'backgroundColor':a1['getPropertyValue']('--accent')['trim'](),'yAxisID':'yTraffic','stack':'stack1'}]},'options':{'responsive':!![],'maintainAspectRatio':![],'plugins':{'legend':{'display':!![]},'title':{'display':!![],'text':'User\x20and\x20Traffic\x20Overview'}},'scales':{'x':{'stacked':!![]},'y':{'type':'linear','display':!![],'position':'left','stacked':!![],'title':{'display':!![],'text':'User\x20Count'},'beginAtZero':!![]},'yTraffic':{'type':'linear','display':!![],'position':'right','title':{'display':!![],'text':'Traffic\x20(GB)'},'grid':{'drawOnChartArea':![]},'beginAtZero':!![]}}}});}function K(){const Z=(r-0x1)*s,a0=Z+s,a1=c['slice'](Z,a0);d['innerHTML']='';if(a1['length']===0x0){d['innerHTML']='<tr><td\x20colspan=\x229\x22\x20style=\x22text-align:center;\x22>No\x20users\x20found.</td></tr>';return;}a1['forEach'](a2=>{const a3=D(a2['expiration_date'],a2['expiration_time']),a4=a3['isExpired']||a2['data_limit']>0x0&&a2['used_traffic']>=a2['data_limit'],a5=a2['data_limit']||0x0,a6=a2['used_traffic']||0x0,a7=a5===0x0?E(a6)+'\x20/\x20∞':E(a6)+'\x20/\x20'+E(a5),a8=a5===0x0?0x0:Math['min'](a6/a5*0x64,0x64);let a9='';if(a8>0x5a)a9='danger';else{if(a8>0x46)a9='warning';}const aa=document['createElement']('tr');aa['dataset']['uuid']=a2['uuid'],aa['innerHTML']='<td><input\x20type=\x22checkbox\x22\x20class=\x22userSelect\x22\x20data-uuid=\x22'+a2['uuid']+'\x22></td><td\x20title=\x22'+a2['uuid']+'\x22>'+a2['uuid']['substring'](0x0,0x8)+'...</td><td>'+new Date(a2['created_at'])['toLocaleString']()+'</td><td\x20title=\x22Local:\x20'+a3['local']+'\x22>'+a3['relative']+'</td><td\x20title=\x22UTC:\x20'+a2['expiration_date']+'\x20'+a2['expiration_time']+'\x22>'+a3['tehran']+'</td><td><span\x20class=\x22status-badge\x20'+(a4?'status-expired':'status-active')+'\x22>'+(a4?'Expired':'Active')+'</span></td><td><div\x20class=\x22progress-bar-container\x22><div\x20class=\x22progress-bar\x20'+a9+'\x22\x20style=\x22width:\x20'+a8+'%\x22></div></div><div\x20class=\x22traffic-text\x22>'+a7+'</div></td><td\x20title=\x22'+(a2['notes']||'')+'\x22>'+(a2['notes']||'-')['substring'](0x0,0x14)+'</td><td><div\x20class=\x22actions-cell\x22><button\x20class=\x22btn\x20btn-secondary\x20btn-renew\x22\x20data-uuid=\x22'+a2['uuid']+'\x22>Renew</button><button\x20class=\x22btn\x20btn-secondary\x20btn-edit\x22\x20data-uuid=\x22'+a2['uuid']+'\x22>Edit</button><button\x20class=\x22btn\x20btn-danger\x20btn-delete\x22\x20data-uuid=\x22'+a2['uuid']+'\x22>Delete</button></div></td>',d['appendChild'](aa);});}function L(){const Z=p['value'],a0=q['value']==='asc'?0x1:-0x1;b['sort']((a1,a2)=>{let a3,a4;if(Z==='expiration_date')a3=new Date(a1['expiration_date']+'T'+a1['expiration_time']+'Z'||0x0),a4=new Date(a2['expiration_date']+'T'+a2['expiration_time']+'Z'||0x0);else{if(Z==='created_at')a3=new Date(a1['created_at']),a4=new Date(a2['created_at']);else Z==='used_traffic'||Z==='data_limit'?(a3=a1[Z]||0x0,a4=a2[Z]||0x0):(a3=(a1[Z]||'')['toLowerCase'](),a4=(a2[Z]||'')['toLowerCase']());}if(a3<a4)return-0x1*a0;if(a3>a4)return 0x1*a0;return 0x0;});}function M(){W(),Y();}async function N(){try{const [Z,a0]=await Promise['all']([x['get']('/users'),x['get']('/stats')]);b=Z,L(),M(),J(a0);}catch(a1){w(a1['message'],!![]);}}async function O(Z){Z['preventDefault']();const {utcDate:a0,utcTime:a1}=A(document['getElementById']('expiryDate')['value'],document['getElementById']('expiryTime')['value']);if(!a0||!a1)return w('Invalid\x20date\x20or\x20time\x20entered.',!![]);const a2={'uuid':g['value'],'exp_date':a0,'exp_time':a1,'data_limit':H(),'notes':document['getElementById']('notes')['value']};try{await x['post']('/users',a2),w('User\x20created\x20successfully!'),e['reset'](),g['value']=crypto['randomUUID'](),V(),await N();}catch(a3){w(a3['message'],!![]);}}async function P(Z){if(confirm('Are\x20you\x20sure\x20you\x20want\x20to\x20delete\x20user\x20'+Z+'?'))try{await x['delete']('/users/'+Z),w('User\x20deleted\x20successfully!'),await N();}catch(a0){w(a0['message'],!![]);}}async function Q(Z){if(confirm('Are\x20you\x20sure\x20you\x20want\x20to\x20renew\x20this\x20user\x20for\x2030\x20days?'))try{await x['post']('/users/'+Z+'/renew'),w('User\x20renewed\x20successfully!'),await N();}catch(a0){w(a0['message'],!![]);}}async function R(){const Z=Array['from'](document['querySelectorAll']('.userSelect:checked'))['map'](a0=>a0['dataset']['uuid']);if(Z['length']===0x0)return w('No\x20users\x20selected.',!![]);if(confirm('Are\x20you\x20sure\x20you\x20want\x20to\x20delete\x20'+Z['length']+'\x20selected\x20users?'))try{await x['post']('/users/bulk-delete',{'uuids':Z}),w('Selected\x20users\x20deleted\x20successfully!'),await N();}catch(a0){w(a0['message'],!![]);}}function S(Z){const a0=b['find'](a3=>a3['uuid']===Z);if(!a0)return w('User\x20not\x20found.',!![]);const {localDate:a1,localTime:a2}=B(a0['expiration_date'],a0['expiration_time']);document['getElementById']('editUuid')['value']=a0['uuid'],document['getElementById']('editExpiryDate')['value']=a1,document['getElementById']('editExpiryTime')['value']=a2,I(a0['data_limit'],!![]),document['getElementById']('editNotes')['value']=a0['notes']||'',document['getElementById']('resetTraffic')['checked']=![],i['classList']['add']('show');}function T(){i['classList']['remove']('show');}async function U(Z){Z['preventDefault']();const {utcDate:a0,utcTime:a1}=A(document['getElementById']('editExpiryDate')['value'],document['getElementById']('editExpiryTime')['value']);if(!a0||!a1)return w('Invalid\x20date\x20or\x20time\x20entered.',!![]);const a2={'exp_date':a0,'exp_time':a1,'data_limit':H(!![]),'notes':document['getElementById']('editNotes')['value'],'reset_traffic':document['getElementById']('resetTraffic')['checked']};try{await x['put']('/users/'+document['getElementById']('editUuid')['value'],a2),w('User\x20updated\x20successfully!'),T(),await N();}catch(a3){w(a3['message'],!![]);}}function V(){const Z=new Date();Z['setMonth'](Z['getMonth']()+0x1),Z['setHours'](0x17,0x3b,0x3b,0x3e7),document['getElementById']('expiryDate')['value']=Z['getFullYear']()+'-'+z(Z['getMonth']()+0x1)+'-'+z(Z['getDate']()),document['getElementById']('expiryTime')['value']=z(Z['getHours']())+':'+z(Z['getMinutes']())+':'+z(Z['getSeconds']());}function W(){clearTimeout(t),t=setTimeout(()=>{const Z=m['value']['toLowerCase']();c=Z?b['filter'](a0=>a0['uuid']['toLowerCase']()['includes'](Z)||(a0['notes']||'')['toLowerCase']()['includes'](Z)):[...b],r=0x1,K(),Y();},0x12c);}function X(){if(b['length']===0x0)return w('No\x20users\x20to\x20export.',!![]);const Z=['UUID,Created\x20At,Expiration\x20Date,Expiration\x20Time,Data\x20Limit\x20(Bytes),Used\x20Traffic\x20(Bytes),Notes',...b['map'](a2=>[a2['uuid'],a2['created_at'],a2['expiration_date'],a2['expiration_time'],a2['data_limit'],a2['used_traffic'],'\x22'+(a2['notes']||'')['replace'](/"/g,'\x22\x22')+'\x22']['join'](','))]['join']('\x0a'),a0=new Blob([Z],{'type':'text/csv;charset=utf-8;'}),a1=document['createElement']('a');a1['href']=URL['createObjectURL'](a0),a1['download']='users_export.csv',a1['click'](),URL['revokeObjectURL'](a1['href']);}function Y(){o['innerHTML']='';const Z=Math['ceil'](c['length']/s);if(Z<=0x1)return;const a0=(a2,a3,a4)=>{const a5=document['createElement']('button');return a5['classList']['add']('btn','btn-secondary'),a5['textContent']=a2,a5['disabled']=a4,a5['onclick']=a3,a5;};o['appendChild'](a0('Previous',()=>{r--,K(),Y();},r===0x1));const a1=document['createElement']('span');a1['textContent']='Page\x20'+r+'\x20of\x20'+Z,o['appendChild'](a1),o['appendChild'](a0('Next',()=>{r++,K(),Y();},r===Z));}f['addEventListener']('click',()=>g['value']=crypto['randomUUID']()),e['addEventListener']('submit',O),j['addEventListener']('submit',U),i['addEventListener']('click',Z=>{if(Z['target']===i)T();}),document['getElementById']('modalCloseBtn')['addEventListener']('click',T),document['getElementById']('modalCancelBtn')['addEventListener']('click',T),d['addEventListener']('click',Z=>{const a0=Z['target']['closest']('button');if(!a0)return;const a1=a0['dataset']['uuid'];if(a0['classList']['contains']('btn-edit'))S(a1);else{if(a0['classList']['contains']('btn-delete'))P(a1);else{if(a0['classList']['contains']('btn-renew'))Q(a1);}}}),document['getElementById']('selectAll')['addEventListener']('change',Z=>document['querySelectorAll']('.userSelect')['forEach'](a0=>a0['checked']=Z['target']['checked'])),l['addEventListener']('click',R),m['addEventListener']('input',W),p['addEventListener']('change',()=>{L(),M();}),q['addEventListener']('change',()=>{L(),M();}),document['getElementById']('setUnlimitedCreate')['addEventListener']('click',()=>G(![])),document['getElementById']('setUnlimitedEdit')['addEventListener']('click',()=>G(!![])),document['getElementById']('exportUsers')['addEventListener']('click',X),V(),g['value']=crypto['randomUUID'](),N(),setInterval(N,0xafc8);});};}const adminPanelHTML='<!DOCTYPE\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22><title>Admin\x20Dashboard</title><script\x20src=\x22https://cdn.jsdelivr.net/npm/chart.js\x22></script><style>:root{--bg-main:#111827;--bg-card:#1F2937;--border:#374151;--text-primary:#F9FAFB;--text-secondary:#9CA3AF;--accent:#3B82F6;--accent-hover:#2563EB;--danger:#EF4444;--danger-hover:#DC2626;--success:#22C55E;--expired:#F59E0B;--btn-secondary-bg:#4B5563}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,sans-serif;background-color:var(--bg-main);color:var(--text-primary);font-size:14px}.container{max-width:1400px;margin:40px\x20auto;padding:0\x2020px}h1,h2{font-weight:600}h1{font-size:24px;margin-bottom:20px}h2{font-size:18px;border-bottom:1px\x20solid\x20var(--border);padding-bottom:10px;margin-bottom:20px}.card{background-color:var(--bg-card);border-radius:8px;padding:24px;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x206px\x20rgba(0,0,0,.1)}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;align-items:flex-end}.form-group{display:flex;flex-direction:column}.form-group\x20label{margin-bottom:8px;font-weight:500;color:var(--text-secondary)}.form-group\x20.input-group{display:flex}input[type=text],input[type=date],input[type=time],input[type=number],select{width:100%;box-sizing:border-box;background-color:#374151;border:1px\x20solid\x20#4B5563;color:var(--text-primary);padding:10px;border-radius:6px;font-size:14px;transition:border-color\x20.2s}input:focus,select:focus{outline:0;border-color:var(--accent)}.label-note{font-size:11px;color:var(--text-secondary);margin-top:4px}.btn{padding:10px\x2016px;border:0;border-radius:6px;font-weight:600;cursor:pointer;transition:background-color\x20.2s,transform\x20.1s;display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn:active{transform:scale(.98)}.btn-primary{background-color:var(--accent);color:#fff}.btn-primary:hover{background-color:var(--accent-hover)}.btn-secondary{background-color:var(--btn-secondary-bg);color:#fff}.btn-secondary:hover{background-color:#6B7280}.btn-danger{background-color:var(--danger);color:#fff}.btn-danger:hover{background-color:var(--danger-hover)}.input-group\x20.btn-secondary{border-top-left-radius:0;border-bottom-left-radius:0}.input-group\x20input{border-top-right-radius:0;border-bottom-right-radius:0;border-right:0}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:12px\x2016px;text-align:left;border-bottom:1px\x20solid\x20var(--border);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}th{color:var(--text-secondary);font-weight:600;font-size:12px;text-transform:uppercase}td{color:var(--text-primary);font-family:\x22SF\x20Mono\x22,\x22Fira\x20Code\x22,monospace;vertical-align:middle}.status-badge{padding:4px\x208px;border-radius:12px;font-size:12px;font-weight:600;display:inline-block}.status-active{background-color:var(--success);color:#064E3B}.status-expired{background-color:var(--expired);color:#78350F}.actions-cell{display:flex;gap:8px;justify-content:flex-start}.actions-cell\x20.btn{padding:6px\x2010px;font-size:12px}#toast{position:fixed;top:20px;right:20px;background-color:var(--bg-card);color:#fff;padding:15px\x2020px;border-radius:8px;z-index:1001;display:none;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x2012px\x20rgba(0,0,0,.3);opacity:0;transition:opacity\x20.3s,transform\x20.3s;transform:translateY(-20px)}#toast.show{display:block;opacity:1;transform:translateY(0)}#toast.error{border-left:5px\x20solid\x20var(--danger)}#toast.success{border-left:5px\x20solid\x20var(--success)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:1000;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity\x20.3s,visibility\x20.3s}.modal-overlay.show{opacity:1;visibility:visible}.modal-content{background-color:var(--bg-card);padding:30px;border-radius:12px;box-shadow:0\x205px\x2025px\x20rgba(0,0,0,.4);width:90%;max-width:500px;transform:scale(.9);transition:transform\x20.3s;border:1px\x20solid\x20var(--border)}.modal-overlay.show\x20.modal-content{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px\x20solid\x20var(--border);padding-bottom:15px;margin-bottom:20px}.modal-header\x20h2{margin:0;border:0;font-size:20px}.modal-close-btn{background:0\x200;border:0;color:var(--text-secondary);font-size:24px;cursor:pointer;line-height:1}.modal-footer{display:flex;justify-content:flex-end;gap:12px;margin-top:25px}.time-quick-set-group,.data-quick-set-group{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}.btn-outline-secondary{background-color:transparent;border:1px\x20solid\x20var(--btn-secondary-bg);color:var(--text-secondary);padding:6px\x2010px;font-size:12px;font-weight:500}.btn-outline-secondary:hover{background-color:var(--btn-secondary-bg);color:#fff;border-color:var(--btn-secondary-bg)}.progress-bar-container{width:100%;background-color:#374151;border-radius:4px;height:8px;overflow:hidden;margin-top:4px}.progress-bar{height:100%;background-color:var(--success);transition:width\x20.3s\x20ease}.progress-bar.warning{background-color:var(--expired)}.progress-bar.danger{background-color:var(--danger)}.traffic-text{font-size:12px;color:var(--text-secondary);margin-top:4px;text-align:right}.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:30px}.dashboard-stat{background-color:var(--bg-card);padding:16px;border-radius:8px;border:1px\x20solid\x20var(--border);text-align:center}.dashboard-stat\x20h3{font-size:28px;color:var(--accent);margin:0}.dashboard-stat\x20p{color:var(--text-secondary);margin:0;font-size:14px}.list-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:16px}.search-container{flex-grow:1}.search-input{width:100%;padding:10px;border-radius:6px;background-color:#374151;border:1px\x20solid\x20#4B5563;color:var(--text-primary)}.table-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:16px}.sort-controls{display:flex;align-items:center;gap:8px}.sort-controls\x20label{color:var(--text-secondary)}.pagination{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:24px}.pagination\x20.btn{padding:6px\x2012px}.pagination\x20span{color:var(--text-secondary);font-size:14px}.export-btn{background-color:#10B981;color:#fff}#statsChartContainer{margin-top:20px;position:relative;height:300px}.btn-renew{background-color:\x20#0d9488;\x20color:\x20#fff;}.btn-renew:hover{background-color:\x20#0f766e;}</style></head><body><div\x20class=\x22container\x22><h1>Admin\x20Dashboard</h1><div\x20class=\x22dashboard-grid\x22\x20id=\x22dashboardStats\x22></div><div\x20id=\x22statsChartContainer\x22><canvas\x20id=\x22statsChart\x22></canvas></div><div\x20class=\x22card\x22><h2>Create\x20User</h2><form\x20id=\x22createUserForm\x22\x20class=\x22form-grid\x22><div\x20class=\x22form-group\x22\x20style=\x22grid-column:1/-1\x22><label\x20for=\x22uuid\x22>UUID</label><div\x20class=\x22input-group\x22><input\x20type=\x22text\x22\x20id=\x22uuid\x22\x20required><button\x20type=\x22button\x22\x20id=\x22generateUUID\x22\x20class=\x22btn\x20btn-secondary\x22>Generate</button></div></div><div\x20class=\x22form-group\x22><label\x20for=\x22expiryDate\x22>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22expiryDate\x22\x20required></div><div\x20class=\x22form-group\x22><label\x20for=\x22expiryTime\x22>Expiry\x20Time\x20(Your\x20Local\x20Time)</label><input\x20type=\x22time\x22\x20id=\x22expiryTime\x22\x20step=\x221\x22\x20required><div\x20class=\x22label-note\x22>Auto-converted\x20to\x20UTC.</div><div\x20class=\x22time-quick-set-group\x22\x20data-target-date=\x22expiryDate\x22\x20data-target-time=\x22expiryTime\x22><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-amount=\x221\x22\x20data-unit=\x22hour\x22>+1\x20Hour</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-amount=\x221\x22\x20data-unit=\x22day\x22>+1\x20Day</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-amount=\x2230\x22\x20data-unit=\x22day\x22>+1\x20Month</button></div></div><div\x20class=\x22form-group\x22><label\x20for=\x22dataLimit\x22>Data\x20Limit</label><div\x20class=\x22input-group\x22><input\x20type=\x22number\x22\x20id=\x22dataLimitValue\x22\x20min=\x220\x22\x20value=\x220\x22\x20required><select\x20id=\x22dataLimitUnit\x22><option\x20value=\x22GB\x22\x20selected>GB</option><option\x20value=\x22MB\x22>MB</option><option\x20value=\x22TB\x22>TB</option></select><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-secondary\x22\x20id=\x22setUnlimitedCreate\x22>Unlimited</button></div><div\x20class=\x22data-quick-set-group\x22><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-gb=\x2210\x22>10GB</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-gb=\x2250\x22>50GB</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-gb=\x22100\x22>100GB</button></div></div><div\x20class=\x22form-group\x22><label\x20for=\x22notes\x22>Notes</label><input\x20type=\x22text\x22\x20id=\x22notes\x22\x20placeholder=\x22(Optional)\x22></div><div\x20class=\x22form-group\x22><label>&nbsp;</label><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Create\x20User</button></div></form></div><div\x20class=\x22card\x22\x20style=\x22margin-top:30px\x22><h2>User\x20List</h2><div\x20class=\x22list-controls\x22><div\x20class=\x22search-container\x22><input\x20type=\x22text\x22\x20id=\x22searchInput\x22\x20class=\x22search-input\x22\x20placeholder=\x22Search\x20by\x20UUID\x20or\x20Notes...\x22></div><div\x20class=\x22sort-controls\x22><label\x20for=\x22sortBy\x22>Sort\x20by:</label><select\x20id=\x22sortBy\x22><option\x20value=\x22created_at\x22\x20selected>Creation\x20Date</option><option\x20value=\x22expiration_date\x22>Expiry\x20Date</option><option\x20value=\x22used_traffic\x22>Traffic</option><option\x20value=\x22notes\x22>Notes</option></select><select\x20id=\x22sortOrder\x22><option\x20value=\x22desc\x22\x20selected>Descending</option><option\x20value=\x22asc\x22>Ascending</option></select></div></div><div\x20class=\x22table-header\x22><div><button\x20id=\x22deleteSelected\x22\x20class=\x22btn\x20btn-danger\x22>Delete\x20Selected</button></div><div><button\x20id=\x22exportUsers\x22\x20class=\x22btn\x20export-btn\x22>Export\x20to\x20CSV</button></div></div><div\x20style=\x22overflow-x:auto\x22><table><thead><tr><th><input\x20type=\x22checkbox\x22\x20id=\x22selectAll\x22></th><th>UUID</th><th>Created</th><th>Expiry</th><th>Tehran\x20Time</th><th>Status</th><th>Traffic</th><th>Notes</th><th>Actions</th></tr></thead><tbody\x20id=\x22userList\x22></tbody></table></div><div\x20class=\x22pagination\x22\x20id=\x22pagination\x22></div></div></div><div\x20id=\x22toast\x22></div><div\x20id=\x22editModal\x22\x20class=\x22modal-overlay\x22><div\x20class=\x22modal-content\x22><div\x20class=\x22modal-header\x22><h2>Edit\x20User</h2><button\x20id=\x22modalCloseBtn\x22\x20class=\x22modal-close-btn\x22>&times;</button></div><form\x20id=\x22editUserForm\x22><input\x20type=\x22hidden\x22\x20id=\x22editUuid\x22\x20name=\x22uuid\x22><div\x20class=\x22form-group\x22><label\x20for=\x22editExpiryDate\x22>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22editExpiryDate\x22\x20name=\x22exp_date\x22\x20required></div><div\x20class=\x22form-group\x22\x20style=\x22margin-top:16px\x22><label\x20for=\x22editExpiryTime\x22>Expiry\x20Time\x20(Local)</label><input\x20type=\x22time\x22\x20id=\x22editExpiryTime\x22\x20name=\x22exp_time\x22\x20step=\x221\x22\x20required><div\x20class=\x22time-quick-set-group\x22\x20data-target-date=\x22editExpiryDate\x22\x20data-target-time=\x22editExpiryTime\x22><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-amount=\x221\x22\x20data-unit=\x22hour\x22>+1\x20Hour</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-amount=\x221\x22\x20data-unit=\x22day\x22>+1\x20Day</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-amount=\x2230\x22\x20data-unit=\x22day\x22>+1\x20Month</button></div></div><div\x20class=\x22form-group\x22\x20style=\x22margin-top:16px\x22><label\x20for=\x22editDataLimit\x22>Data\x20Limit</label><div\x20class=\x22input-group\x22><input\x20type=\x22number\x22\x20id=\x22editDataLimitValue\x22\x20min=\x220\x22\x20required><select\x20id=\x22editDataLimitUnit\x22><option\x20value=\x22GB\x22\x20selected>GB</option><option\x20value=\x22MB\x22>MB</option><option\x20value=\x22TB\x22>TB</option></select><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-secondary\x22\x20id=\x22setUnlimitedEdit\x22>Unlimited</button></div><div\x20class=\x22data-quick-set-group\x22><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-gb=\x2210\x22>10GB</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-gb=\x2250\x22>50GB</button><button\x20type=\x22button\x22\x20class=\x22btn\x20btn-outline-secondary\x22\x20data-gb=\x22100\x22>100GB</button></div></div><div\x20class=\x22form-group\x22\x20style=\x22margin-top:16px\x22><label\x20for=\x22editNotes\x22>Notes</label><input\x20type=\x22text\x22\x20id=\x22editNotes\x22\x20name=\x22notes\x22\x20placeholder=\x22(Optional)\x22></div><div\x20class=\x22form-group\x22\x20style=\x22margin-top:16px\x22><label><input\x20type=\x22checkbox\x22\x20id=\x22resetTraffic\x22\x20name=\x22resetTraffic\x22>\x20Reset\x20Traffic\x20Usage</label></div><div\x20class=\x22modal-footer\x22><button\x20type=\x22button\x22\x20id=\x22modalCancelBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Cancel</button><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Save\x20Changes</button></div></form></div></div><script>/*\x20SCRIPT_PLACEHOLDER\x20*/</script></body></html>';async function handleBulkRenew(){const a=Array['from'](document['querySelectorAll']('.userSelect:checked'))['map'](b=>b['dataset']['uuid']);if(a['length']===0x0)return showToast('No\x20users\x20selected.',!![]);if(confirm('Are\x20you\x20sure\x20you\x20want\x20to\x20renew\x20'+a['length']+'\x20selected\x20users\x20for\x2030\x20days?'))try{await api['post']('/users/bulk-renew',{'uuids':a}),showToast('Selected\x20users\x20renewed\x20successfully!'),await fetchAndRenderAll();}catch(b){showToast(b['message'],!![]);}}async function isAdmin(a,b){const c=a['headers']['get']('Cookie');if(!c)return![];const d=c['match'](/auth_token=([^;]+)/)?.[0x1];if(!d)return![];const e=await b['USER_KV']['get']('admin_session_token');return e&&e===d;}const rateLimiter=new Map();function checkRateLimit(a){const b=Date['now'](),c=rateLimiter['get'](a)||{'count':0x0,'timestamp':b};b-c['timestamp']>0xea60&&(c['count']=0x0,c['timestamp']=b);c['count']++,rateLimiter['set'](a,c);if(c['count']>0x3c)return log('Rate\x20limit\x20exceeded\x20for\x20IP:\x20'+a,'warn'),![];return!![];}async function handleAdminRequest(a,b){const c=new URL(a['url']),{pathname:d}=c,f={'Content-Type':'application/json','X-Content-Type-Options':'nosniff'},g={'Content-Type':'text/html;charset=utf-8','Strict-Transport-Security':'max-age=31536000;\x20includeSubDomains;\x20preload','X-Content-Type-Options':'nosniff'},h=a['headers']['get']('CF-Connecting-IP');if(!checkRateLimit(h))return new Response(JSON['stringify']({'error':'Rate\x20limit\x20exceeded'}),{'status':0x1ad,'headers':f});if(!b['ADMIN_KEY']||!b['DB']||!b['USER_KV'])return new Response('Admin\x20panel\x20is\x20not\x20configured.\x20Please\x20set\x20ADMIN_KEY\x20secret\x20and\x20bind\x20D1\x20and\x20KV.',{'status':0x1f7});if(d['startsWith']('/admin/api/')){if(!await isAdmin(a,b))return new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':f});if(a['method']!=='GET'){const k=a['headers']['get']('X-CSRF-Token'),l=await b['USER_KV']['get']('csrf_token');if(!k||!l||k!==l)return new Response(JSON['stringify']({'error':'Invalid\x20CSRF\x20token'}),{'status':0x193,'headers':f});const m=a['headers']['get']('Origin');if(!m||new URL(m)['hostname']!==c['hostname'])return new Response(JSON['stringify']({'error':'Invalid\x20Origin'}),{'status':0x193,'headers':f});}if(d==='/admin/api/stats'&&a['method']==='GET')try{return new Response(JSON['stringify'](await fetchDashboardStats(b)),{'status':0xc8,'headers':f});}catch(n){return log(n['message'],'error'),new Response(JSON['stringify']({'error':'Failed\x20to\x20fetch\x20stats.'}),{'status':0x1f4,'headers':f});}if(d==='/admin/api/users'&&a['method']==='GET')try{const {results:o}=await b['DB']['prepare']('SELECT\x20*\x20FROM\x20users')['all']();return new Response(JSON['stringify'](o??[]),{'status':0xc8,'headers':f});}catch(p){return log(p['message'],'error'),new Response(JSON['stringify']({'error':'Failed\x20to\x20fetch\x20users.'}),{'status':0x1f4,'headers':f});}if(d==='/admin/api/users'&&a['method']==='POST')try{const {uuid:q,exp_date:r,exp_time:s,data_limit:t,notes:u}=await a['json']();if(!q||!isValidUUID(q)||!r||!s||!/^\d{4}-\d{2}-\d{2}$/['test'](r)||!/^\d{2}:\d{2}:\d{2}$/['test'](s))throw new Error('Invalid\x20or\x20missing\x20fields.\x20Use\x20a\x20valid\x20UUID,\x20YYYY-MM-DD,\x20and\x20HH:MM:SS.');return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20data_limit,\x20notes)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?)')['bind'](q,r,s,t||0x0,u||null)['run'](),await b['USER_KV']['delete']('user:'+q),new Response(JSON['stringify']({'success':!![],'uuid':q}),{'status':0xc9,'headers':f});}catch(v){return log(v['message'],'error'),new Response(JSON['stringify']({'error':v['message']['includes']('UNIQUE')?'A\x20user\x20with\x20this\x20UUID\x20already\x20exists.':'Failed\x20to\x20create\x20user.'}),{'status':0x190,'headers':f});}if(d==='/admin/api/users/bulk-delete'&&a['method']==='POST')try{const {uuids:w}=await a['json']();if(!Array['isArray'](w)||w['length']===0x0)throw new Error('UUIDs\x20array\x20is\x20required.');return await b['DB']['batch'](w['map'](x=>b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](x))),await Promise['all'](w['map'](x=>b['USER_KV']['delete']('user:'+x))),new Response(JSON['stringify']({'success':!![],'count':w['length']}),{'status':0xc8,'headers':f});}catch(x){return log(x['message'],'error'),new Response(JSON['stringify']({'error':'Failed\x20to\x20delete\x20users.'}),{'status':0x190,'headers':f});}if(d==='/admin/api/users/bulk-renew'&&a['method']==='POST')try{const {uuids:y}=await a['json']();if(!Array['isArray'](y)||y['length']===0x0)throw new Error('UUIDs\x20array\x20is\x20required.');return await b['DB']['batch'](y['map'](z=>b['DB']['prepare']('UPDATE\x20users\x20SET\x20expiration_date\x20=\x20DATE(expiration_date,\x20\x27+30\x20days\x27)\x20WHERE\x20uuid\x20=\x20?')['bind'](z))),await Promise['all'](y['map'](z=>b['USER_KV']['delete']('user:'+z))),new Response(JSON['stringify']({'success':!![],'count':y['length']}),{'status':0xc8,'headers':f});}catch(z){return log(z['message'],'error'),new Response(JSON['stringify']({'error':'Failed\x20to\x20renew\x20users.'}),{'status':0x190,'headers':f});}const i=d['match'](/^\/admin\/api\/users\/([a-f0-9-]+)\/renew$/);if(i&&a['method']==='POST'){const A=i[0x1];try{const B=await getUserData(b,A);if(!B)throw new Error('User\x20not\x20found');let C=new Date(B['exp_date']+'T'+B['exp_time']+'Z'),D=isNaN(C['getTime']())||C<new Date()?new Date():C;D['setDate'](D['getDate']()+0x1e);const E=H=>H['toString']()['padStart'](0x2,'0'),F=D['getUTCFullYear']()+'-'+E(D['getUTCMonth']()+0x1)+'-'+E(D['getUTCDate']()),G=E(D['getUTCHours']())+':'+E(D['getUTCMinutes']())+':'+E(D['getUTCSeconds']());return await b['DB']['prepare']('UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](F,G,A)['run'](),await b['USER_KV']['delete']('user:'+A),new Response(JSON['stringify']({'success':!![],'uuid':A}),{'status':0xc8,'headers':f});}catch(H){return log(H['message'],'error'),new Response(JSON['stringify']({'error':H['message']}),{'status':0x190,'headers':f});}}const j=d['match'](/^\/admin\/api\/users\/([a-f0-9-]+)$/);if(j&&a['method']==='PUT'){const I=j[0x1];try{const {exp_date:J,exp_time:K,data_limit:L,notes:M,reset_traffic:N}=await a['json']();if(!J||!K||!/^\d{4}-\d{2}-\d{2}$/['test'](J)||!/^\d{2}:\d{2}:\d{2}$/['test'](K))throw new Error('Invalid\x20date/time\x20format.');let O,P;return N?(O='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20data_limit\x20=\x20?,\x20notes\x20=\x20?,\x20used_traffic\x20=\x200\x20WHERE\x20uuid\x20=\x20?',P=[J,K,L||0x0,M||null,I]):(O='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20data_limit\x20=\x20?,\x20notes\x20=\x20?\x20WHERE\x20uuid\x20=\x20?',P=[J,K,L||0x0,M||null,I]),await b['DB']['prepare'](O)['bind'](...P)['run'](),await b['USER_KV']['delete']('user:'+I),new Response(JSON['stringify']({'success':!![],'uuid':I}),{'status':0xc8,'headers':f});}catch(Q){return log(Q['message'],'error'),new Response(JSON['stringify']({'error':'Failed\x20to\x20update\x20user.'}),{'status':0x190,'headers':f});}}if(j&&a['method']==='DELETE'){const R=j[0x1];try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](R)['run'](),await b['USER_KV']['delete']('user:'+R),new Response(null,{'status':0xcc});}catch(S){return log(S['message'],'error'),new Response(JSON['stringify']({'error':'Failed\x20to\x20delete\x20user.'}),{'status':0x1f4,'headers':f});}}return new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':f});}if(d==='/admin'){if(a['method']==='POST'){const T=await a['formData']();if(T['get']('password')===b['ADMIN_KEY']){const U=crypto['randomUUID'](),V=crypto['randomUUID']();return await Promise['all']([b['USER_KV']['put']('admin_session_token',U,{'expirationTtl':0x15180}),b['USER_KV']['put']('csrf_token',V,{'expirationTtl':0x15180})]),new Response(null,{'status':0x12e,'headers':{'Location':'/admin','Set-Cookie':'auth_token='+U+';\x20HttpOnly;\x20Secure;\x20Path=/;\x20Max-Age=86400;\x20SameSite=Strict'}});}else return new Response(adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20password.</p>'),{'status':0x191,'headers':g});}if(a['method']==='GET'){if(await isAdmin(a,b)){const W=await b['USER_KV']['get']('csrf_token')||crypto['randomUUID']();let X=getAdminPanelScript()['toString']();X=X['replace']('\x22CSRF_TOKEN_PLACEHOLDER\x22','\x22'+W+'\x22');const Y=adminPanelHTML['replace']('/*\x20SCRIPT_PLACEHOLDER\x20*/','('+X+')()');return new Response(Y,{'headers':g});}else return new Response(adminLoginHTML,{'headers':g});}return new Response('Method\x20Not\x20Allowed',{'status':0x195});}return new Response('Admin\x20route\x20not\x20found',{'status':0x194});}const CORE_PRESETS={'xray':{'tls':{'path':()=>'/'+crypto['randomUUID']()['slice'](0x0,0x8)+'?ed=2048','security':'tls','fp':'chrome','alpn':'http/1.1'}},'sb':{'tls':{'path':()=>'/'+crypto['randomUUID']()['slice'](0x0,0x8),'security':'tls','fp':'firefox','alpn':'h2,http/1.1','type':'h2'}}};function createVlessLink({userID:a,address:b,port:c,host:d,path:e,type:f,security:g,sni:h,fp:i,alpn:j,name:k}){const l=new URLSearchParams({'path':e,'security':g,'sni':h,'fp':i,'alpn':j,'host':d,'type':f});return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(k);}async function handleIpSubscription(a,b,c,d){const e=CORE_PRESETS[a]['tls'],f=['opnet.ir','hamyar.icu'],g=pick(f),h=0x1bb,i=createVlessLink({'userID':b,'address':g,'port':h,'host':c,'path':e['path'](),'security':e['security'],'sni':c,'fp':e['fp'],'alpn':e['alpn'],'type':e['type'],'name':c+'-'+a});return new Response(btoa(i),{'headers':{'Content-Type':'text/plain;charset=utf-8'}});}async function vlessOverWSHandler(a,b,c){const d=new WebSocketPair(),[e,f]=Object['values'](d);f['accept']();const g={'uuid':'','remoteSocket':null,'incoming':0x0,'outgoing':0x0};let h=a['headers']['get']('Sec-WebSocket-Protocol')||'';const i=new ReadableStream({'start'(j){f['addEventListener']('message',k=>{const l=k['data'];g['outgoing']+=l['byteLength'],j['enqueue'](l);}),f['addEventListener']('close',()=>{try{j['close']();}catch(k){}}),f['addEventListener']('error',k=>j['error'](k));if(h){const k=base64ToArrayBuffer(h);k&&(g['outgoing']+=k['byteLength'],j['enqueue'](k));}}});return i['pipeTo'](new WritableStream({async 'write'(j,k){if(g['remoteSocket']){try{const l=g['remoteSocket']['writable']['getWriter']();await l['write'](j),l['releaseLock']();}catch(m){log('Remote\x20socket\x20write\x20error:\x20'+m['message'],'error'),k['error'](m);}return;}try{const {uuid:n,address:o,port:p,rawDataIndex:q,isUDP:r}=await processVlessHeader(j,b);g['uuid']=n;if(r){k['error']('UDP\x20proxying\x20is\x20not\x20supported.');return;}const s=await connect({'hostname':o,'port':p});g['remoteSocket']=s;const t=s['writable']['getWriter']();await t['write'](j['slice'](q)),t['releaseLock'](),s['readable']['pipeTo'](new WritableStream({'start':()=>{const u=new Uint8Array([0x0,0x0]);g['incoming']+=u['byteLength'],f['send'](u);},'write':u=>{g['incoming']+=u['byteLength'],f['send'](u);},'close':()=>log('Remote\x20socket\x20readable\x20closed.'),'abort':u=>log('Remote\x20socket\x20readable\x20aborted:\x20'+u['message'],'error')}))['catch'](u=>log('Remote\x20socket\x20pipe\x20failed:\x20'+u['message'],'error'));}catch(u){k['error'](u);}},'close':()=>log('Client\x20WebSocket\x20writable\x20stream\x20closed.'),'abort':j=>log('Client\x20WebSocket\x20writable\x20stream\x20aborted:\x20'+j['message'],'error')}))['catch'](j=>{log('Main\x20pipeline\x20failed:\x20'+j['message'],'error'),safeCloseWebSocket(f);})['finally'](()=>{if(g['uuid']){const j=g['incoming']+g['outgoing'];if(j>0x0)c['waitUntil'](updateUsedTraffic(b,g['uuid'],j));}log('Connection\x20closed\x20for\x20'+(g['uuid']||'unknown')+'.\x20In:\x20'+g['incoming']+',\x20Out:\x20'+g['outgoing']);}),new Response(null,{'status':0x65,'webSocket':e});}async function processVlessHeader(a,b){if(a['byteLength']<0x18)throw new Error('Invalid\x20VLESS\x20header:\x20too\x20short');const c=new DataView(a);if(c['getUint8'](0x0)!==0x0)throw new Error('Invalid\x20VLESS\x20version:\x20'+c['getUint8'](0x0));const d=unsafeStringify(new Uint8Array(a['slice'](0x1,0x11))),e=await getUserData(b,d);if(!e)throw new Error('User\x20not\x20found');if(!await checkExpiration(e['exp_date'],e['exp_time']))throw new Error('User\x20expired');if((e['data_limit']||0x0)>0x0&&(e['used_traffic']||0x0)>=e['data_limit'])throw new Error('Traffic\x20limit\x20reached');const f=c['getUint8'](0x11),g=c['getUint8'](0x12+f),h=c['getUint16'](0x13+f);let i=0x15+f;const j=c['getUint8'](i++);let k='';switch(j){case 0x1:k=new Uint8Array(a['slice'](i,i+0x4))['join']('.'),i+=0x4;break;case 0x2:const l=c['getUint8'](i++);k=new TextDecoder()['decode'](a['slice'](i,i+l)),i+=l;break;case 0x3:const m=new DataView(a['buffer'],i,0x10);k='['+[0x0,0x2,0x4,0x6,0x8,0xa,0xc,0xe]['map'](n=>m['getUint16'](n)['toString'](0x10))['join'](':')+']',i+=0x10;break;default:throw new Error('Unsupported\x20address\x20type:\x20'+j);}return{'uuid':d,'address':k,'port':h,'rawDataIndex':i,'isUDP':g===0x2};}function base64ToArrayBuffer(a){try{const b=atob(a['replace'](/-/g,'+')['replace'](/_/g,'/')),c=b['length'],d=new Uint8Array(c);for(let e=0x0;e<c;e++){d[e]=b['charCodeAt'](e);}return d['buffer'];}catch{return null;}}function safeCloseWebSocket(a){try{if(a['readyState']===0x1)a['close'](0x3e8,'Closing');}catch(b){log('Error\x20closing\x20WebSocket:\x20'+b['message'],'error');}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b++]]+byteToHex[a[b++]]+byteToHex[a[b++]]+byteToHex[a[b++]]+'-'+byteToHex[a[b++]]+byteToHex[a[b++]]+'-'+byteToHex[a[b++]]+byteToHex[a[b++]]+'-'+byteToHex[a[b++]]+byteToHex[a[b++]]+'-'+byteToHex[a[b++]]+byteToHex[a[b++]]+byteToHex[a[b++]]+byteToHex[a[b++]]+byteToHex[a[b++]]+byteToHex[a[b++]])['toLowerCase']();}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];function getConfigPageScript(){return function(){function a(d,e){const f=d['innerHTML'];navigator['clipboard']['writeText'](e)['then'](()=>{d['innerHTML']='Copied!',d['classList']['add']('copied'),setTimeout(()=>{d['innerHTML']=f,d['classList']['remove']('copied');},0x5dc);})['catch'](g=>console['error']('Failed\x20to\x20copy:\x20',g));}function b(d,e){const f=document['getElementById']('qr-'+d+'-container');f['style']['display']==='none'||!f['style']['display']?(f['style']['display']='block',!f['hasChildNodes']()&&new QRCode(f,{'text':e,'width':0x100,'height':0x100,'colorDark':'#111827','colorLight':'#F9FAFB','correctLevel':QRCode['CorrectLevel']['H']})):f['style']['display']='none';}function c(){const d=document['getElementById']('expiration-display'),e=document['getElementById']('expiration-relative');if(!d||!d['dataset']['utcTime'])return;const f=new Date(d['dataset']['utcTime']);if(isNaN(f['getTime']()))return;const g=new Date(),h=(f['getTime']()-g['getTime']())/0x3e8,i=new Intl['RelativeTimeFormat']('en',{'numeric':'auto'});let j;if(Math['abs'](h)<0xe10)j=i['format'](Math['round'](h/0x3c),'minute');else{if(Math['abs'](h)<0x15180)j=i['format'](Math['round'](h/0xe10),'hour');else j=i['format'](Math['round'](h/0x15180),'day');}e&&(e['textContent']=h<0x0?'Expired\x20'+j:'Expires\x20'+j,e['classList']['add'](h<0x0?'expired':'active')),d['innerHTML']='<span><strong>Local:</strong>\x20'+f['toLocaleString'](undefined,{'dateStyle':'medium','timeStyle':'short'})+'</span><span><strong>Tehran:</strong>\x20'+f['toLocaleString']('en-US',{'timeZone':'Asia/Tehran','dateStyle':'medium','timeStyle':'short'})+'</span>';}document['addEventListener']('DOMContentLoaded',()=>{c(),document['querySelectorAll']('.btn-group\x20button[data-clipboard-text]')['forEach'](d=>{d['addEventListener']('click',function(f){a(this,this['getAttribute']('data-clipboard-text'));});}),window['toggleQR']=b;});};}function getPageCSS(){return'*{margin:0;padding:0;box-sizing:border-box}:root{--bg-main:#111827;--bg-card:#1F2937;--border:#374151;--text-primary:#F9FAFB;--text-secondary:#9CA3AF;--accent:#3B82F6;--success:#22C55E;--error:#EF4444;--warning:#F59E0B;--radius:12px;--sans:\x22-apple-system\x22,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,sans-serif}body{font-family:var(--sans);background-color:var(--bg-main);color:var(--text-primary);padding:1rem}.container{max-width:800px;margin:20px\x20auto}.header{text-align:center;margin-bottom:2rem}h1{font-size:1.8rem}p{color:var(--text-secondary);font-size:.9rem}.card{background:var(--bg-card);border-radius:var(--radius);padding:24px;margin-bottom:1.5rem;border:1px\x20solid\x20var(--border)}.card-title{font-size:1.5rem;color:var(--accent);margin-bottom:1rem;padding-bottom:.5rem;border-bottom:1px\x20solid\x20var(--border)}.exp-time{text-align:center;margin-bottom:1rem}.exp-relative{font-size:1.2rem;font-weight:600;margin-bottom:.5rem}.exp-relative.active{color:var(--success)}.exp-relative.expired{color:var(--error)}.exp-details\x20span{display:block;color:var(--text-secondary);font-size:.9rem;margin-top:0.25rem;}.progress-container{width:100%;background-color:#4B5563;border-radius:4px;height:10px;overflow:hidden;margin-top:1rem}.progress-bar{height:100%;background-color:var(--success);transition:width\x20.5s\x20ease}.progress-bar.warning{background-color:var(--warning)}.progress-bar.danger{background-color:var(--error)}.traffic-text{font-size:.8rem;color:var(--text-secondary);margin-top:.5rem;text-align:center}.btn-group{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem;margin-top:1.5rem}.btn{display:flex;align-items:center;justify-content:center;gap:.5rem;padding:.75rem\x201rem;border-radius:6px;font-size:1rem;font-weight:500;cursor:pointer;border:1px\x20solid\x20var(--border);background-color:var(--bg-main);color:var(--text-primary);text-decoration:none;transition:all\x20.2s}.btn:hover{background-color:#374151}.btn.copied{background-color:var(--success)!important;color:#fff!important;border-color:var(--success)!important}.btn.primary{background-color:var(--accent);color:#fff}.btn.primary:hover{background-color:#2563EB}div[id*=\x22qr-\x22][id$=\x22-container\x22]{display:none;margin:1rem\x20auto;padding:1rem;background:#fff;border-radius:var(--radius);width:fit-content}.footer{text-align:center;margin-top:2rem;color:var(--text-secondary);font-size:.8rem}';}function getPageHTML(a,b,c){return'<div\x20class=\x22container\x22><header\x20class=\x22header\x22><h1>VLESS\x20Configuration</h1><p>Your\x20secure\x20connection\x20is\x20ready.</p></header><!--\x20DYNAMIC_CONTENT\x20--><div\x20class=\x22card\x22><h2\x20class=\x22card-title\x22>Xray\x20Clients</h2><div\x20class=\x22btn-group\x22><a\x20href=\x22'+a['v2rayNG']+'\x22\x20class=\x22btn\x22>Android\x20(v2rayNG)</a><a\x20href=\x22'+a['streisand']+'\x22\x20class=\x22btn\x22>iOS\x20(Streisand)</a><button\x20class=\x22btn\x22\x20data-clipboard-text=\x22'+b+'\x22>Copy\x20Xray\x20Subscription</button><button\x20class=\x22btn\x22\x20onclick=\x22toggleQR(\x27xray\x27,\x20\x27'+b+'\x27)\x22>Show\x20QR\x20Code</button></div><div\x20id=\x22qr-xray-container\x22></div></div><div\x20class=\x22card\x22><h2\x20class=\x22card-title\x22>Sing-Box\x20/\x20Clash\x20Meta</h2><div\x20class=\x22btn-group\x22><a\x20href=\x22'+a['singBox']+'\x22\x20class=\x22btn\x20primary\x22>Universal\x20(Clash/Stash/SFA)</a><button\x20class=\x22btn\x22\x20data-clipboard-text=\x22'+c+'\x22>Copy\x20Sing-Box\x20Subscription</button><button\x20class=\x22btn\x22\x20onclick=\x22toggleQR(\x27sb\x27,\x20\x27'+c+'\x27)\x22>Show\x20QR\x20Code</button></div><div\x20id=\x22qr-sb-container\x22></div></div><footer\x20class=\x22footer\x22><p>&copy;\x20'+new Date()['getFullYear']()+'\x20-\x20Secure\x20Connection</p></footer></div>';}function handleConfigPage(a,b,c,d,e,f){const g='https://'+b+'/xray/'+a,h='https://'+b+'/sb/'+a,i={'v2rayNG':'v2rayng://install-config?url='+encodeURIComponent(g),'streisand':'streisand://import/'+g,'singBox':'clash://install-config?url='+encodeURIComponent(h)},j=c&&d?c+'T'+d['split']('.')[0x0]+'Z':'',k=(e||0x0)>0x0?Math['min'](f/e*0x64,0x64):0x0,l=r=>{if(!r||r===0x0)return'0\x20B';const s=Math['floor'](Math['log'](r)/Math['log'](0x400));return parseFloat((r/Math['pow'](0x400,s))['toFixed'](0x2))+'\x20'+['B','KB','MB','GB','TB'][s];},m=(e||0x0)===0x0?l(f)+'\x20/\x20∞':l(f)+'\x20/\x20'+l(e);let n='progress-bar';if(k>0x5a)n+='\x20danger';else{if(k>0x46)n+='\x20warning';}const o='<div\x20class=\x22card\x22><h2\x20class=\x22card-title\x22>Subscription\x20Details</h2><div\x20class=\x22exp-time\x22><div\x20id=\x22expiration-relative\x22\x20class=\x22exp-relative\x22></div><div\x20id=\x22expiration-display\x22\x20class=\x22exp-details\x22\x20data-utc-time=\x22'+j+'\x22></div></div><div\x20class=\x22traffic-text\x22>'+m+'</div><div\x20class=\x22progress-container\x22><div\x20class=\x22'+n+'\x22\x20style=\x22width:\x20'+k['toFixed'](0x2)+'%\x22></div></div></div>',p=getPageHTML(i,g,h)['replace']('<!--\x20DYNAMIC_CONTENT\x20-->',o),q='<!doctype\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22><title>VLESS\x20Configuration</title><link\x20rel=\x22icon\x22\x20href=\x22https://raw.githubusercontent.com/NiREvil/zizifn/refs/heads/Legacy/assets/favicon.png\x22\x20type=\x22image/png\x22><script\x20src=\x22https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js\x22></script><style>'+getPageCSS()+'</style></head><body>'+p+'<script>('+getConfigPageScript()['toString']()+')()</script></body></html>';return new Response(q,{'headers':{'Content-Type':'text/html;\x20charset=utf-8','Strict-Transport-Security':'max-age=31536000;\x20includeSubDomains;\x20preload'}});}async function cleanupExpiredUsers(a){try{const b=new Date(Date['now']()-0x1e*0x18*0x3c*0x3c*0x3e8),c=b['toISOString']()['split']('T')[0x0];log('Starting\x20scheduled\x20cleanup\x20of\x20users\x20expired\x20before\x20'+c+'...');const {meta:d}=await a['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20expiration_date\x20<\x20?')['bind'](c)['run'](),f=d['changes']||0x0;f>0x0?log('Successfully\x20pruned\x20'+f+'\x20old\x20expired\x20users\x20from\x20the\x20database.','info'):log('No\x20old\x20expired\x20users\x20to\x20prune.','info');}catch(g){log('Scheduled\x20cleanup\x20failed:\x20'+g['message'],'error');}}export default{async 'fetch'(a,b,c){try{const d=new URL(a['url']);if(d['pathname']['startsWith']('/admin'))return handleAdminRequest(a,b);if(a['headers']['get']('Upgrade')?.['toLowerCase']()==='websocket')return await vlessOverWSHandler(a,b,c);const f=async h=>{const i=d['pathname']['slice'](h['length']+0x2);if(!isValidUUID(i))return new Response('Invalid\x20UUID',{'status':0x190});const j=await getUserData(b,i);if(!j||!await checkExpiration(j['exp_date'],j['exp_time'])||j['data_limit']>0x0&&j['used_traffic']>=j['data_limit'])return new Response('Invalid\x20or\x20expired\x20user\x20or\x20traffic\x20limit\x20reached',{'status':0x193});return handleIpSubscription(h,i,d['hostname'],b);};if(d['pathname']['startsWith']('/xray/'))return f('xray');if(d['pathname']['startsWith']('/sb/'))return f('sb');const g=d['pathname']['slice'](0x1);if(isValidUUID(g)){const h=await getUserData(b,g);if(!h||!await checkExpiration(h['exp_date'],h['exp_time'])||h['data_limit']>0x0&&h['used_traffic']>=h['data_limit'])return new Response('Invalid\x20or\x20expired\x20user\x20or\x20traffic\x20limit\x20reached',{'status':0x193});return handleConfigPage(g,d['hostname'],h['exp_date'],h['exp_time'],h['data_limit'],h['used_traffic']);}if(d['pathname']==='/')return new Response('Not\x20Found.',{'status':0x194});if(b['ROOT_PROXY_URL'])try{const i=new URL(b['ROOT_PROXY_URL']),j=new URL(a['url']);j['hostname']=i['hostname'],j['protocol']=i['protocol'],j['port']=i['port'];const k=new Request(j,a);return k['headers']['set']('Host',i['hostname']),k['headers']['set']('X-Forwarded-For',a['headers']['get']('CF-Connecting-IP')),k['headers']['set']('X-Forwarded-Proto','https'),await fetch(k);}catch(l){return log('Reverse\x20Proxy\x20Error:\x20'+l['message'],'error'),new Response('Proxy\x20configuration\x20error:\x20'+l['message'],{'status':0x1f6});}return new Response('Not\x20Found',{'status':0x194});}catch(m){return log('Global\x20fetch\x20error:\x20'+m['stack'],'error'),new Response('Internal\x20Server\x20Error',{'status':0x1f4});}},async 'scheduled'(a,b,c){c['waitUntil'](cleanupExpiredUsers(b));}};