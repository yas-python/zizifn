// <!--GAMFC--> version base on commit 888ab49eb3b38e6c2495eea4adef2a6f7d586488, time is 2025-10-24 13:44:09 UTC<!--We are all REvil-->
// @ts-ignore

import{connect}from'cloudflare:sockets';const Config={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','proxyIPs':[],'fromEnv'(a){let b=a['PROXYIP'];!b&&this['proxyIPs']['length']>0x0&&(b=this['proxyIPs'][Math['floor'](Math['random']()*this['proxyIPs']['length'])]);b=b||'';const [c,d='443']=b['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':c,'proxyPort':d,'proxyAddress':b,'adminPath':a['ADMIN_PATH']||'/admin','apiToken':a['API_TOKEN'],'rootProxyUrl':a['ROOT_PROXY_URL'],'scamalytics':{'username':a['SCAMALYTICS_USERNAME'],'apiKey':a['SCAMALYTICS_API_KEY'],'baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true','address':a['SOCKS5']||''}};}},CONST={'ED_PARAMS':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'},'VLESS_PROTOCOL':'vless','WS_READY_STATE_OPEN':0x1,'WS_READY_STATE_CLOSING':0x2};function isValidUUID(a){if(typeof a!=='string')return![];const b=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return b['test'](a);}function isExpired(a,b){if(!a||!b)return!![];const c=b['includes'](':')&&b['split'](':')['length']===0x2?b+':00':b,d=c['split']('.')[0x0],e=new Date(a+'T'+d+'Z');return e<=new Date();}function bytesToReadable(a){if(a<=0x0)return'0\x20Bytes';const b=Math['floor'](Math['log'](a)/Math['log'](0x400));return parseFloat((a/Math['pow'](0x400,b))['toFixed'](0x2))+'\x20'+['Bytes','KB','MB','GB','TB'][b];}async function getUserData(a,b,c){if(!isValidUUID(b))return null;if(!a['DB']||!a['USER_KV'])return console['error']('D1\x20or\x20KV\x20bindings\x20missing.'),null;const d='user:'+b;try{const h=await a['USER_KV']['get'](d,'json');if(h&&h['uuid'])return h;}catch(i){console['error']('KV\x20parse\x20error\x20for\x20'+b,i);}const f=await a['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](b)['first']();if(!f)return null;const g=a['USER_KV']['put'](d,JSON['stringify'](f),{'expirationTtl':0xe10});if(c)c['waitUntil'](g);else await g;return f;}const adminLoginHTML='<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20\x20\x20<meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22>\x0a\x20\x20\x20\x20<title>Admin\x20Login</title>\x0a\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;background-color:#111827;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,Helvetica,Arial,sans-serif}.login-container{background-color:#1F2937;padding:40px;border-radius:12px;box-shadow:0\x204px\x2020px\x20rgba(0,0,0,.5);text-align:center;width:320px;border:1px\x20solid\x20#374151}h1{color:#F9FAFB;margin-bottom:24px;font-weight:500}form{display:flex;flex-direction:column}input[type=password]{background-color:#374151;border:1px\x20solid\x20#4B5563;color:#F9FAFB;padding:12px;border-radius:8px;margin-bottom:20px;font-size:16px;transition:border-color\x20.2s,box-shadow\x20.2s}input[type=password]:focus{outline:none;border-color:#3B82F6;box-shadow:0\x200\x200\x203px\x20rgba(59,130,246,.3)}button{background-color:#3B82F6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:background-color\x20.2s}button:hover{background-color:#2563EB}.error{color:#EF4444;margin-top:15px;font-size:14px}\x0a\x20\x20\x20\x20</style>\x0a</head>\x0a<body><div\x20class=\x22login-container\x22><h1>Admin\x20Login</h1><form\x20method=\x22POST\x22><input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\x22\x20required><button\x20type=\x22submit\x22>Login</button></form></div></body>\x0a</html>',adminPanelHTML='<!DOCTYPE\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head>\x0a\x20\x20\x20\x20<meta\x20charset=\x22UTF-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22><title>Admin\x20Dashboard</title>\x0a\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20:root{--bg-main:#0c0a09;--bg-card:#1c1917;--bg-input:#292524;--border:#44403c;--text-primary:#f5f5f4;--text-secondary:#a8a29e;--accent:#fb923c;--accent-hover:#f97316;--danger:#ef4444;--danger-hover:#dc2626;--success:#4ade80;--expired:#facc15;--btn-secondary-bg:#57534e;--btn-secondary-hover:#78716c}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,sans-serif;background-color:var(--bg-main);color:var(--text-primary);font-size:14px}.container{max-width:1280px;margin:30px\x20auto;padding:0\x2020px}.card{background-color:var(--bg-card);border-radius:12px;padding:24px;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x2012px\x20rgba(0,0,0,.3)}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}.stat-card{background-color:var(--bg-card);border-radius:12px;padding:20px;border:1px\x20solid\x20var(--border);transition:transform\x20.2s,box-shadow\x20.2s}.stat-card:hover{transform:translateY(-5px);box-shadow:0\x208px\x2016px\x20rgba(0,0,0,.4)}.stat-title{font-size:14px;color:var(--text-secondary);margin:0\x200\x2010px}.stat-value{font-size:28px;font-weight:600;margin:0}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;align-items:flex-end}.form-group{display:flex;flex-direction:column}label{margin-bottom:8px;font-weight:500;color:var(--text-secondary)}.input-group{display:flex}input,select{width:100%;box-sizing:border-box;background-color:var(--bg-input);border:1px\x20solid\x20var(--border);color:var(--text-primary);padding:10px;border-radius:6px;font-size:14px;transition:border-color\x20.2s,box-shadow\x20.2s}input:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0\x200\x200\x203px\x20rgba(251,146,60,.3)}.btn{padding:10px\x2016px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all\x20.2s;display:inline-flex;align-items:center;justify-content:center;gap:8px}.btn:active{transform:scale(.97)}.btn-primary{background-color:var(--accent);color:var(--bg-main)}.btn-primary:hover{background-color:var(--accent-hover)}.btn-danger{background-color:var(--danger);color:#fff}.btn-danger:hover{background-color:var(--danger-hover)}.btn-secondary{background-color:var(--btn-secondary-bg);color:#fff}.btn-secondary:hover{background-color:var(--btn-secondary-hover)}.input-group\x20button{border-top-left-radius:0;border-bottom-left-radius:0}.input-group\x20input,.input-group\x20select{border-radius:0;border-right:none}.input-group\x20input:first-child,.input-group\x20select:first-child{border-top-left-radius:6px;border-bottom-left-radius:6px}.input-group\x20button:last-child,.input-group\x20select:last-child{border-top-right-radius:6px;border-bottom-right-radius:6px;border-right:1px\x20solid\x20var(--border)}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:12px\x2016px;text-align:left;border-bottom:1px\x20solid\x20var(--border);white-space:nowrap}th{color:var(--text-secondary);font-weight:600;font-size:12px;text-transform:uppercase}.status-badge{padding:4px\x2010px;border-radius:12px;font-size:12px;font-weight:600;display:inline-block}.status-active{background-color:rgba(74,222,128,.2);color:var(--success)}.status-expired{background-color:rgba(250,204,21,.2);color:var(--expired)}.actions-cell{display:flex;gap:8px;justify-content:flex-start}#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background-color:var(--bg-card);color:#fff;padding:15px\x2025px;border-radius:8px;z-index:1001;display:none;border:1px\x20solid\x20var(--border);box-shadow:0\x204px\x2012px\x20rgba(0,0,0,.3);opacity:0;transition:all\x20.3s}#toast.show{display:block;opacity:1;transform:translate(-50%,-10px)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);z-index:1000;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity\x20.3s,visibility\x20.3s}.modal-overlay.show{opacity:1;visibility:visible}.modal-content{background-color:var(--bg-card);padding:30px;border-radius:12px;width:90%;max-width:550px;transform:scale(.9);transition:transform\x20.3s;border:1px\x20solid\x20var(--border)}.modal-overlay.show\x20.modal-content{transform:scale(1)}.modal-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:15px;margin-bottom:20px;border-bottom:1px\x20solid\x20var(--border)}.modal-header\x20h2{margin:0;font-size:20px}.modal-close-btn{background:0\x200;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer}.modal-footer{display:flex;justify-content:flex-end;gap:12px;margin-top:25px}.traffic-bar{width:100%;background-color:var(--bg-input);border-radius:4px;height:6px;overflow:hidden;margin-top:4px}.traffic-bar-inner{height:100%;background-color:var(--accent);border-radius:4px;transition:width\x20.5s}.form-check{display:flex;align-items:center;margin-top:10px}.form-check\x20input{width:auto;margin-right:8px}@media\x20(max-width:768px){.container{padding:0\x2010px;margin-top:15px}.stats-grid{grid-template-columns:1fr\x201fr}.user-list-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch}table{min-width:800px}}\x0a\x20\x20\x20\x20</style>\x0a</head>\x0a<body>\x0a\x20\x20\x20\x20<div\x20class=\x22container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22stats\x22\x20class=\x22stats-grid\x22></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>Create\x20User</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<form\x20id=\x22createUserForm\x22\x20class=\x22form-grid\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22hidden\x22\x20id=\x22csrf_token\x22\x20name=\x22csrf_token\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22grid-column:1/-1\x22><label\x20for=\x22uuid\x22>UUID</label><div\x20class=\x22input-group\x22><input\x20type=\x22text\x22\x20id=\x22uuid\x22\x20required><button\x20type=\x22button\x22\x20id=\x22generateUUID\x22\x20class=\x22btn\x20btn-secondary\x22>Generate</button></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22expiryDate\x22>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22expiryDate\x22\x20required></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22expiryTime\x22>Expiry\x20Time\x20(Your\x20Local\x20Time)</label><input\x20type=\x22time\x22\x20id=\x22expiryTime\x22\x20step=\x221\x22\x20required></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22dataLimit\x22>Data\x20Limit</label><div\x20class=\x22input-group\x22><input\x20type=\x22number\x22\x20id=\x22dataLimitValue\x22\x20placeholder=\x22e.g.,\x2010\x22><select\x20id=\x22dataLimitUnit\x22><option\x20value=\x22GB\x22>GB</option><option\x20value=\x22MB\x22>MB</option></select><button\x20type=\x22button\x22\x20id=\x22unlimitedBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Unlimited</button></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22notes\x22>Notes</label><input\x20type=\x22text\x22\x20id=\x22notes\x22\x20placeholder=\x22(Optional)\x22></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22\x20style=\x22grid-column:1/-1;align-items:flex-start;margin-top:10px\x22><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Create\x20User</button></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22card\x22\x20style=\x22margin-top:30px\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2>User\x20List</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22user-list-wrapper\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<table><thead><tr><th>UUID</th><th>Created</th><th>Expiry</th><th>Status</th><th>Traffic</th><th>Notes</th><th>Actions</th></tr></thead><tbody\x20id=\x22userList\x22></tbody></table>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20<div\x20id=\x22toast\x22></div>\x0a\x20\x20\x20\x20<div\x20id=\x22editModal\x22\x20class=\x22modal-overlay\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22modal-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22modal-header\x22><h2>Edit\x20User</h2><button\x20id=\x22modalCloseBtn\x22\x20class=\x22modal-close-btn\x22>&times;</button></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<form\x20id=\x22editUserForm\x22\x20class=\x22form-grid\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22hidden\x22\x20id=\x22editUuid\x22\x20name=\x22uuid\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22editExpiryDate\x22>Expiry\x20Date</label><input\x20type=\x22date\x22\x20id=\x22editExpiryDate\x22\x20name=\x22exp_date\x22\x20required></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22editExpiryTime\x22>Expiry\x20Time\x20(Your\x20Local\x20Time)</label><input\x20type=\x22time\x22\x20id=\x22editExpiryTime\x22\x20name=\x22exp_time\x22\x20step=\x221\x22\x20required></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22editDataLimit\x22>Data\x20Limit</label><div\x20class=\x22input-group\x22><input\x20type=\x22number\x22\x20id=\x22editDataLimitValue\x22\x20placeholder=\x22e.g.,\x2010\x22><select\x20id=\x22editDataLimitUnit\x22><option\x20value=\x22GB\x22>GB</option><option\x20value=\x22MB\x22>MB</option></select><button\x20type=\x22button\x22\x20id=\x22editUnlimitedBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Unlimited</button></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x22><label\x20for=\x22editNotes\x22>Notes</label><input\x20type=\x22text\x22\x20id=\x22editNotes\x22\x20name=\x22notes\x22\x20placeholder=\x22(Optional)\x22></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22form-group\x20form-check\x22\x20style=\x22grid-column:1/-1\x22><input\x20type=\x22checkbox\x22\x20id=\x22resetTraffic\x22><label\x20for=\x22resetTraffic\x22>Reset\x20Traffic\x20Usage</label></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22modal-footer\x22\x20style=\x22grid-column:1/-1\x22><button\x20type=\x22button\x22\x20id=\x22modalCancelBtn\x22\x20class=\x22btn\x20btn-secondary\x22>Cancel</button><button\x20type=\x22submit\x22\x20class=\x22btn\x20btn-primary\x22>Save\x20Changes</button></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<script>\x0a\x20\x20\x20\x20\x20\x20\x20\x20document.addEventListener(\x27DOMContentLoaded\x27,\x20()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20API_BASE\x20=\x20window.location.pathname\x20+\x20(window.location.pathname.endsWith(\x27/\x27)\x20?\x20\x27\x27\x20:\x20\x27/\x27)\x20+\x20\x27api\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20csrfToken\x20=\x20document.getElementById(\x27csrf_token\x27).value;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20apiHeaders\x20=\x20{\x20\x27Content-Type\x27:\x20\x27application/json\x27,\x20\x27X-CSRF-Token\x27:\x20csrfToken\x20};\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20*****\x20START:\x20CORRECTED\x20API\x20OBJECT\x20(using\x20+\x20for\x20concatenation)\x20*****\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20api\x20=\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20get:\x20(endpoint)\x20=>\x20fetch(API_BASE\x20+\x20endpoint).then(handleResponse),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20post:\x20(endpoint,\x20body)\x20=>\x20fetch(API_BASE\x20+\x20endpoint,\x20{\x20method:\x20\x27POST\x27,\x20headers:\x20apiHeaders,\x20body:\x20JSON.stringify(body)\x20}).then(handleResponse),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20put:\x20(endpoint,\x20body)\x20=>\x20fetch(API_BASE\x20+\x20endpoint,\x20{\x20method:\x20\x27PUT\x27,\x20headers:\x20apiHeaders,\x20body:\x20JSON.stringify(body)\x20}).then(handleResponse),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20delete:\x20(endpoint)\x20=>\x20fetch(API_BASE\x20+\x20endpoint,\x20{\x20method:\x20\x27DELETE\x27,\x20headers:\x20apiHeaders\x20}).then(handleResponse),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20*****\x20END:\x20CORRECTED\x20API\x20OBJECT\x20*****\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20handleResponse(response)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(response.status\x20===\x20403)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x27Session\x20expired\x20or\x20invalid.\x20Please\x20refresh\x20the\x20page.\x27,\x20true);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20throw\x20new\x20Error(\x27Forbidden:\x20Invalid\x20session\x20or\x20CSRF\x20token.\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!response.ok)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20errorData\x20=\x20await\x20response.json().catch(()\x20=>\x20({\x20error:\x20\x27An\x20unknown\x20error\x20occurred.\x27\x20}));\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20throw\x20new\x20Error(errorData.error\x20||\x20\x27Request\x20failed\x20with\x20status\x20\x27\x20+\x20response.status);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20response.status\x20===\x20204\x20?\x20null\x20:\x20response.json();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20function\x20showToast(message,\x20isError\x20=\x20false)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20toast\x20=\x20document.getElementById(\x27toast\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20toast.textContent\x20=\x20message;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20toast.style.backgroundColor\x20=\x20isError\x20?\x20\x27var(--danger)\x27\x20:\x20\x27var(--success)\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20toast.classList.add(\x27show\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20setTimeout(()\x20=>\x20{\x20toast.classList.remove(\x27show\x27);\x20},\x203000);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20pad\x20=\x20num\x20=>\x20num.toString().padStart(2,\x20\x270\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20localToUTC\x20=\x20(d,\x20t)\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!d\x20||\x20!t)\x20return\x20{\x20utcDate:\x20\x27\x27,\x20utcTime:\x20\x27\x27\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20dt\x20=\x20new\x20Date(d\x20+\x20\x27T\x27\x20+\x20t);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20utcDate:\x20dt.getUTCFullYear()\x20+\x20\x27-\x27\x20+\x20pad(dt.getUTCMonth()\x20+\x201)\x20+\x20\x27-\x27\x20+\x20pad(dt.getUTCDate()),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20utcTime:\x20pad(dt.getUTCHours())\x20+\x20\x27:\x27\x20+\x20pad(dt.getUTCMinutes())\x20+\x20\x27:\x27\x20+\x20pad(dt.getUTCSeconds())\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20utcToLocal\x20=\x20(d,\x20t)\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!d\x20||\x20!t)\x20return\x20{\x20localDate:\x20\x27\x27,\x20localTime:\x20\x27\x27\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20dt\x20=\x20new\x20Date(d\x20+\x20\x27T\x27\x20+\x20t\x20+\x20\x27Z\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20localDate:\x20dt.getFullYear()\x20+\x20\x27-\x27\x20+\x20pad(dt.getMonth()\x20+\x201)\x20+\x20\x27-\x27\x20+\x20pad(dt.getDate()),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20localTime:\x20pad(dt.getHours())\x20+\x20\x27:\x27\x20+\x20pad(dt.getMinutes())\x20+\x20\x27:\x27\x20+\x20pad(dt.getSeconds())\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20function\x20bytesToReadable(bytes)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bytes\x20<=\x200)\x20return\x20\x270\x20Bytes\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20i\x20=\x20Math.floor(Math.log(bytes)\x20/\x20Math.log(1024));\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20parseFloat((bytes\x20/\x20Math.pow(1024,\x20i)).toFixed(2))\x20+\x20\x27\x20\x27\x20+\x20[\x27Bytes\x27,\x20\x27KB\x27,\x20\x27MB\x27,\x20\x27GB\x27,\x20\x27TB\x27][i];\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20function\x20renderStats(stats)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20statsContainer\x20=\x20document.getElementById(\x27stats\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20statsContainer.innerHTML\x20=\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Total\x20Users</h3><p\x20class=\x22stat-value\x22>\x27\x20+\x20stats.totalUsers\x20+\x20\x27</p></div>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Active\x20Users</h3><p\x20class=\x22stat-value\x22>\x27\x20+\x20stats.activeUsers\x20+\x20\x27</p></div>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Expired\x20Users</h3><p\x20class=\x22stat-value\x22>\x27\x20+\x20stats.expiredUsers\x20+\x20\x27</p></div>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<div\x20class=\x22stat-card\x22><h3\x20class=\x22stat-title\x22>Total\x20Traffic\x20Used</h3><p\x20class=\x22stat-value\x22>\x27\x20+\x20bytesToReadable(stats.totalTraffic)\x20+\x20\x27</p></div>\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20function\x20renderUsers(users)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20userList\x20=\x20document.getElementById(\x27userList\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20userList.innerHTML\x20=\x20users.length\x20===\x200\x20?\x20\x27<tr><td\x20colspan=\x227\x22\x20style=\x22text-align:center;\x22>No\x20users\x20found.</td></tr>\x27\x20:\x20users.map(user\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20expiryUTC\x20=\x20new\x20Date(user.expiration_date\x20+\x20\x27T\x27\x20+\x20user.expiration_time\x20+\x20\x27Z\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20isExpired\x20=\x20expiryUTC\x20<\x20new\x20Date();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20trafficUsage\x20=\x20user.data_limit\x20>\x200\x20?\x20(bytesToReadable(user.data_usage)\x20+\x20\x27\x20/\x20\x27\x20+\x20bytesToReadable(user.data_limit))\x20:\x20(bytesToReadable(user.data_usage)\x20+\x20\x27\x20/\x20&infin;\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20trafficPercent\x20=\x20user.data_limit\x20>\x200\x20?\x20Math.min(100,\x20(user.data_usage\x20/\x20user.data_limit\x20*\x20100))\x20:\x200;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<tr\x20data-uuid=\x22\x27\x20+\x20user.uuid\x20+\x20\x27\x22>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<td\x20title=\x22\x27\x20+\x20user.uuid\x20+\x20\x27\x22>\x27\x20+\x20user.uuid.substring(0,\x208)\x20+\x20\x27...<button\x20class=\x22btn-copy-uuid\x22\x20title=\x22Copy\x20UUID\x22>ðŸ“‹</button></td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<td>\x27\x20+\x20new\x20Date(user.created_at).toLocaleString()\x20+\x20\x27</td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<td>\x27\x20+\x20expiryUTC.toLocaleString()\x20+\x20\x27</td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<td><span\x20class=\x22status-badge\x20\x27\x20+\x20(isExpired\x20?\x20\x27status-expired\x27\x20:\x20\x27status-active\x27)\x20+\x20\x27\x22>\x27\x20+\x20(isExpired\x20?\x20\x27Expired\x27\x20:\x20\x27Active\x27)\x20+\x20\x27</span></td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20trafficUsage\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<div\x20class=\x22traffic-bar\x22><div\x20class=\x22traffic-bar-inner\x22\x20style=\x22width:\x20\x27\x20+\x20trafficPercent\x20+\x20\x27%;\x22></div></div>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27</td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<td>\x27\x20+\x20(user.notes\x20||\x20\x27-\x27)\x20+\x20\x27</td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<td\x20class=\x22actions-cell\x22>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<button\x20class=\x22btn\x20btn-secondary\x20btn-edit\x22>Edit</button>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27<button\x20class=\x22btn\x20btn-danger\x20btn-delete\x22>Delete</button>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27</td>\x27\x20+\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x27</tr>\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}).join(\x27\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20async\x20function\x20refreshData()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20try\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20[stats,\x20users]\x20=\x20await\x20Promise.all([api.get(\x27/stats\x27),\x20api.get(\x27/users\x27)]);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20window.allUsers\x20=\x20users;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20renderStats(stats);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20renderUsers(users);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x20catch\x20(error)\x20{\x20console.error(\x27Failed\x20to\x20refresh\x20data:\x27,\x20error);\x20showToast(error.message,\x20true);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20getLimitInBytes\x20=\x20(valueId,\x20unitId)\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20value\x20=\x20parseFloat(document.getElementById(valueId).value);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20unit\x20=\x20document.getElementById(unitId).value;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(isNaN(value)\x20||\x20value\x20<=\x200)\x20return\x200;\x20//\x200\x20for\x20unlimited\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20multiplier\x20=\x20unit\x20===\x20\x27GB\x27\x20?\x201024\x20*\x201024\x20*\x201024\x20:\x201024\x20*\x201024;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return\x20Math.round(value\x20*\x20multiplier);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20setLimitFromBytes\x20=\x20(bytes,\x20valueId,\x20unitId)\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20valueEl\x20=\x20document.getElementById(valueId);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20unitEl\x20=\x20document.getElementById(unitId);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bytes\x20<=\x200)\x20{\x20valueEl.value\x20=\x20\x27\x27;\x20unitEl.value\x20=\x20\x27GB\x27;\x20return;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20isGB\x20=\x20bytes\x20>=\x201024\x20*\x201024\x20*\x201024;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20unit\x20=\x20isGB\x20?\x20\x27GB\x27\x20:\x20\x27MB\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20divisor\x20=\x20isGB\x20?\x201024\x20*\x201024\x20*\x201024\x20:\x201024\x20*\x201024;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20valueEl.value\x20=\x20parseFloat((bytes\x20/\x20divisor).toFixed(2));\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20unitEl.value\x20=\x20unit;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27createUserForm\x27).addEventListener(\x27submit\x27,\x20async\x20e\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20e.preventDefault();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20expiryDate\x20=\x20document.getElementById(\x27expiryDate\x27).value;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20expiryTime\x20=\x20document.getElementById(\x27expiryTime\x27).value;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20uuid\x20=\x20document.getElementById(\x27uuid\x27).value;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!uuid\x20||\x20!expiryDate\x20||\x20!expiryTime)\x20{\x20showToast(\x27UUID,\x20Expiry\x20Date,\x20and\x20Expiry\x20Time\x20are\x20required.\x27,\x20true);\x20return;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20{\x20utcDate,\x20utcTime\x20}\x20=\x20localToUTC(expiryDate,\x20expiryTime);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20userData\x20=\x20{\x20uuid,\x20exp_date:\x20utcDate,\x20exp_time:\x20utcTime,\x20data_limit:\x20getLimitInBytes(\x27dataLimitValue\x27,\x20\x27dataLimitUnit\x27),\x20notes:\x20document.getElementById(\x27notes\x27).value\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20try\x20{\x20await\x20api.post(\x27/users\x27,\x20userData);\x20showToast(\x27User\x20created\x20successfully!\x27);\x20e.target.reset();\x20document.getElementById(\x27uuid\x27).value\x20=\x20crypto.randomUUID();\x20setDefaultExpiry();\x20refreshData();\x20}\x20catch\x20(error)\x20{\x20showToast(error.message,\x20true);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20editModal\x20=\x20document.getElementById(\x27editModal\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27userList\x27).addEventListener(\x27click\x27,\x20e\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20button\x20=\x20e.target.closest(\x27button\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!button)\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20row\x20=\x20e.target.closest(\x27tr\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!row\x20||\x20!row.dataset.uuid)\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20uuid\x20=\x20row.dataset.uuid;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(button.classList.contains(\x27btn-copy-uuid\x27))\x20{\x20navigator.clipboard.writeText(uuid);\x20showToast(\x27UUID\x20copied\x27);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20else\x20if\x20(button.classList.contains(\x27btn-edit\x27))\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20user\x20=\x20window.allUsers.find(u\x20=>\x20u.uuid\x20===\x20uuid);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(!user)\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20{\x20localDate,\x20localTime\x20}\x20=\x20utcToLocal(user.expiration_date,\x20user.expiration_time);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27editUuid\x27).value\x20=\x20user.uuid;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27editExpiryDate\x27).value\x20=\x20localDate;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27editExpiryTime\x27).value\x20=\x20localTime;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20setLimitFromBytes(user.data_limit,\x20\x27editDataLimitValue\x27,\x20\x27editDataLimitUnit\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27editNotes\x27).value\x20=\x20user.notes\x20||\x20\x27\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27resetTraffic\x27).checked\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20editModal.classList.add(\x27show\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x20else\x20if\x20(button.classList.contains(\x27btn-delete\x27))\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20if\x20(confirm(\x27Delete\x20user\x20\x27\x20+\x20uuid.substring(0,8)\x20+\x20\x27...?\x27))\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20api.delete(\x27/users/\x27\x20+\x20uuid).then(()\x20=>\x20{\x20showToast(\x27User\x20deleted\x27);\x20refreshData();\x20}).catch(err\x20=>\x20showToast(err.message,\x20true));\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27editUserForm\x27).addEventListener(\x27submit\x27,\x20async\x20e\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20e.preventDefault();\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20uuid\x20=\x20document.getElementById(\x27editUuid\x27).value;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20{\x20utcDate,\x20utcTime\x20}\x20=\x20localToUTC(document.getElementById(\x27editExpiryDate\x27).value,\x20document.getElementById(\x27editExpiryTime\x27).value);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20updatedData\x20=\x20{\x20exp_date:\x20utcDate,\x20exp_time:\x20utcTime,\x20data_limit:\x20getLimitInBytes(\x27editDataLimitValue\x27,\x20\x27editDataLimitUnit\x27),\x20notes:\x20document.getElementById(\x27editNotes\x27).value,\x20reset_traffic:\x20document.getElementById(\x27resetTraffic\x27).checked\x20};\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20try\x20{\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20await\x20api.put(\x27/users/\x27\x20+\x20uuid,\x20updatedData);\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20showToast(\x27User\x20updated\x27);\x20editModal.classList.remove(\x27show\x27);\x20refreshData();\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20}\x20catch\x20(error)\x20{\x20showToast(error.message,\x20true);\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20closeModal\x20=\x20()\x20=>\x20editModal.classList.remove(\x27show\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27modalCloseBtn\x27).addEventListener(\x27click\x27,\x20closeModal);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27modalCancelBtn\x27).addEventListener(\x27click\x27,\x20closeModal);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20editModal.addEventListener(\x27click\x27,\x20e\x20=>\x20{\x20if\x20(e.target\x20===\x20editModal)\x20closeModal();\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.addEventListener(\x27keydown\x27,\x20e\x20=>\x20{\x20if\x20(e.key\x20===\x20\x22Escape\x22)\x20closeModal();\x20});\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27generateUUID\x27).addEventListener(\x27click\x27,\x20()\x20=>\x20document.getElementById(\x27uuid\x27).value\x20=\x20crypto.randomUUID());\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27unlimitedBtn\x27).addEventListener(\x27click\x27,\x20()\x20=>\x20{\x20document.getElementById(\x27dataLimitValue\x27).value\x20=\x20\x27\x27;\x20});\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27editUnlimitedBtn\x27).addEventListener(\x27click\x27,\x20()\x20=>\x20{\x20document.getElementById(\x27editDataLimitValue\x27).value\x20=\x20\x27\x27;\x20});\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20setDefaultExpiry\x20=\x20()\x20=>\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20now\x20=\x20new\x20Date();\x20now.setMonth(now.getMonth()\x20+\x201);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20//\x20[GEMINI\x20FIX]\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27expiryDate\x27).value\x20=\x20now.getFullYear()\x20+\x20\x27-\x27\x20+\x20pad(now.getMonth()\x20+\x201)\x20+\x20\x27-\x27\x20+\x20pad(now.getDate());\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27expiryTime\x27).value\x20=\x20pad(now.getHours())\x20+\x20\x27:\x27\x20+\x20pad(now.getMinutes())\x20+\x20\x27:\x27\x20+\x20pad(now.getSeconds());\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20};\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20document.getElementById(\x27uuid\x27).value\x20=\x20crypto.randomUUID();\x20setDefaultExpiry();\x20refreshData();\x0a\x20\x20\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20</script>\x0a</body>\x0a</html>';async function checkAdminAuth(a,b,c){const d=a['headers']['get']('Cookie'),e=d?.['match'](/auth_token=([^;]+)/)?.[0x1];if(!e)return{'isAdmin':![],'errorResponse':null,'csrfToken':null};const f=await b['USER_KV']['get']('admin_session:'+e,'json');if(!f){const h=new Headers({'Set-Cookie':'auth_token=;\x20Path='+c['adminPath']+';\x20Expires=Thu,\x2001\x20Jan\x201970\x2000:00:00\x20GMT'});return{'isAdmin':![],'errorResponse':new Response(null,{'status':0x193,'headers':h}),'csrfToken':null};}const {csrfToken:g}=f;if(['POST','PUT','DELETE']['includes'](a['method'])){const i=a['headers']['get']('X-CSRF-Token');if(!i||i!==g){const j=new Response(JSON['stringify']({'error':'Invalid\x20CSRF\x20token\x20or\x20session\x20expired.'}),{'status':0x193,'headers':{'Content-Type':'application/json'}});return{'isAdmin':![],'errorResponse':j,'csrfToken':null};}}return{'isAdmin':!![],'errorResponse':null,'csrfToken':g};}function handleApiError(a,b=''){console['error']('API\x20Error'+(b?'\x20('+b+')':'')+':',JSON['stringify'](a,null,0x2));let c='An\x20unexpected\x20error\x20occurred.\x20Check\x20worker\x20logs\x20for\x20details.';if(a instanceof Error)c=a['message'];else{if(typeof a==='string')c=a;else{if(typeof a==='object'&&a!==null&&a['message']){c=String(a['message']);if(a['cause']?.['message'])c+=':\x20'+a['cause']['message'];}}}if(c['includes']('UNIQUE\x20constraint\x20failed'))c='UUID\x20already\x20exists.';return new Response(JSON['stringify']({'error':c}),{'status':0x190,'headers':{'Content-Type':'application/json'}});}async function handleAdminRequest(a,b,c,d){const f=new URL(a['url']),{pathname:g}=f,h={'Content-Type':'application/json'};if(!b['ADMIN_KEY'])return new Response(JSON['stringify']({'error':'Admin\x20panel\x20not\x20configured.'}),{'status':0x1f7,'headers':h});if(!b['DB']||!b['USER_KV'])return new Response(JSON['stringify']({'error':'D1\x20or\x20KV\x20bindings\x20missing.'}),{'status':0x1f7,'headers':h});const i=c['adminPath']['endsWith']('/')?c['adminPath']['slice'](0x0,-0x1):c['adminPath'],j=i+'/api';if(g['startsWith'](j)){const {isAdmin:k,errorResponse:l}=await checkAdminAuth(a,b,c);if(l)return l;if(!k)return new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':h});const m=g['substring'](j['length']);if(m==='/stats'&&a['method']==='GET')try{const o=await b['DB']['prepare']('SELECT\x20COUNT(*)\x20as\x20totalUsers,\x20SUM(CASE\x20WHEN\x20DATETIME(expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27)\x20>\x20CURRENT_TIMESTAMP\x20THEN\x201\x20ELSE\x200\x20END)\x20as\x20activeUsers,\x20SUM(CASE\x20WHEN\x20DATETIME(expiration_date\x20||\x20\x27T\x27\x20||\x20expiration_time\x20||\x20\x27Z\x27)\x20<=\x20CURRENT_TIMESTAMP\x20THEN\x201\x20ELSE\x200\x20END)\x20as\x20expiredUsers,\x20SUM(data_usage)\x20as\x20totalTraffic\x20FROM\x20users')['first']();return new Response(JSON['stringify']({'totalUsers':o?.['totalUsers']||0x0,'activeUsers':o?.['activeUsers']||0x0,'expiredUsers':o?.['expiredUsers']||0x0,'totalTraffic':o?.['totalTraffic']||0x0}),{'status':0xc8,'headers':h});}catch(p){return handleApiError(p,'GET\x20/stats');}if(m==='/users'&&a['method']==='GET')try{const {results:q}=await b['DB']['prepare']('SELECT\x20*\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return new Response(JSON['stringify'](q??[]),{'status':0xc8,'headers':h});}catch(r){return handleApiError(r,'GET\x20/users');}if(m==='/users'&&a['method']==='POST')try{const s=await a['json'](),{uuid:t,exp_date:u,exp_time:v}=s,w=s['notes']||null,x=typeof s['data_limit']==='number'&&s['data_limit']>=0x0?s['data_limit']:0x0;if(!t||!u||!v||!isValidUUID(t))throw new Error('Invalid/missing\x20fields.');return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20data_limit)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?)')['bind'](t,u,v,w,x)['run'](),new Response(JSON['stringify']({'success':!![],'uuid':t}),{'status':0xc9,'headers':h});}catch(y){return handleApiError(y,'POST\x20/users');}const n=m['match'](/^\/users\/([a-f0-9-]+)$/);if(n){const z=n[0x1];if(a['method']==='PUT')try{const A=await a['json'](),{exp_date:B,exp_time:C}=A,D=A['notes']||null,E=typeof A['data_limit']==='number'&&A['data_limit']>=0x0?A['data_limit']:0x0,F=A['reset_traffic']||![];if(!B||!C)throw new Error('Invalid\x20date/time.');const G='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20data_limit\x20=\x20?\x20'+(F?',\x20data_usage\x20=\x200':'')+'\x20WHERE\x20uuid\x20=\x20?';return await b['DB']['prepare'](G)['bind'](B,C,D,E,z)['run'](),d['waitUntil'](b['USER_KV']['delete']('user:'+z)),new Response(JSON['stringify']({'success':!![],'uuid':z}),{'status':0xc8,'headers':h});}catch(H){return handleApiError(H,'PUT\x20/users/'+z);}if(a['method']==='DELETE')try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](z)['run'](),d['waitUntil'](b['USER_KV']['delete']('user:'+z)),new Response(null,{'status':0xcc});}catch(I){return handleApiError(I,'DELETE\x20/users/'+z);}}return new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':h});}if(g===c['adminPath']){if(a['method']==='POST'){const J=a['headers']['get']('Cookie'),K=J?.['match'](/login_csrf_token=([^;]+)/)?.[0x1],L=await a['formData'](),M=L['get']('csrf_token');if(!K||!M||K!==M){const N=adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20session.\x20Please\x20try\x20again.</p>'),O=new Headers({'Content-Type':'text/html;charset=utf-8'});return O['append']('Set-Cookie','login_csrf_token=;\x20Path='+c['adminPath']+';\x20Expires=Thu,\x2001\x20Jan\x201970\x2000:00:00\x20GMT'),new Response(N,{'status':0x193,'headers':O});}if(L['get']('password')===b['ADMIN_KEY']){const P=crypto['randomUUID'](),Q=crypto['randomUUID']();d['waitUntil'](b['USER_KV']['put']('admin_session:'+P,JSON['stringify']({'csrfToken':Q}),{'expirationTtl':0x15180}));const R=new Headers({'Location':c['adminPath'],'Set-Cookie':'auth_token='+P+';\x20HttpOnly;\x20Secure;\x20Path='+c['adminPath']+';\x20Max-Age=86400;\x20SameSite=Strict'});return R['append']('Set-Cookie','login_csrf_token=;\x20Path='+c['adminPath']+';\x20Expires=Thu,\x2001\x20Jan\x201970\x2000:00:00\x20GMT'),new Response(null,{'status':0x12e,'headers':R});}else{const S=new Headers({'Content-Type':'text/html;charset=utf-8'});return S['append']('Set-Cookie','login_csrf_token=;\x20Path='+c['adminPath']+';\x20Expires=Thu,\x2001\x20Jan\x201970\x2000:00:00\x20GMT'),new Response(adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20password.</p>'),{'status':0x191,'headers':S});}}if(a['method']==='GET'){const {isAdmin:T,csrfToken:U,errorResponse:V}=await checkAdminAuth(a,b,c);if(V)return V;if(T){const W=adminPanelHTML['replace']('<input\x20type=\x22hidden\x22\x20id=\x22csrf_token\x22\x20name=\x22csrf_token\x22>','<input\x20type=\x22hidden\x22\x20id=\x22csrf_token\x22\x20name=\x22csrf_token\x22\x20value=\x22'+U+'\x22>');return new Response(W,{'headers':{'Content-Type':'text/html;charset=utf-8'}});}else{const X=crypto['randomUUID'](),Y=adminLoginHTML['replace']('</form>','<input\x20type=\x22hidden\x22\x20name=\x22csrf_token\x22\x20value=\x22'+X+'\x22></form>'),Z=new Headers({'Content-Type':'text/html;charset=utf-8'});return Z['append']('Set-Cookie','login_csrf_token='+X+';\x20HttpOnly;\x20Secure;\x20Path='+c['adminPath']+';\x20Max-Age=600;\x20SameSite=Strict'),new Response(Y,{'headers':Z});}}return new Response('Method\x20Not\x20Allowed',{'status':0x195});}return new Response('Not\x20found',{'status':0x194});}async function handleManagementAPI(a,b,c,d){const f={'Content-Type':'application/json'};if(!c['apiToken']||a['headers']['get']('Authorization')!=='Bearer\x20'+c['apiToken'])return new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':f});if(!b['DB']||!b['USER_KV'])return new Response(JSON['stringify']({'error':'Service\x20partially\x20configured.'}),{'status':0x1f7,'headers':f});const g=new URL(a['url']),h=g['pathname']['match'](/^\/api\/v1\/users\/([a-f0-9-]+)$/);if(g['pathname']==='/api/v1/users'&&a['method']==='GET')try{const {results:i}=await b['DB']['prepare']('SELECT\x20*\x20FROM\x20users')['all']();return new Response(JSON['stringify'](i??[]),{'status':0xc8,'headers':f});}catch(j){return handleApiError(j,'GET\x20/api/v1/users');}if(g['pathname']==='/api/v1/users'&&a['method']==='POST')try{const k=await a['json'](),{uuid:l,exp_date:m,exp_time:n}=k;if(!l||!m||!n||!isValidUUID(l))throw new Error('Invalid/missing\x20fields.');const o=k['hasOwnProperty']('notes')?k['notes']||null:null;let p=0x0;if(typeof k['data_limit_gb']==='number')p=k['data_limit_gb']*0x40000000;else{if(typeof k['data_limit_mb']==='number')p=k['data_limit_mb']*0x100000;}await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes,\x20data_limit)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?)')['bind'](l,m,n,o,p)['run']();const q=await getUserData(b,l,d);return new Response(JSON['stringify'](q),{'status':0xc9,'headers':f});}catch(r){return handleApiError(r,'POST\x20/api/v1/users');}if(h){const s=h[0x1];if(a['method']==='GET')try{const t=await getUserData(b,s,d);if(!t)return new Response(JSON['stringify']({'error':'User\x20not\x20found'}),{'status':0x194,'headers':f});return new Response(JSON['stringify'](t),{'status':0xc8,'headers':f});}catch(u){return handleApiError(u,'GET\x20/api/v1/users/'+s);}if(a['method']==='DELETE')try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](s)['run'](),d['waitUntil'](b['USER_KV']['delete']('user:'+s)),new Response(null,{'status':0xcc});}catch(v){return handleApiError(v,'DELETE\x20/api/v1/users/'+s);}if(a['method']==='PUT')try{const w=await getUserData(b,s,d);if(!w)return new Response(JSON['stringify']({'error':'User\x20not\x20found'}),{'status':0x194,'headers':f});const x=await a['json'](),y=x['exp_date']||w['expiration_date'],z=x['exp_time']||w['expiration_time'],A=x['hasOwnProperty']('notes')?x['notes']||null:w['notes'];let B=w['data_limit'];if(typeof x['data_limit_gb']==='number')B=x['data_limit_gb']*0x40000000;else{if(typeof x['data_limit_mb']==='number')B=x['data_limit_mb']*0x100000;}const C='UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?,\x20data_limit\x20=\x20?\x20'+(x['reset_traffic']?',\x20data_usage\x20=\x200':'')+'\x20WHERE\x20uuid\x20=\x20?';await b['DB']['prepare'](C)['bind'](y,z,A,B,s)['run'](),d['waitUntil'](b['USER_KV']['delete']('user:'+s));const D=await getUserData(b,s,d);return new Response(JSON['stringify'](D),{'status':0xc8,'headers':f});}catch(E){return handleApiError(E,'PUT\x20/api/v1/users/'+s);}}return new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':f});}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++)d+=c['charAt'](Math['floor'](Math['random']()*c['length']));return'/'+d+(b?'?'+b:'');}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{}},'tcp':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'none','fp':'chrome','extra':{}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':CONST['ED_PARAMS']},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'firefox','extra':CONST['ED_PARAMS']}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'type':'ws','host':d,'path':e});if(f)l['set']('security',f);if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra))l['set'](m,n);return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a][b];return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':h['security']==='tls'?d:undefined,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}const pick=a=>a[Math['floor'](Math['random']()*a['length'])];async function handleIpSubscription(a,b,c){const d=[c,'creativecommons.org','www.speedtest.net','sky.rethinkdns.com','cfip.1323123.xyz','go.inmobi.com','www.visa.com','cf.090227.xyz','cdnjs.com','zula.ir'],f=[0x1bb,0x20fb,0x805,0x823,0x827,0x830],g=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f];let h=[];const i=c['endsWith']('.pages.dev');d['forEach']((j,k)=>{h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':j,'port':pick(f),'tag':'D'+(k+0x1)}));if(!i)h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':j,'port':pick(g),'tag':'D'+(k+0x1)}));});try{const j=await fetch('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json');if(j['ok']){const k=await j['json'](),l=[...k['ipv4']??[],...k['ipv6']??[]]['slice'](0x0,0x14)['map'](m=>m['ip']);l['forEach']((m,n)=>{const o=m['includes'](':')?'['+m+']':m;h['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':o,'port':pick(f),'tag':'IP'+(n+0x1)}));if(!i)h['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':o,'port':pick(g),'tag':'IP'+(n+0x1)}));});}}catch(m){console['error']('Fetch\x20IP\x20list\x20failed',m);}return new Response(btoa(h['join']('\x0a')),{'headers':{'Content-Type':'text/plain;charset=utf-8'}});}async function getIPGeoInfo(a){if(!a)return null;try{const b=await fetch('https://ip-api.com/json/'+a+'?fields=status,message,country,city,isp,query,as');if(!b['ok'])return null;const c=await b['json']();if(c['status']==='success')return{'ip':c['query'],'country':c['country']||'Unknown','city':c['city']||'Unknown','isp':c['isp']||c['as']||'Unknown'};return null;}catch(d){return console['error']('IP\x20info\x20error\x20for\x20'+a+':',d),null;}}async function getIPRiskScore(a,b){if(!a||!b['scamalytics']['username']||!b['scamalytics']['apiKey'])return'N/A\x20(Not\x20Configured)';try{const c=''+b['scamalytics']['baseUrl']+b['scamalytics']['username']+'/?key='+b['scamalytics']['apiKey']+'&ip='+a,d=await fetch(c);if(!d['ok'])return'N/A\x20(API\x20Error)';const f=await d['json']();if(f['status']==='ok'){const g=f['risk']['charAt'](0x0)['toUpperCase']()+f['risk']['slice'](0x1);return f['score']+'\x20-\x20'+g;}return'Error:\x20'+(f['error_message']||'API\x20error');}catch(h){return'N/A\x20(Fetch\x20Error)';}}async function handleNetworkInfoRequest(a,b,c,d){const e=a['headers']['get']('CF-Connecting-IP');let f=await b['USER_KV']?.['get']('proxy_ip_info','json');if(!f){let j=c['proxyIP'];if(!j)try{const k=await fetch('https://api.ipify.org?format=json');if(k['ok'])j=(await k['json']())['ip'];}catch(l){console['error']('Proxy\x20IP\x20fallback\x20failed:',l);}f=await getIPGeoInfo(j),f&&b['USER_KV']&&d['waitUntil'](b['USER_KV']['put']('proxy_ip_info',JSON['stringify'](f),{'expirationTtl':0xe10}));}const [g,h]=await Promise['all']([getIPGeoInfo(e),getIPRiskScore(e,c)]),i=g||{};return i['risk']=h,new Response(JSON['stringify']({'proxy':f,'user':i}),{'headers':{'Content-Type':'application/json'}});}async function handleConfigPage(a,b,c,d,e,f,g,h){const {expiration_date:i,expiration_time:j,data_usage:k,data_limit:l}=d,m=generateBeautifulConfigPage(a,b,i,j,k,l);return new Response(m,{'headers':{'Content-Type':'text/html;\x20charset=utf-8'}});}function generateBeautifulConfigPage(a,b,c,d,e,f){const g='https://'+b+'/xray/'+a,h='https://'+b+'/sb/'+a,i='clash://install-config?url='+encodeURIComponent(h),j=d['includes'](':')&&d['split'](':')['length']===0x2?d+':00':d,k=c+'T'+j['split']('.')[0x0]+'Z',l=isExpired(c,d),m=f>0x0,n=m&&e>=f;let o='Checking...',p='status-active-text';if(l)o='Subscription\x20Expired',p='status-expired-text';else n&&(o='Data\x20Limit\x20Reached',p='status-expired-text');const q=m?Math['min'](0x64,e/f*0x64):0x0,r='<!doctype\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22UTF-8\x22\x20/><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,\x20initial-scale=1.0\x22\x20/><title>VLESS\x20Proxy\x20Configuration</title><script\x20src=\x22https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js\x22></script><style>:root{--bg-main:#121212;--bg-card:#1E1E1E;--bg-inner:#2f2f2f;--border-color:#333;--text-primary:#E0E0E0;--text-secondary:#B0B0B0;--accent:#BB86FC;--accent-hover:#D1C4E9;--status-active:#03DAC6;--status-expired:#CF6679;--network-bg:#212121;--network-border:#444}body{margin:0;font-family:-apple-system,BlinkMacSystemFont,\x22Segoe\x20UI\x22,Roboto,Helvetica,Arial,sans-serif;background-color:var(--bg-main);color:var(--text-primary);padding:20px}.container{max-width:900px;margin:auto}.header{text-align:center;margin-bottom:24px}.header\x20h1{font-size:2em;margin-bottom:8px}.header\x20p{color:var(--text-secondary)}.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:20px}.info-card{background:var(--bg-card);border-radius:12px;position:relative;overflow:hidden;border:1px\x20solid\x20var(--border-color)}.info-card.rainbow-border::before{content:\x27\x27;position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from\x20180deg\x20at\x2050%\x2050%,#CF6679,#BB86FC,#03DAC6,#CF6679);animation:spin\x204s\x20linear\x20infinite;z-index:1}.info-card-content{background:var(--bg-card);padding:20px;border-radius:10px;position:relative;z-index:2;margin:2px}.info-title{font-size:1.25em;text-align:center;margin:0\x200\x2016px;font-weight:500}.info-relative-time{text-align:center;font-size:1.4em;font-weight:600;margin-bottom:16px}.status-active-text{color:var(--status-active)}.status-expired-text{color:var(--status-expired)}.info-time-grid{display:grid;gap:8px;font-size:.9em;text-align:center;color:var(--text-secondary)}.data-usage-text{font-size:1.4em!important;font-weight:600;text-align:center;color:var(--text-primary);margin-bottom:16px}.traffic-bar-container{height:8px;background-color:var(--bg-inner);border-radius:4px;overflow:hidden}.traffic-bar{height:100%;background:linear-gradient(90deg,var(--accent)\x200%,var(--status-active)\x20100%);border-radius:4px;transition:width\x20.5s\x20ease-out}.network-info-wrapper{background:var(--bg-card);border-radius:12px;padding:24px;margin-bottom:24px;border:1px\x20solid\x20var(--border-color)}.network-info-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px\x20solid\x20var(--border-color)}.network-info-header\x20h2{margin:0;font-size:1.4rem}.network-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}.network-card{background:var(--network-bg);border:1px\x20solid\x20var(--network-border);border-radius:8px;padding:16px}.network-title{font-size:1.1em;margin-top:0;margin-bottom:12px;border-bottom:1px\x20solid\x20var(--network-border);padding-bottom:8px;color:var(--status-active)}.network-info-grid{display:grid;gap:8px;font-size:.9em}.network-info-grid\x20strong{color:var(--text-secondary);font-weight:400;display:inline-block;min-width:90px}.network-info-grid\x20span{color:var(--text-primary);font-weight:500}.skeleton{display:inline-block;width:120px;height:1em;background-color:var(--bg-inner);border-radius:4px}.config-card{background:var(--bg-card);border-radius:12px;padding:24px;margin-bottom:24px;border:1px\x20solid\x20var(--border-color)}.config-title{display:flex;justify-content:space-between;align-items:center;font-size:1.4rem;margin-bottom:20px;padding-bottom:16px;border-bottom:1px\x20solid\x20var(--border-color)}.button,.client-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px\x2016px;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;border:1px\x20solid\x20var(--border-color);background-color:var(--bg-inner);color:var(--text-primary);text-decoration:none;transition:all\x20.2s}.button:hover{background-color:#3f3f3f}.client-buttons{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}.client-btn{width:100%;box-sizing:border-box;background-color:var(--accent);color:#121212;border:none}.client-btn:hover{background-color:var(--accent-hover)}.qr-container{display:none;margin-top:20px;background:#fff;padding:16px;border-radius:8px;max-width:288px;margin-left:auto;margin-right:auto}@keyframes\x20spin{100%{transform:rotate(360deg)}}@media\x20(max-width:768px){body{padding:10px}.info-grid,.network-grid{grid-template-columns:1fr}.network-info-header{flex-direction:column;align-items:flex-start;gap:10px}.network-info-header\x20button{width:100%}}</style></head><body><div\x20class=\x22container\x22><div\x20class=\x22header\x22><h1>VLESS\x20Proxy\x20Configuration</h1><p>Copy\x20the\x20configuration\x20or\x20import\x20directly\x20into\x20your\x20client</p></div><div\x20class=\x22network-info-wrapper\x22><div\x20class=\x22network-info-header\x22><h2>Network\x20Information</h2><button\x20class=\x22button\x22\x20id=\x22refresh-network-btn\x22>Refresh</button></div><div\x20id=\x22network-info-grid\x22\x20class=\x22network-grid\x22><div\x20class=\x22network-card\x22><h3\x20class=\x22network-title\x22>Proxy\x20Server</h3><div\x20class=\x22network-info-grid\x22><div><strong>IP\x20Address:</strong>\x20<span\x20id=\x22proxy-ip\x22><span\x20class=\x22skeleton\x22></span></span></div><div><strong>Location:</strong>\x20<span\x20id=\x22proxy-location\x22><span\x20class=\x22skeleton\x22></span></span></div><div><strong>ISP:</strong>\x20<span\x20id=\x22proxy-isp\x22><span\x20class=\x22skeleton\x22></span></span></div></div></div><div\x20class=\x22network-card\x22><h3\x20class=\x22network-title\x22>Your\x20Connection</h3><div\x20class=\x22network-info-grid\x22><div><strong>IP\x20Address:</strong>\x20<span\x20id=\x22user-ip\x22><span\x20class=\x22skeleton\x22></span></span></div><div><strong>Location:</strong>\x20<span\x20id=\x22user-location\x22><span\x20class=\x22skeleton\x22></span></span></div><div><strong>ISP:</strong>\x20<span\x20id=\x22user-isp\x22><span\x20class=\x22skeleton\x22></span></span></div><div><strong>Risk\x20Score:</strong>\x20<span\x20id=\x22user-risk\x22><span\x20class=\x22skeleton\x22></span></span></div></div></div></div></div><div\x20class=\x22info-grid\x22><div\x20class=\x22info-card\x20rainbow-border\x22><div\x20class=\x22info-card-content\x22><h2\x20class=\x22info-title\x22>Expiration\x20Date</h2><div\x20id=\x22expiration-relative\x22\x20class=\x22info-relative-time\x20'+p+'\x22>'+o+'</div><div\x20class=\x22info-time-grid\x22\x20id=\x22expiration-display\x22\x20data-utc-time=\x22'+k+'\x22><div><strong>Your\x20Local\x20Time:</strong>\x20<span\x20id=\x22local-time\x22>--</span></div><div><strong>Tehran\x20Time:</strong>\x20<span\x20id=\x22tehran-time\x22>--</span></div><div><strong>Universal\x20Time:</strong>\x20<span\x20id=\x22utc-time\x22>--</span></div></div></div></div><div\x20class=\x22info-card\x22><div\x20class=\x22info-card-content\x22><h2\x20class=\x22info-title\x22>Data\x20Usage</h2><div\x20class=\x22data-usage-text\x22\x20id=\x22data-usage-display\x22\x20data-usage=\x22'+e+'\x22\x20data-limit=\x22'+f+'\x22>Loading...</div><div\x20class=\x22traffic-bar-container\x22><div\x20class=\x22traffic-bar\x22\x20style=\x22width:'+q+'%\x22></div></div></div></div></div><div\x20class=\x22config-card\x22><div\x20class=\x22config-title\x22><span>Xray\x20Subscription</span><button\x20id=\x22copy-xray-sub-btn\x22\x20class=\x22button\x22\x20data-clipboard-text=\x22'+g+'\x22>Copy\x20Link</button></div><div\x20class=\x22client-buttons\x22><a\x20href=\x22v2rayng://install-config?url='+encodeURIComponent(g)+'\x22\x20class=\x22client-btn\x22>V2rayNG\x20/\x20Universal</a><a\x20href=\x22shadowrocket://add/sub?url='+encodeURIComponent(g)+'&name='+encodeURIComponent(b)+'\x22\x20class=\x22client-btn\x22>Shadowrocket</a><a\x20href=\x22stash://install-config?url='+encodeURIComponent(g)+'\x22\x20class=\x22client-btn\x22>Stash\x20(VLESS)</a><button\x20class=\x22client-btn\x22\x20onclick=\x22toggleQR(\x27xray\x27,\x20\x27'+g+'\x27)\x22>Show\x20QR\x20Code</button></div><div\x20id=\x22qr-xray-container\x22\x20class=\x22qr-container\x22><div\x20id=\x22qr-xray\x22></div></div></div><div\x20class=\x22config-card\x22><div\x20class=\x22config-title\x22><span>Sing-Box\x20/\x20Clash\x20Subscription</span><button\x20id=\x22copy-sb-sub-btn\x22\x20class=\x22button\x22\x20data-clipboard-text=\x22'+h+'\x22>Copy\x20Link</button></div><div\x20class=\x22client-buttons\x22><a\x20href=\x22'+i+'\x22\x20class=\x22client-btn\x22>Clash\x20Meta\x20/\x20Stash\x20(Sing-Box)</a><button\x20class=\x22client-btn\x22\x20onclick=\x22toggleQR(\x27singbox\x27,\x20\x27'+h+'\x27)\x22>Show\x20QR\x20Code</button></div><div\x20id=\x22qr-singbox-container\x22\x20class=\x22qr-container\x22><div\x20id=\x22qr-singbox\x22></div></div></div></div>\x0a<script>\x0afunction\x20copyToClipboard(e,t){const\x20n=e.textContent;navigator.clipboard.writeText(t).then(()=>{e.textContent=\x22Copied!\x22,setTimeout(()=>{e.textContent=n},1500)})}function\x20toggleQR(e,t){const\x20n=document.getElementById(\x22qr-\x22+e+\x22-container\x22),o=document.getElementById(\x22qr-\x22+e);n.style.display&&\x22none\x22!==n.style.display?n.style.display=\x22none\x22:(n.style.display=\x22block\x22,o.hasChildNodes()||new\x20QRCode(o,{text:t,width:256,height:256,colorDark:\x22#E0E0E0\x22,colorLight:\x22#1E1E1E\x22,correctLevel:QRCode.CorrectLevel.H}))}\x0afunction\x20displayExpirationTimes(){const\x20e=document.getElementById(\x22expiration-display\x22),t=document.getElementById(\x22expiration-relative\x22);if(!e?.dataset.utcTime)return;const\x20n=new\x20Date(e.dataset.utcTime);if(isNaN(n.getTime()))return;const\x20o=(n.getTime()-new\x20Date().getTime())/1e3,a=o<0;if(!a&&!t.textContent.includes(\x22Expired\x22)&&!t.textContent.includes(\x22Reached\x22)){const\x20e=new\x20Intl.RelativeTimeFormat(\x22en\x22,{numeric:\x22auto\x22});let\x20n=\x22\x22;n=Math.abs(o)<3600?e.format(Math.round(o/60),\x22minute\x22):Math.abs(o)<86400?e.format(Math.round(o/3600),\x22hour\x22):e.format(Math.round(o/86400),\x22day\x22);t.textContent=\x22Expires\x20\x22+n}else\x20a&&!t.textContent.includes(\x22Expired\x22)&&!t.textContent.includes(\x22Reached\x22)&&(t.textContent=\x22Subscription\x20Expired\x22,t.classList.add(\x22status-expired-text\x22),t.classList.remove(\x22status-active-text\x22));document.getElementById(\x22local-time\x22).textContent=n.toLocaleString(void\x200,{timeZoneName:\x22short\x22});document.getElementById(\x22tehran-time\x22).textContent=n.toLocaleString(\x22en-US\x22,{timeZone:\x22Asia/Tehran\x22,hour12:!0,year:\x22numeric\x22,month:\x22short\x22,day:\x22numeric\x22,hour:\x22numeric\x22,minute:\x222-digit\x22});document.getElementById(\x22utc-time\x22).textContent=n.toISOString().substring(0,19).replace(\x22T\x22,\x22\x20\x22)+\x22\x20UTC\x22}\x0afunction\x20displayDataUsage(){const\x20e=document.getElementById(\x22data-usage-display\x22),t=parseInt(e.dataset.usage,10),n=parseInt(e.dataset.limit,10),o=e=>{if(e<=0)return\x220\x20Bytes\x22;const\x20t=Math.floor(Math.log(e)/Math.log(1024));return\x20parseFloat((e/Math.pow(1024,t)).toFixed(2))+\x22\x20\x22+[\x22Bytes\x22,\x22KB\x22,\x22MB\x22,\x22GB\x22,\x22TB\x22][t]},a=n>0?o(n):\x22&infin;\x22;e.innerHTML=o(t)+\x22\x20/\x20\x22+a}\x0aasync\x20function\x20fetchNetworkInfo(){try{const\x20e=await\x20fetch(\x22/network-info\x22),t=await\x20e.json();document.getElementById(\x22proxy-ip\x22).textContent=t.proxy?.ip||\x22N/A\x22;document.getElementById(\x22proxy-location\x22).textContent=(t.proxy?.city||\x22\x22)+(t.proxy?.city&&t.proxy?.country?\x22,\x20\x22:\x22\x22)+(t.proxy?.country||\x22N/A\x22);document.getElementById(\x22proxy-isp\x22).textContent=t.proxy?.isp||\x22N/A\x22;document.getElementById(\x22user-ip\x22).textContent=t.user?.ip||\x22N/A\x22;document.getElementById(\x22user-location\x22).textContent=(t.user?.city||\x22\x22)+(t.user?.city&&t.user?.country?\x22,\x20\x22:\x22\x22)+(t.user?.country||\x22N/A\x22);document.getElementById(\x22user-isp\x22).textContent=t.user?.isp||\x22N/A\x22;document.getElementById(\x22user-risk\x22).textContent=t.user?.risk||\x22N/A\x22}catch(e){console.error(\x22Network\x20info\x20refresh\x20failed:\x22,e),document.getElementById(\x22proxy-ip\x22).textContent=\x22Error\x22,document.getElementById(\x22user-ip\x22).textContent=\x22Error\x22}}\x0adocument.addEventListener(\x22DOMContentLoaded\x22,()=>{displayExpirationTimes(),displayDataUsage(),fetchNetworkInfo(),document.getElementById(\x22refresh-network-btn\x22).addEventListener(\x22click\x22,()=>{document.querySelectorAll(\x27.network-info-grid\x20span:not([id$=\x22-risk\x22])\x27).forEach(e=>{e.innerHTML=\x27<span\x20class=\x22skeleton\x22></span>\x27}),document.getElementById(\x22user-risk\x22).innerHTML=\x27<span\x20class=\x22skeleton\x22></span>\x27,fetchNetworkInfo()}),document.querySelectorAll(\x22.button[data-clipboard-text]\x22).forEach(e=>{e.addEventListener(\x22click\x22,()=>copyToClipboard(e,e.dataset.clipboardText))}),setInterval(displayExpirationTimes,6e4)});\x0a</script>\x0a</body></html>';return r;}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b=0x0){const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}async function ProtocolOverWSHandler(a,b,c,d){const e=new WebSocketPair(),[f,g]=Object['values'](e);g['accept']();let h='',i='',j=null,k=0x0,l='';const m=(v,w)=>console['log']('['+h+':'+i+']\x20'+v,w||''),n=async()=>{if(k>0x0&&l)try{const v=Math['round'](k);await b['DB']['prepare']('UPDATE\x20users\x20SET\x20data_usage\x20=\x20data_usage\x20+\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](v,l)['run'](),c['waitUntil'](b['USER_KV']['delete']('user:'+l)),m('Updated\x20usage\x20for\x20'+l+'\x20by\x20'+v+'\x20bytes.');}catch(w){console['error']('Failed\x20to\x20update\x20usage\x20for\x20'+l+':',w);}};c['waitUntil'](new Promise(v=>{const w=()=>{n()['finally'](v);};g['addEventListener']('close',w,{'once':!![]}),g['addEventListener']('error',w,{'once':!![]});}));const o=()=>new TransformStream({'transform'(v,w){k+=v['byteLength'],w['enqueue'](v);}}),p=o(),q=o(),r={'socks5Address':d['socks5']['address'],'socks5Relay':d['socks5']['relayMode'],'enableSocks':d['socks5']['enabled'],'parsedSocks5Address':d['socks5']['enabled']?socks5AddressParser(d['socks5']['address']):{}},s=a['headers']['get']('Sec-WebSocket-Protocol')||'',t=MakeReadableWebSocketStream(g,s,m);let u={'value':null};return t['pipeThrough'](p)['pipeTo'](new WritableStream({async 'write'(v,w){if(j)return j['write'](v);if(u['value']){const F=u['value']['writable']['getWriter']();await F['write'](v),F['releaseLock']();return;}const {user:x,hasError:y,message:z,addressType:A,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawDataIndex:B,ProtocolVersion:ProtocolVersion=new Uint8Array([0x0,0x0]),isUDP:C}=await ProcessProtocolHeader(v,b,c);h=addressRemote,i=portRemote+'--'+Math['random']()+'\x20'+(C?'udp':'tcp');if(y||!x){w['error'](new Error(z||'Invalid\x20user.'));return;}l=x['uuid'];const D=new Uint8Array([ProtocolVersion[0x0],0x0]),E=v['slice'](B);if(C){if(portRemote===0x35){const G=I=>{k+=I;},H=await createDnsPipeline(g,D,m,G);j=H['write'],await j(E);}else w['error'](new Error('UDP\x20only\x20for\x20DNS\x20(port\x2053)'));return;}HandleTCPOutBound(u,A,addressRemote,portRemote,E,g,D,m,r,q);},'close'(){m('readableWebSocketStream\x20closed');},'abort'(v){m('readableWebSocketStream\x20aborted',v);}}))['catch'](v=>{console['error']('Pipeline\x20failed:',v['stack']||v),safeCloseWebSocket(g);}),new Response(null,{'status':0x65,'webSocket':f});}async function ProcessProtocolHeader(a,b,c){if(a['byteLength']<0x18)return{'hasError':!![],'message':'invalid\x20data'};const d=new DataView(a),e=d['getUint8'](0x0),f=stringify(new Uint8Array(a['slice'](0x1,0x11))),g=await getUserData(b,f,c);if(!g)return{'hasError':!![],'message':'invalid\x20user'};if(isExpired(g['expiration_date'],g['expiration_time']))return{'hasError':!![],'message':'user\x20expired'};if(g['data_limit']>0x0&&g['data_usage']>=g['data_limit'])return{'hasError':!![],'message':'data\x20limit\x20reached'};const h=d['getUint8'](0x11),i=d['getUint8'](0x12+h);if(i!==0x1&&i!==0x2)return{'hasError':!![],'message':'command\x20'+i+'\x20not\x20supported'};const j=0x12+h+0x1,k=d['getUint16'](j),l=d['getUint8'](j+0x2);let m,n,o;switch(l){case 0x1:n=0x4,o=j+0x3,m=new Uint8Array(a['slice'](o,o+n))['join']('.');break;case 0x2:n=d['getUint8'](j+0x3),o=j+0x4,m=new TextDecoder()['decode'](a['slice'](o,o+n));break;case 0x3:n=0x10,o=j+0x3,m=Array['from']({'length':0x8},(p,q)=>d['getUint16'](o+q*0x2)['toString'](0x10))['join'](':');break;default:return{'hasError':!![],'message':'invalid\x20addressType:\x20'+l};}if(!m)return{'hasError':!![],'message':'addressValue\x20empty,\x20type\x20'+l};return{'user':g,'hasError':![],'addressRemote':m,'addressType':l,'portRemote':k,'rawDataIndex':o+n,'ProtocolVersion':new Uint8Array([e]),'isUDP':i===0x2};}async function HandleTCPOutBound(a,b,c,d,e,f,g,h,i,j){async function k(n,o,p=![]){let q;i['socks5Relay']?q=await socks5Connect(b,n,o,h,i['parsedSocks5Address']):q=p?await socks5Connect(b,n,o,h,i['parsedSocks5Address']):connect({'hostname':n,'port':o});a['value']=q,h('connected\x20to\x20'+n+':'+o);const r=q['writable']['getWriter']();return await r['write'](e),r['releaseLock'](),q;}async function l(){const n=i['enableSocks']?await k(c,d,!![]):await k(c,d,![]);n['closed']['catch'](o=>console['log']('retry\x20error',o))['finally'](()=>safeCloseWebSocket(f)),RemoteSocketToWS(n,f,g,null,h,j);}const m=await k(c,d);RemoteSocketToWS(m,f,g,l,h,j);}function MakeReadableWebSocketStream(a,b,c){return new ReadableStream({'start'(d){a['addEventListener']('message',g=>d['enqueue'](g['data'])),a['addEventListener']('close',()=>{safeCloseWebSocket(a),d['close']();}),a['addEventListener']('error',g=>{c('ws\x20error'),d['error'](g);});const {earlyData:e,error:f}=base64ToArrayBuffer(b);if(f)d['error'](f);else{if(e)d['enqueue'](e);}},'pull'(d){},'cancel'(d){c('ReadableStream\x20cancelled:\x20'+d),safeCloseWebSocket(a);}});}async function RemoteSocketToWS(a,b,c,d,e,f){let g=![];try{await a['readable']['pipeThrough'](f)['pipeTo'](new WritableStream({async 'write'(h){if(b['readyState']!==CONST['WS_READY_STATE_OPEN'])throw new Error('WS\x20not\x20open');g=!![];const i=c?await new Blob([c,h])['arrayBuffer']():h;b['send'](i),c=null;},'close'(){e('Remote\x20readable\x20closed.\x20Data\x20received:\x20'+g);},'abort'(h){console['error']('Remote\x20readable\x20aborted:',h);}}));}catch(h){console['error']('RemoteSocketToWS\x20error:',h['stack']||h),safeCloseWebSocket(b);}!g&&d&&(e('No\x20incoming\x20data,\x20retrying'),d());}function base64ToArrayBuffer(a){if(!a)return{'earlyData':null,'error':null};try{const b=atob(a['replace'](/-/g,'+')['replace'](/_/g,'/')),c=new ArrayBuffer(b['length']),d=new Uint8Array(c);for(let e=0x0;e<b['length'];e++)d[e]=b['charCodeAt'](e);return{'earlyData':c,'error':null};}catch(f){return{'earlyData':null,'error':f};}}function safeCloseWebSocket(a){try{if(a['readyState']===CONST['WS_READY_STATE_OPEN']||a['readyState']===CONST['WS_READY_STATE_CLOSING'])a['close']();}catch(b){console['error']('safeCloseWebSocket\x20error:',b);}}async function createDnsPipeline(a,b,c,d){let e=![];const f=new TransformStream({'transform'(h,i){for(let j=0x0;j<h['byteLength'];){const k=h['slice'](j,j+0x2),l=new DataView(k)['getUint16'](0x0),m=new Uint8Array(h['slice'](j+0x2,j+0x2+l));j=j+0x2+l,i['enqueue'](m);}}});f['readable']['pipeTo'](new WritableStream({async 'write'(h){try{const i=await fetch('https://1.1.1.1/dns-query',{'method':'POST','headers':{'content-type':'application/dns-message'},'body':h}),j=await i['arrayBuffer'](),k=j['byteLength'],l=new Uint8Array([k>>0x8&0xff,k&0xff]);if(a['readyState']===CONST['WS_READY_STATE_OPEN']){c('DNS\x20query\x20ok,\x20len:\x20'+k);const m=e?new Blob([l,j]):new Blob([b,l,j]),n=await m['arrayBuffer']();d(n['byteLength']),a['send'](n),e=!![];}}catch(o){c('DNS\x20query\x20error:\x20'+o);}}}))['catch'](h=>{c('DNS\x20stream\x20error:\x20'+h);});const g=f['writable']['getWriter']();return{'write':h=>g['write'](h)};}async function socks5Connect(a,b,c,d,e){const {username:f,password:g,hostname:h,port:i}=e,j=connect({'hostname':h,'port':i}),k=j['writable']['getWriter'](),l=j['readable']['getReader'](),m=new TextEncoder();await k['write'](new Uint8Array([0x5,0x2,0x0,0x2]));let n=(await l['read']())['value'];if(n[0x0]!==0x5||n[0x1]===0xff)throw new Error('SOCKS5\x20connection\x20failed.');if(n[0x1]===0x2){if(!f||!g)throw new Error('SOCKS5\x20auth\x20needed.');const q=new Uint8Array([0x1,f['length'],...m['encode'](f),g['length'],...m['encode'](g)]);await k['write'](q),n=(await l['read']())['value'];if(n[0x0]!==0x1||n[0x1]!==0x0)throw new Error('SOCKS5\x20auth\x20failed.');}let o;switch(a){case 0x1:o=new Uint8Array([0x1,...b['split']('.')['map'](Number)]);break;case 0x2:o=new Uint8Array([0x3,b['length'],...m['encode'](b)]);break;case 0x3:o=new Uint8Array([0x4,...b['split'](':')['flatMap'](r=>[parseInt(r['slice'](0x0,0x2),0x10),parseInt(r['slice'](0x2),0x10)])]);break;default:throw new Error('Invalid\x20addressType\x20for\x20SOCKS5:\x20'+a);}const p=new Uint8Array([0x5,0x1,0x0,...o,c>>0x8,c&0xff]);await k['write'](p),n=(await l['read']())['value'];if(n[0x1]!==0x0)throw new Error('Failed\x20SOCKS5\x20request.');return k['releaseLock'](),l['releaseLock'](),j;}function socks5AddressParser(a){try{const [b,c]=a['includes']('@')?a['split']('@'):[null,a],[d,e]=c['split'](':'),f=parseInt(e,0xa);if(!d||isNaN(f))throw new Error();let g,h;if(b){[g,h]=b['split'](':');if(!g)throw new Error();}return{'username':g,'password':h,'hostname':d,'port':f};}catch{throw new Error('Invalid\x20SOCKS5\x20address.\x20Expected\x20[user:pass@]host:port');}}export default{async 'fetch'(a,b,c){const d=Config['fromEnv'](b),f=new URL(a['url']);if(f['pathname']['startsWith'](d['adminPath']))return handleAdminRequest(a,b,d,c);if(d['apiToken']&&f['pathname']['startsWith']('/api/v1/'))return handleManagementAPI(a,b,d,c);const g=a['headers']['get']('Upgrade');if(g?.['toLowerCase']()==='websocket'){if(!b['DB']||!b['USER_KV'])return new Response(JSON['stringify']({'error':'VLESS\x20proxy\x20misconfigured.'}),{'status':0x1f7,'headers':{'Content-Type':'application/json'}});return ProtocolOverWSHandler(a,b,c,d);}if(f['pathname']==='/network-info')return handleNetworkInfoRequest(a,b,d,c);const h=async j=>{const k=f['pathname']['slice'](('/'+j+'/')['length']),l=await getUserData(b,k,c);if(!l||isExpired(l['expiration_date'],l['expiration_time']))return new Response('Invalid\x20or\x20expired\x20user',{'status':0x193});if(l['data_limit']>0x0&&l['data_usage']>=l['data_limit'])return new Response('Data\x20limit\x20reached',{'status':0x193});return handleIpSubscription(j,k,f['hostname']);};if(f['pathname']['startsWith']('/xray/'))return h('xray');if(f['pathname']['startsWith']('/sb/'))return h('sb');const i=f['pathname']['slice'](0x1);if(isValidUUID(i)){const j=await getUserData(b,i,c);if(!j)return new Response('Invalid\x20or\x20expired\x20user',{'status':0x193});return handleConfigPage(i,f['hostname'],d['proxyAddress'],j,a['headers']['get']('CF-Connecting-IP'),b,d,c);}if(d['rootProxyUrl'])try{const k=new URL(d['rootProxyUrl']),l=new URL(a['url']);l['hostname']=k['hostname'],l['protocol']=k['protocol'],l['port']=k['port'];const m=new Request(l,a);m['headers']['set']('Host',k['hostname']),m['headers']['set']('X-Forwarded-For',a['headers']['get']('CF-Connecting-IP')),m['headers']['set']('X-Forwarded-Proto','https');const n=await fetch(m),o=new Headers(n['headers']);return o['delete']('Content-Security-Policy'),o['delete']('X-Frame-Options'),new Response(n['body'],{'status':n['status'],'statusText':n['statusText'],'headers':o});}catch(p){return new Response('Proxy\x20error:\x20'+p['message'],{'status':0x1f6});}return new Response('Not\x20found.',{'status':0x194});}};