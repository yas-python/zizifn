// <!--GAMFC--> version base on commit 4d1ee46553223e4913fe530ded7a16410b2586ab, time is 2025-10-24 17:24:51 UTC<!--We are all REvil-->
// @ts-ignore

import{connect}from'cloudflare:sockets';const DEFAULT_PROXY_LIST=['nima.nscl.ir:443'],DEFAULTS={'userID':'d342d11e-d424-4583-b36e-524ab1f0afa4','scamalytics':{'username':'revilseptember','apiKey':'b2fc368184deb3d8ac914bd776b8215fe899dd8fef69fbaba77511acfbdeca0d','baseUrl':'https://api12.scamalytics.com/v3/'},'socks5':{'enabled':![],'relayMode':![],'address':''},'CONNECT_TIMEOUT_MS':0x1f40,'SOCKET_RETRY_DELAY_MS':0x190,'MAX_SOCKET_RETRIES':0x2};function safeParseJSON(a){try{return JSON['parse'](a);}catch(b){return null;}}function pad(a){return String(a)['padStart'](0x2,'0');}function nowISO(){return new Date()['toISOString']()['replace']('T','\x20')['slice'](0x0,0x13);}const Config={'proxyIPs':DEFAULT_PROXY_LIST,'userID':DEFAULTS['userID'],'scamalytics':DEFAULTS['scamalytics'],'socks5':DEFAULTS['socks5'],'fromEnv'(a={}){const b=a['PROXY_LIST']&&typeof a['PROXY_LIST']==='string'?a['PROXY_LIST']['split'](',')['map'](f=>f['trim']())['filter'](Boolean):this['proxyIPs'],c=a['PROXYIP']&&a['PROXYIP']['trim']()?a['PROXYIP']['trim']():b[Math['floor'](Math['random']()*b['length'])],[d,e='443']=c['split'](':');return{'userID':a['UUID']||this['userID'],'proxyIP':d,'proxyPort':e,'proxyAddress':c,'scamalytics':{'username':a['SCAMALYTICS_USERNAME']||this['scamalytics']['username'],'apiKey':a['SCAMALYTICS_API_KEY']||this['scamalytics']['apiKey'],'baseUrl':a['SCAMALYTICS_BASEURL']||this['scamalytics']['baseUrl']},'socks5':{'enabled':!!a['SOCKS5'],'relayMode':a['SOCKS5_RELAY']==='true'||this['socks5']['relayMode'],'address':a['SOCKS5']||this['socks5']['address']},'adminKey':a['ADMIN_KEY']||null,'rootProxyUrl':a['ROOT_PROXY_URL']||null,'connectTimeoutMs':parseInt(a['CONNECT_TIMEOUT_MS']||DEFAULTS['CONNECT_TIMEOUT_MS'],0xa),'socketRetryDelayMs':parseInt(a['SOCKET_RETRY_DELAY_MS']||DEFAULTS['SOCKET_RETRY_DELAY_MS']||DEFAULTS['SOCKET_RETRY_DELAY_MS'],0xa),'maxSocketRetries':parseInt(a['MAX_SOCKET_RETRIES']||DEFAULTS['MAX_SOCKET_RETRIES'],0xa)};}};function isValidUUID(a){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i['test'](a);}function generateUUID(){if(typeof crypto!=='undefined'&&crypto['randomUUID'])return crypto['randomUUID']();return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'['replace'](/[xy]/g,a=>{const b=Math['random']()*0x10|0x0,d=a==='x'?b:b&0x3|0x8;return d['toString'](0x10);});}function utcCompare(a,b){try{const c=a+'T'+b+'Z',f=new Date(c);if(isNaN(f))return![];return f>new Date();}catch(g){return![];}}async function getUserData(a,b){if(!b)return null;const c='user:'+b;try{const d=await a['USER_KV']['get'](c);if(d){const f=safeParseJSON(d);if(f)return f;}try{const g=await a['DB']['prepare']('SELECT\x20uuid,\x20created_at,\x20expiration_date,\x20expiration_time,\x20notes\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?\x20LIMIT\x201')['bind'](b)['first']();if(!g)return null;const h={'uuid':g['uuid'],'created_at':g['created_at'],'expiration_date':g['expiration_date'],'expiration_time':g['expiration_time'],'notes':g['notes']};return await a['USER_KV']['put'](c,JSON['stringify'](h),{'expirationTtl':0xe10}),h;}catch(i){return console['error']('D1\x20getUserData\x20error',i),null;}}catch(j){return console['error']('getUserData\x20KV/D1\x20error',j),null;}}async function isAdmin(a,b){try{const c=a['headers']['get']('Cookie')||'',d=c['match'](/auth_token=([^;]+)/)?.[0x1];if(!d)return![];const f=await b['USER_KV']['get']('admin_session_token');return f&&f===d;}catch(g){return console['error']('isAdmin\x20error',g),![];}}const adminLoginHTML='<!doctype\x20html>\x0a<html\x20lang=\x22en\x22><head><meta\x20charset=\x22utf-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22>\x0a<title>Admin\x20Login</title>\x0a<style>\x0a\x20\x20body{font-family:system-ui,Segoe\x20UI,Roboto,Helvetica,Arial;background:#0f172a;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}\x0a\x20\x20.login{background:#0b1220;padding:32px;border-radius:12px;\x20width:360px;\x20box-shadow:0\x206px\x2020px\x20rgba(2,6,23,.6)}\x0a\x20\x20h1{margin:0\x200\x2016px;font-size:20px;color:#e6eef8}\x0a\x20\x20input{width:100%;padding:10px;margin:8px\x200;border-radius:8px;border:1px\x20solid\x20#233047;background:#081122;color:#fff}\x0a\x20\x20button{width:100%;padding:10px;border-radius:8px;border:none;background:#1e90ff;color:#fff;font-weight:600}\x0a\x20\x20.error{color:#ff6b6b;margin-top:8px}\x0a</style>\x0a</head><body>\x0a\x20\x20<div\x20class=\x22login\x22>\x0a\x20\x20\x20\x20<h1>Admin\x20Login</h1>\x0a\x20\x20\x20\x20<form\x20method=\x22POST\x22\x20action=\x22/admin\x22>\x0a\x20\x20\x20\x20\x20\x20<input\x20type=\x22password\x22\x20name=\x22password\x22\x20placeholder=\x22Password\x22\x20required>\x0a\x20\x20\x20\x20\x20\x20<button\x20type=\x22submit\x22>Login</button>\x0a\x20\x20\x20\x20</form>\x0a\x20\x20</div>\x0a</body></html>',adminPanelHTML='<!doctype\x20html>\x0a<html\x20lang=\x22en\x22>\x0a<head><meta\x20charset=\x22utf-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22><title>Admin</title>\x0a<style>\x0a\x20\x20:root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--accent:#60a5fa}\x0a\x20\x20body{font-family:Inter,system-ui,Segoe\x20UI,Roboto;background:var(--bg);color:#e6eef8;margin:0;padding:20px}\x0a\x20\x20.wrap{max-width:1100px;margin:0\x20auto}\x0a\x20\x20header{display:flex;align-items:center;justify-content:space-between}\x0a\x20\x20h1{margin:0;font-size:20px}\x0a\x20\x20.card{background:var(--card);padding:18px;border-radius:12px;margin-top:18px}\x0a\x20\x20input,select{background:#061226;border:1px\x20solid\x20#233043;padding:8px;border-radius:8px;color:#e6eef8}\x0a\x20\x20table{width:100%;border-collapse:collapse;margin-top:12px}\x0a\x20\x20th,td{padding:10px;border-bottom:1px\x20solid\x20#162233;text-align:left;font-family:monospace}\x0a\x20\x20.btn{padding:8px\x2010px;border-radius:8px;border:none;background:var(--accent);color:#021029;cursor:pointer}\x0a\x20\x20.btn-danger{background:#ef4444;color:#fff}\x0a</style>\x0a</head>\x0a<body>\x0a\x20\x20<div\x20class=\x22wrap\x22>\x0a\x20\x20\x20\x20<header><h1>Admin\x20Dashboard</h1><div><form\x20method=\x22POST\x22\x20action=\x22/admin\x22><button\x20class=\x22btn\x22\x20type=\x22submit\x22>Refresh</button></form></div></header>\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h3>Create\x20User</h3>\x0a\x20\x20\x20\x20\x20\x20<form\x20id=\x22createUserForm\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22display:flex;gap:8px;flex-wrap:wrap\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22uuid\x22\x20placeholder=\x22UUID\x22\x20style=\x22flex:1\x22\x20required>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22gen\x22\x20type=\x22button\x22\x20class=\x22btn\x22>Generate</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22expiryDate\x22\x20type=\x22date\x22\x20required>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22expiryTime\x22\x20type=\x22time\x22\x20step=\x221\x22\x20required>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20id=\x22notes\x22\x20placeholder=\x22Notes\x22\x20style=\x22flex:1\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22margin-top:8px\x22><button\x20class=\x22btn\x22\x20type=\x22submit\x22>Create</button></div>\x0a\x20\x20\x20\x20\x20\x20</form>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h3>User\x20List</h3>\x0a\x20\x20\x20\x20\x20\x20<div\x20id=\x22usersRoot\x22>Loading...</div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a\x0a<script>\x0a(async\x20function(){\x0a\x20\x20const\x20API=\x27/admin/api\x27;\x0a\x20\x20const\x20root=document.getElementById(\x27usersRoot\x27);\x0a\x20\x20document.getElementById(\x27gen\x27).addEventListener(\x27click\x27,()=>{\x20if(crypto.randomUUID)\x20document.getElementById(\x27uuid\x27).value=crypto.randomUUID();\x20});\x0a\x20\x20async\x20function\x20fetchUsers(){\x0a\x20\x20\x20\x20try{\x0a\x20\x20\x20\x20\x20\x20const\x20r=await\x20fetch(API+\x27/users\x27,{credentials:\x27include\x27});\x0a\x20\x20\x20\x20\x20\x20if(!r.ok)\x20throw\x20new\x20Error(\x27fetch\x20users\x20failed\x27);\x0a\x20\x20\x20\x20\x20\x20const\x20data=await\x20r.json();\x0a\x20\x20\x20\x20\x20\x20if(!Array.isArray(data))\x20{\x20root.textContent=\x27No\x20users\x27;\x20return;\x20}\x0a\x20\x20\x20\x20\x20\x20const\x20table=document.createElement(\x27table\x27);\x0a\x20\x20\x20\x20\x20\x20table.innerHTML=\x27<thead><tr><th>UUID</th><th>Created</th><th>Expiry\x20(UTC)</th><th>Notes</th><th>Actions</th></tr></thead>\x27;\x0a\x20\x20\x20\x20\x20\x20const\x20tbody=document.createElement(\x27tbody\x27);\x0a\x20\x20\x20\x20\x20\x20data.forEach(u=>{\x0a\x20\x20\x20\x20\x20\x20\x20\x20const\x20tr=document.createElement(\x27tr\x27);\x0a\x20\x20\x20\x20\x20\x20\x20\x20tr.innerHTML=\x27<td>\x27+u.uuid+\x27</td><td>\x27+\x20(u.created_at\x20||\x20\x27\x27)\x20+\x27</td><td>\x27+\x20(u.expiration_date\x20?\x20(u.expiration_date+\x27\x20\x27+u.expiration_time)\x20:\x20\x27-\x27)\x20+\x27</td><td>\x27+(u.notes||\x27-\x27)+\x27</td><td><button\x20class=\x22del\x22>Delete</button></td>\x27;\x0a\x20\x20\x20\x20\x20\x20\x20\x20tr.querySelector(\x27.del\x27).addEventListener(\x27click\x27,\x20async\x20()=>{\x20if(confirm(\x27Delete\x20\x27+u.uuid+\x27?\x27)){\x20await\x20fetch(API+\x27/users/\x27+u.uuid,{method:\x27DELETE\x27});\x20fetchUsers();\x20}});\x0a\x20\x20\x20\x20\x20\x20\x20\x20tbody.appendChild(tr);\x0a\x20\x20\x20\x20\x20\x20});\x0a\x20\x20\x20\x20\x20\x20table.appendChild(tbody);\x0a\x20\x20\x20\x20\x20\x20root.innerHTML=\x27\x27;\x20root.appendChild(table);\x0a\x20\x20\x20\x20}catch(e){\x20root.textContent=\x27Error:\x20\x27+e.message;\x20console.error(e);\x20}\x0a\x20\x20}\x0a\x20\x20document.getElementById(\x27createUserForm\x27).addEventListener(\x27submit\x27,\x20async\x20e=>{\x0a\x20\x20\x20\x20e.preventDefault();\x0a\x20\x20\x20\x20const\x20uuid=document.getElementById(\x27uuid\x27).value;\x0a\x20\x20\x20\x20const\x20d=document.getElementById(\x27expiryDate\x27).value;\x0a\x20\x20\x20\x20const\x20t=document.getElementById(\x27expiryTime\x27).value;\x0a\x20\x20\x20\x20const\x20notes=document.getElementById(\x27notes\x27).value;\x0a\x20\x20\x20\x20try{\x0a\x20\x20\x20\x20\x20\x20const\x20r=await\x20fetch(API+\x27/users\x27,{method:\x27POST\x27,credentials:\x27include\x27,headers:{\x27Content-Type\x27:\x27application/json\x27},body:JSON.stringify({uuid,exp_date:d,exp_time:t,notes})});\x0a\x20\x20\x20\x20\x20\x20if(!r.ok)\x20throw\x20new\x20Error(\x27create\x20failed\x27);\x20fetchUsers();\x0a\x20\x20\x20\x20}catch(e){\x20alert(\x27Error:\x20\x27+e.message);\x20}\x0a\x20\x20});\x0a\x20\x20await\x20fetchUsers();\x0a})();\x0a</script>\x0a</body></html>';function generateUserPageHTML({userID:a,hostName:b,proxyAddress:c,expDate:d,expTime:e}){const f='https://'+b+'/xray/'+a,g='https://'+b+'/sb/'+a,h='vless://'+a+'@'+b+':443?type=ws&host='+b+'&path=/&security=tls#'+encodeURIComponent(b+'-Xray'),i='vless://'+a+'@'+b+':443?type=ws&host='+b+'&path=/&security=tls#'+encodeURIComponent(b+'-Singbox');return'<!doctype\x20html><html\x20lang=\x22en\x22><head><meta\x20charset=\x22utf-8\x22><meta\x20name=\x22viewport\x22\x20content=\x22width=device-width,initial-scale=1\x22><title>Config</title>\x0a<link\x20rel=\x22icon\x22\x20href=\x22data:,\x22\x20/>\x0a<style>\x0a\x20\x20body{font-family:Inter,system-ui,Segoe\x20UI,Roboto;background:#071028;color:#e6eef8;margin:0;padding:20px}\x0a\x20\x20.wrap{max-width:980px;margin:0\x20auto}\x0a\x20\x20header{display:flex;justify-content:space-between;align-items:center}\x0a\x20\x20h1{margin:0}\x0a\x20\x20.card{background:#0d2136;padding:18px;border-radius:12px;margin-top:18px}\x0a\x20\x20.code{background:#041623;padding:12px;border-radius:8px;font-family:monospace;overflow:auto}\x0a\x20\x20a.btn{display:inline-block;padding:8px\x2010px;border-radius:8px;background:#60a5fa;color:#021029;text-decoration:none;font-weight:700}\x0a\x20\x20.meta{color:#94a3b8}\x0a</style>\x0a</head><body>\x0a\x20\x20<div\x20class=\x22wrap\x22>\x0a\x20\x20\x20\x20<header><h1>Configuration\x20for\x20'+b+'</h1><div\x20class=\x22meta\x22>Expires:\x20'+(d?d+'\x20'+e+'\x20UTC':'None')+'</div></header>\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h3>Subscription\x20URLs</h3>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22code\x22><strong>Xray\x20subscription:</strong><br>'+f+'<br><br><strong>Singbox\x20subscription:</strong><br>'+g+'</div>\x0a\x20\x20\x20\x20\x20\x20<div\x20style=\x22margin-top:12px\x22><a\x20class=\x22btn\x22\x20href=\x22'+f+'\x22>Open\x20Xray\x20Sub</a>\x20<a\x20class=\x22btn\x22\x20href=\x22'+g+'\x22>Open\x20Singbox\x20Sub</a></div>\x0a\x20\x20\x20\x20</div>\x0a\x0a\x20\x20\x20\x20<div\x20class=\x22card\x22>\x0a\x20\x20\x20\x20\x20\x20<h3>Single\x20Configs</h3>\x0a\x20\x20\x20\x20\x20\x20<div\x20class=\x22code\x22><strong>Xray\x20(single):</strong><br>'+h+'<br><br><strong>Singbox\x20(single):</strong><br>'+i+'</div>\x0a\x20\x20\x20\x20</div>\x0a\x20\x20</div>\x0a</body></html>';}async function fetchWithTimeout(a,b={},c=0x1f40){const d=new AbortController(),f=setTimeout(()=>d['abort'](),c);try{const g=await fetch(a,{...b,'signal':d['signal']});return clearTimeout(f),g;}catch(h){clearTimeout(f);throw h;}}async function connectWithTimeout({hostname:a,port:b,timeoutMs:timeoutMs=DEFAULTS['CONNECT_TIMEOUT_MS']}){return new Promise((c,d)=>{let e=![];const f=setTimeout(()=>{!e&&(e=!![],d(new Error('connect\x20timeout\x20to\x20'+a+':'+b+'\x20after\x20'+timeoutMs+'ms')));},timeoutMs);((async()=>{try{const g=await connect({'hostname':a,'port':Number(b)});if(e){try{g['close']();}catch(h){}return;}e=!![],clearTimeout(f),c(g);}catch(i){!e&&(e=!![],clearTimeout(f),d(i));}})());});}async function ProtocolOverWSHandler(a,b,c){const d=new WebSocketPair(),[e,f]=Object['values'](d);f['accept']();let g='',h='',i=null,j={'value':null};const k=(n,o)=>console['log']('['+g+':'+h+']\x20'+n,o||''),l=a['headers']['get']('Sec-WebSocket-Protocol')||'',m=MakeReadableWebSocketStream(f,l,k);return m['pipeTo'](new WritableStream({async 'write'(n,o){if(i)return i['write'](n);if(j['value']){const x=j['value']['writable']['getWriter']();await x['write'](n),x['releaseLock']();return;}const {hasError:p,message:q,addressType:r,portRemote:portRemote=0x1bb,addressRemote:addressRemote='',rawDataIndex:s,ProtocolVersion:t,isUDP:u}=await ProcessProtocolHeader(n,c);g=addressRemote,h=portRemote+'--'+Math['random']()['toString'](0x24)['slice'](0x2,0x8)+'\x20'+(u?'udp':'tcp');if(p){o['error'](q);return;}const v=new Uint8Array([t[0x0]||0x0,0x0]),w=n['slice'](s);if(u){if(portRemote===0x35){const y=await createDnsPipeline(f,v,k);i=y['write'],await i(w);}else o['error']('UDP\x20proxy\x20only\x20allowed\x20for\x20DNS\x20(port\x2053)');return;}HandleTCPOutBound(j,r,addressRemote,portRemote,w,f,v,k,b);},'close'(){k('readableWebSocketStream\x20closed');},'abort'(n){k('readableWebSocketStream\x20aborted',n);}}))['catch'](n=>{console['error']('Pipeline\x20failed:',n&&(n['stack']||n));}),new Response(null,{'status':0x65,'webSocket':e});}async function ProcessProtocolHeader(a,b){try{if(!a||a['byteLength']<0x18)return{'hasError':!![],'message':'invalid\x20data'};const c=new DataView(a),d=c['getUint8'](0x0),f=new Uint8Array(a['slice'](0x1,0x11)),g=unsafeStringify(f,0x0),h=await getUserData(b,g);if(!h||!utcCompare(h['expiration_date'],h['expiration_time']))return{'hasError':!![],'message':'invalid\x20or\x20expired\x20user'};const j=c['getUint8'](0x11),k=c['getUint8'](0x12+j);if(k!==0x1&&k!==0x2)return{'hasError':!![],'message':'command\x20'+k+'\x20not\x20supported'};const l=0x12+j+0x1,m=c['getUint16'](l),n=c['getUint8'](l+0x2);let o,p,q;switch(n){case 0x1:p=0x4,q=l+0x3,o=Array['from'](new Uint8Array(a['slice'](q,q+0x4)))['join']('.');break;case 0x2:p=c['getUint8'](l+0x3),q=l+0x4,o=new TextDecoder()['decode'](a['slice'](q,q+p));break;case 0x3:p=0x10,q=l+0x3;const r=[];for(let s=0x0;s<0x8;s++)r['push'](c['getUint16'](q+s*0x2)['toString'](0x10));o=r['join'](':');break;default:return{'hasError':!![],'message':'invalid\x20addressType:\x20'+n};}if(!o)return{'hasError':!![],'message':'addressValue\x20empty'};return{'hasError':![],'addressRemote':o,'addressType':n,'portRemote':m,'rawDataIndex':q+p,'ProtocolVersion':new Uint8Array([d]),'isUDP':k===0x2};}catch(t){return console['error']('ProcessProtocolHeader\x20error',t),{'hasError':!![],'message':'processing\x20header\x20failed'};}}async function HandleTCPOutBound(a,b,c,d,f,g,h,i,j){async function k(m,n,o=![]){let p=null;for(let q=0x0;q<=j['maxSocketRetries'];q++){try{const r=o?j['socks5Address']?.['hostname']||'127.0.0.1':m,s=o?j['socks5Address']?.['port']||n:n,t=await connectWithTimeout({'hostname':r,'port':s,'timeoutMs':j['connectTimeoutMs']}),u=t['writable']['getWriter']();return await u['write'](f),u['releaseLock'](),t;}catch(v){p=v,i('connect\x20attempt\x20'+q+'\x20failed:\x20'+(v&&v['message'])),await new Promise(w=>setTimeout(w,j['socketRetryDelayMs']||0xc8));}}throw p||new Error('connect\x20failed');}async function l(){try{const m=j['enableSocks']?await k(j['proxyIP']||c,j['proxyPort']||d,!![]):await k(j['proxyIP']||c,j['proxyPort']||d,![]);m['closed']['catch'](n=>console['log']('retry\x20tcpSocket\x20closed\x20error',n))['finally'](()=>safeCloseWebSocket(g)),RemoteSocketToWS(m,g,h,null,i);}catch(n){console['error']('retry\x20failed',n),safeCloseWebSocket(g);}}try{const m=await k(c,d);RemoteSocketToWS(m,g,h,l,i);}catch(n){console['error']('HandleTCPOutBound\x20final\x20connect\x20error',n),safeCloseWebSocket(g);}}function MakeReadableWebSocketStream(a,b,c){return new ReadableStream({'start'(d){a['addEventListener']('message',f=>d['enqueue'](f['data'])),a['addEventListener']('close',()=>{safeCloseWebSocket(a),d['close']();}),a['addEventListener']('error',f=>{c('webSocketServer\x20error'),d['error'](f);});try{const {earlyData:f,error:g}=base64ToArrayBuffer(b);if(g)d['error'](g);else{if(f)d['enqueue'](f);}}catch(h){}},'pull'(){},'cancel'(d){safeCloseWebSocket(a);}});}async function RemoteSocketToWS(a,b,c,d,e){let f=![];try{await a['readable']['pipeTo'](new WritableStream({async 'write'(g){if(b['readyState']!==0x1)throw new Error('WebSocket\x20is\x20not\x20open');f=!![];const h=c?await new Blob([c,g])['arrayBuffer']():g;b['send'](h),c=null;},'close'(){e('Remote\x20connection\x20closed.\x20incoming:'+f);},'abort'(g){console['error']('remote\x20readable\x20abort',g);}}));}catch(g){console['error']('RemoteSocketToWS\x20error',g&&(g['stack']||g)),safeCloseWebSocket(b);}!f&&d&&(e('No\x20incoming\x20data,\x20performing\x20retry'),d());}function base64ToArrayBuffer(a){if(!a)return{'earlyData':null,'error':null};try{const b='='['repeat']((0x4-a['length']%0x4)%0x4),c=(a+b)['replace'](/-/g,'+')['replace'](/_/g,'/'),d=atob(c),f=new ArrayBuffer(d['length']),g=new Uint8Array(f);for(let h=0x0;h<d['length'];h++)g[h]=d['charCodeAt'](h);return{'earlyData':f,'error':null};}catch(j){return{'earlyData':null,'error':j};}}function safeCloseWebSocket(a){try{if(!a)return;if(a['readyState']===0x1||a['readyState']===0x2)a['close']();}catch(b){console['error']('safeCloseWebSocket',b);}}const byteToHex=Array['from']({'length':0x100},(a,b)=>(b+0x100)['toString'](0x10)['slice'](0x1));function unsafeStringify(a,b=0x0){return(byteToHex[a[b]]+byteToHex[a[b+0x1]]+byteToHex[a[b+0x2]]+byteToHex[a[b+0x3]]+'-'+byteToHex[a[b+0x4]]+byteToHex[a[b+0x5]]+'-'+byteToHex[a[b+0x6]]+byteToHex[a[b+0x7]]+'-'+byteToHex[a[b+0x8]]+byteToHex[a[b+0x9]]+'-'+byteToHex[a[b+0xa]]+byteToHex[a[b+0xb]]+byteToHex[a[b+0xc]]+byteToHex[a[b+0xd]]+byteToHex[a[b+0xe]]+byteToHex[a[b+0xf]])['toLowerCase']();}function stringify(a,b=0x0){const c=unsafeStringify(a,b);if(!isValidUUID(c))throw new TypeError('Stringified\x20UUID\x20is\x20invalid');return c;}async function handleScamalyticsLookup(a,b){const c=new URL(a['url']),d=c['searchParams']['get']('ip');if(!d)return new Response(JSON['stringify']({'error':'Missing\x20IP\x20parameter'}),{'status':0x190,'headers':{'Content-Type':'application/json'}});const {username:f,apiKey:g,baseUrl:h}=b['scamalytics'];if(!f||!g)return new Response(JSON['stringify']({'error':'Scamalytics\x20API\x20credentials\x20not\x20configured.'}),{'status':0x1f4,'headers':{'Content-Type':'application/json'}});const i=''+h+f+'/?key='+g+'&ip='+d;try{const j=await fetchWithTimeout(i,{'headers':{'Content-Type':'application/json'}},0x1f40),k=await j['json']();return new Response(JSON['stringify'](k),{'headers':{'Content-Type':'application/json','Access-Control-Allow-Origin':'*'}});}catch(l){return new Response(JSON['stringify']({'error':l['message']||String(l)}),{'status':0x1f4,'headers':{'Content-Type':'application/json'}});}}function generateRandomPath(a=0xc,b=''){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let d='';for(let e=0x0;e<a;e++)d+=c['charAt'](Math['floor'](Math['random']()*c['length']));return'/'+d+(b?'?'+b:'');}const CORE_PRESETS={'xray':{'tls':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'tls','fp':'chrome','alpn':'http/1.1','extra':{}},'tcp':{'path':()=>generateRandomPath(0xc,'ed=2048'),'security':'none','fp':'chrome','extra':{}}},'sb':{'tls':{'path':()=>generateRandomPath(0x12),'security':'tls','fp':'firefox','alpn':'h3','extra':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'}},'tcp':{'path':()=>generateRandomPath(0x12),'security':'none','fp':'firefox','extra':{'ed':0xa00,'eh':'Sec-WebSocket-Protocol'}}}};function makeName(a,b){return a+'-'+b['toUpperCase']();}function createVlessLink({userID:a,address:b,port:c,host:d,path:e,security:f,sni:g,fp:h,alpn:i,extra:extra={},name:j}){const l=new URLSearchParams({'type':'ws','host':d,'path':e});if(f)l['set']('security',f);if(g)l['set']('sni',g);if(h)l['set']('fp',h);if(i)l['set']('alpn',i);for(const [m,n]of Object['entries'](extra))l['set'](m,n);return'vless://'+a+'@'+b+':'+c+'?'+l['toString']()+'#'+encodeURIComponent(j);}function buildLink({core:a,proto:b,userID:c,hostName:d,address:e,port:f,tag:g}){const h=CORE_PRESETS[a][b];return createVlessLink({'userID':c,'address':e,'port':f,'host':d,'path':h['path'](),'security':h['security'],'sni':h['security']==='tls'?d:undefined,'fp':h['fp'],'alpn':h['alpn'],'extra':h['extra'],'name':makeName(g,b)});}function pick(a){return a[Math['floor'](Math['random']()*a['length'])];}async function handleIpSubscription(a,b,c,d){const f=Config['fromEnv'](d),g=[c,'creativecommons.org','www.speedtest.net','sky.rethinkdns.com','go.inmobi.com','www.visa.com','cdnjs.com'],h=[0x1bb,0x20fb,0x805,0x823,0x827,0x830],i=[0x50,0x1f90,0x22b0,0x804,0x822,0x826,0x82f];let k=[];const l=c['endsWith']('.pages.dev');g['forEach']((n,o)=>{k['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':n,'port':pick(h),'tag':'D'+(o+0x1)}));if(!l)k['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':n,'port':pick(i),'tag':'D'+(o+0x1)}));});try{const n=await fetchWithTimeout('https://raw.githubusercontent.com/NiREvil/vless/refs/heads/main/Cloudflare-IPs.json',{},0x1770);if(n['ok']){const o=await n['json'](),p=[...(o['ipv4']||[])['map'](q=>q['ip']),...(o['ipv6']||[])['map'](q=>q['ip'])]['slice'](0x0,0x14);p['forEach']((q,s)=>{const t=q['includes'](':')?'['+q+']':q;k['push'](buildLink({'core':a,'proto':'tls','userID':b,'hostName':c,'address':t,'port':pick(h),'tag':'IP'+(s+0x1)}));if(!l)k['push'](buildLink({'core':a,'proto':'tcp','userID':b,'hostName':c,'address':t,'port':pick(i),'tag':'IP'+(s+0x1)}));});}}catch(q){console['error']('fetch\x20IP\x20list\x20failed',q);}const m=k['join']('\x0a');return new Response(btoa(m),{'headers':{'Content-Type':'text/plain;charset=utf-8'}});}export default{async 'fetch'(a,b,c){const d=Config['fromEnv'](b),f=new URL(a['url']),{pathname:g}=f;if(g['startsWith']('/admin'))return handleAdminRequest(a,b,d);const h=a['headers']['get']('Upgrade');if(h&&h['toLowerCase']()==='websocket'){const j={'userID':d['userID'],'proxyIP':d['proxyIP'],'proxyPort':d['proxyPort'],'enableSocks':d['socks5']['enabled'],'socks5Relay':d['socks5']['relayMode'],'parsedSocks5Address':d['socks5']['address']?socks5AddressParser(d['socks5']['address']):null,'connectTimeoutMs':d['connectTimeoutMs'],'maxSocketRetries':d['maxSocketRetries'],'socketRetryDelayMs':d['socketRetryDelayMs']};return await ProtocolOverWSHandler(a,j,b);}if(g==='/scamalytics-lookup')return handleScamalyticsLookup(a,d);if(g['startsWith']('/xray/')){const k=g['slice']('/xray/'['length']);if(!isValidUUID(k))return new Response('Invalid\x20UUID',{'status':0x190});const l=await getUserData(b,k);if(!l||!utcCompare(l['expiration_date'],l['expiration_time']))return new Response('Invalid\x20or\x20expired\x20user',{'status':0x193});return handleIpSubscription('xray',k,f['hostname'],b);}if(g['startsWith']('/sb/')){const m=g['slice']('/sb/'['length']);if(!isValidUUID(m))return new Response('Invalid\x20UUID',{'status':0x190});const n=await getUserData(b,m);if(!n||!utcCompare(n['expiration_date'],n['expiration_time']))return new Response('Invalid\x20or\x20expired\x20user',{'status':0x193});return handleIpSubscription('sb',m,f['hostname'],b);}const i=g['startsWith']('/')?g['slice'](0x1):g;if(isValidUUID(i)){const o=await getUserData(b,i);if(!o||!utcCompare(o['expiration_date'],o['expiration_time']))return new Response('Invalid\x20or\x20expired\x20user',{'status':0x193});return new Response(generateUserPageHTML({'userID':i,'hostName':f['hostname'],'proxyAddress':d['proxyAddress'],'expDate':o['expiration_date'],'expTime':o['expiration_time']}),{'headers':{'Content-Type':'text/html;\x20charset=utf-8'}});}if(d['rootProxyUrl'])try{const p=new URL(d['rootProxyUrl']),q=new URL(a['url']);q['hostname']=p['hostname'],q['protocol']=p['protocol'],q['port']=p['port'];const r=new Request(q,a);r['headers']['set']('Host',p['hostname']),r['headers']['set']('X-Forwarded-For',a['headers']['get']('CF-Connecting-IP')||''),r['headers']['set']('X-Forwarded-Proto',q['protocol']['replace'](':',''));const s=await fetchWithTimeout(r,{},d['connectTimeoutMs']||0x1f40),t=new Headers(s['headers']);return t['delete']('Content-Security-Policy'),t['delete']('X-Frame-Options'),new Response(s['body'],{'status':s['status'],'statusText':s['statusText'],'headers':t});}catch(u){return console['error']('Reverse\x20proxy\x20error',u),new Response('Proxy\x20configuration\x20error\x20or\x20upstream\x20down.\x20Error:\x20'+u['message'],{'status':0x1f6});}return new Response('Not\x20found',{'status':0x194});}};async function handleAdminRequest(a,b,c){const d=new URL(a['url']),{pathname:f}=d,g={'Content-Type':'application/json'};if(!c['adminKey'])return new Response('Admin\x20panel\x20not\x20configured.\x20Set\x20ADMIN_KEY\x20environment\x20variable.',{'status':0x1f7});if(f['startsWith']('/admin/api/')){if(!await isAdmin(a,b))return new Response(JSON['stringify']({'error':'Forbidden'}),{'status':0x193,'headers':g});if(a['method']!=='GET'){const i=a['headers']['get']('Origin');if(!i||new URL(i)['hostname']!==d['hostname'])return new Response(JSON['stringify']({'error':'Invalid\x20Origin'}),{'status':0x193,'headers':g});}if(f==='/admin/api/users'&&a['method']==='GET')try{const {results:j}=await b['DB']['prepare']('SELECT\x20uuid,\x20created_at,\x20expiration_date,\x20expiration_time,\x20notes\x20FROM\x20users\x20ORDER\x20BY\x20created_at\x20DESC')['all']();return new Response(JSON['stringify'](j??[]),{'status':0xc8,'headers':g});}catch(k){return new Response(JSON['stringify']({'error':k['message']}),{'status':0x1f4,'headers':g});}if(f==='/admin/api/users'&&a['method']==='POST')try{const {uuid:l,exp_date:m,exp_time:n,notes:o}=await a['json']();if(!l||!m||!n||!/^\d{4}-\d{2}-\d{2}$/['test'](m)||!/^\d{2}:\d{2}:\d{2}$/['test'](n))throw new Error('Invalid\x20or\x20missing\x20fields.\x20Use\x20UUID,\x20YYYY-MM-DD,\x20and\x20HH:MM:SS.');return await b['DB']['prepare']('INSERT\x20INTO\x20users\x20(uuid,\x20expiration_date,\x20expiration_time,\x20notes)\x20VALUES\x20(?,\x20?,\x20?,\x20?)')['bind'](l,m,n,o||null)['run'](),await b['USER_KV']['put']('user:'+l,JSON['stringify']({'uuid':l,'created_at':nowISO(),'expiration_date':m,'expiration_time':n,'notes':o||null}),{'expirationTtl':0xe10}),new Response(JSON['stringify']({'success':!![],'uuid':l}),{'status':0xc9,'headers':g});}catch(p){if(p['message']&&p['message']['includes']('UNIQUE\x20constraint\x20failed'))return new Response(JSON['stringify']({'error':'A\x20user\x20with\x20this\x20UUID\x20already\x20exists.'}),{'status':0x199,'headers':g});return new Response(JSON['stringify']({'error':p['message']||String(p)}),{'status':0x190,'headers':g});}if(f==='/admin/api/users/bulk-delete'&&a['method']==='POST')try{const {uuids:q}=await a['json']();if(!Array['isArray'](q)||q['length']===0x0)throw new Error('Invalid\x20request\x20body:\x20Expected\x20an\x20array\x20of\x20UUIDs.');const r=b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?'),s=q['map'](t=>r['bind'](t));return await b['DB']['batch'](s),await Promise['all'](q['map'](t=>b['USER_KV']['delete']('user:'+t))),new Response(JSON['stringify']({'success':!![],'count':q['length']}),{'status':0xc8,'headers':g});}catch(t){return new Response(JSON['stringify']({'error':t['message']||String(t)}),{'status':0x190,'headers':g});}const h=f['match'](/^\/admin\/api\/users\/([a-f0-9-]+)$/i);if(h&&a['method']==='PUT'){const u=h[0x1];try{const {exp_date:v,exp_time:w,notes:x}=await a['json']();if(!v||!w||!/^\d{4}-\d{2}-\d{2}$/['test'](v)||!/^\d{2}:\d{2}:\d{2}$/['test'](w))throw new Error('Invalid\x20date/time\x20fields.\x20Use\x20YYYY-MM-DD\x20and\x20HH:MM:SS.');return await b['DB']['prepare']('UPDATE\x20users\x20SET\x20expiration_date\x20=\x20?,\x20expiration_time\x20=\x20?,\x20notes\x20=\x20?\x20WHERE\x20uuid\x20=\x20?')['bind'](v,w,x||null,u)['run'](),await b['USER_KV']['put']('user:'+u,JSON['stringify']({'uuid':u,'expiration_date':v,'expiration_time':w,'notes':x||null}),{'expirationTtl':0xe10}),new Response(JSON['stringify']({'success':!![],'uuid':u}),{'status':0xc8,'headers':g});}catch(y){return new Response(JSON['stringify']({'error':y['message']||String(y)}),{'status':0x190,'headers':g});}}if(h&&a['method']==='DELETE'){const z=h[0x1];try{return await b['DB']['prepare']('DELETE\x20FROM\x20users\x20WHERE\x20uuid\x20=\x20?')['bind'](z)['run'](),await b['USER_KV']['delete']('user:'+z),new Response(JSON['stringify']({'success':!![],'uuid':z}),{'status':0xc8,'headers':g});}catch(A){return new Response(JSON['stringify']({'error':A['message']||String(A)}),{'status':0x1f4,'headers':g});}}return new Response(JSON['stringify']({'error':'API\x20route\x20not\x20found'}),{'status':0x194,'headers':g});}if(f==='/admin'){if(a['method']==='POST'){const B=await a['formData'](),C=B['get']('password');if(C===c['adminKey']){const D=generateUUID();return await b['USER_KV']['put']('admin_session_token',D,{'expirationTtl':0x15180}),new Response(null,{'status':0x12e,'headers':{'Location':'/admin','Set-Cookie':'auth_token='+D+';\x20HttpOnly;\x20Secure;\x20Path=/admin;\x20Max-Age=86400;\x20SameSite=Strict'}});}else return new Response(adminLoginHTML['replace']('</form>','</form><p\x20class=\x22error\x22>Invalid\x20password.</p>'),{'status':0x191,'headers':{'Content-Type':'text/html;charset=utf-8'}});}if(a['method']==='GET'){const E=await isAdmin(a,b);return new Response(E?adminPanelHTML:adminLoginHTML,{'headers':{'Content-Type':'text/html;charset=utf-8'}});}return new Response('Method\x20Not\x20Allowed',{'status':0x195});}return new Response('Not\x20found',{'status':0x194});}function socks5AddressParser(a){try{const [b,c]=a['includes']('@')?a['split']('@'):[null,a],[d,e]=c['split'](':'),f=parseInt(e,0xa);if(!d||isNaN(f))throw new Error();let g,h;if(b){[g,h]=b['split'](':');if(!g)throw new Error();}return{'username':g,'password':h,'hostname':d,'port':f};}catch{throw new Error('Invalid\x20SOCKS5\x20address\x20format.\x20Expected\x20[user:pass@]host:port');}}